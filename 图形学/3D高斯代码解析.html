<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>详解3D Gaussian Splatting CUDA Kernel：前向传播 | Yin的笔记本</title>
    <meta name="generator" content="VuePress 1.5.0">
    <link rel="icon" href="/favicon.ico">
    <link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css">
    <link rel="stylesheet" href="https://fastly.jsdelivr.net/github-markdown-css/2.2.1/github-markdown.css">
    <meta name="description" content="Yin的笔记本">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <link rel="preload" href="/assets/css/0.styles.2d94763a.css" as="style"><link rel="preload" href="/assets/js/app.1c89d7eb.js" as="script"><link rel="preload" href="/assets/js/3.63b8c0eb.js" as="script"><link rel="preload" href="/assets/js/1.be3d2055.js" as="script"><link rel="preload" href="/assets/js/165.4001e6a3.js" as="script"><link rel="prefetch" href="/assets/js/10.7997888a.js"><link rel="prefetch" href="/assets/js/100.2278e289.js"><link rel="prefetch" href="/assets/js/101.12c66a26.js"><link rel="prefetch" href="/assets/js/102.6468aee3.js"><link rel="prefetch" href="/assets/js/103.d1dd7048.js"><link rel="prefetch" href="/assets/js/104.f4890013.js"><link rel="prefetch" href="/assets/js/105.a97deef5.js"><link rel="prefetch" href="/assets/js/106.c1bcc835.js"><link rel="prefetch" href="/assets/js/107.03ab02e9.js"><link rel="prefetch" href="/assets/js/108.ce9a9508.js"><link rel="prefetch" href="/assets/js/109.d03fd13e.js"><link rel="prefetch" href="/assets/js/11.f5bd6d01.js"><link rel="prefetch" href="/assets/js/110.13c311a4.js"><link rel="prefetch" href="/assets/js/111.6f30518f.js"><link rel="prefetch" href="/assets/js/112.ca951fb9.js"><link rel="prefetch" href="/assets/js/113.9c5c0582.js"><link rel="prefetch" href="/assets/js/114.eb24eb1a.js"><link rel="prefetch" href="/assets/js/115.de265fa2.js"><link rel="prefetch" href="/assets/js/116.24745fa4.js"><link rel="prefetch" href="/assets/js/117.86d4e841.js"><link rel="prefetch" href="/assets/js/118.9dbd6211.js"><link rel="prefetch" href="/assets/js/119.d8ec6ee3.js"><link rel="prefetch" href="/assets/js/12.770bcdd1.js"><link rel="prefetch" href="/assets/js/120.21b9b7e4.js"><link rel="prefetch" href="/assets/js/121.69c915c7.js"><link rel="prefetch" href="/assets/js/122.ddedddba.js"><link rel="prefetch" href="/assets/js/123.5a80347b.js"><link rel="prefetch" href="/assets/js/124.71bff2da.js"><link rel="prefetch" href="/assets/js/125.21830b23.js"><link rel="prefetch" href="/assets/js/126.f30185cf.js"><link rel="prefetch" href="/assets/js/127.3aeb1f53.js"><link rel="prefetch" href="/assets/js/128.6c296bf9.js"><link rel="prefetch" href="/assets/js/129.fda4528b.js"><link rel="prefetch" href="/assets/js/13.070330f5.js"><link rel="prefetch" href="/assets/js/130.9e6b67b0.js"><link rel="prefetch" href="/assets/js/131.20b0e822.js"><link rel="prefetch" href="/assets/js/132.a35815d1.js"><link rel="prefetch" href="/assets/js/133.bfa0daa0.js"><link rel="prefetch" href="/assets/js/134.eaea7aba.js"><link rel="prefetch" href="/assets/js/135.3a5c98a8.js"><link rel="prefetch" href="/assets/js/136.01223e0d.js"><link rel="prefetch" href="/assets/js/137.7cce857f.js"><link rel="prefetch" href="/assets/js/138.7a586d88.js"><link rel="prefetch" href="/assets/js/139.3f8891f1.js"><link rel="prefetch" href="/assets/js/14.760d4ae9.js"><link rel="prefetch" href="/assets/js/140.7d36bb0c.js"><link rel="prefetch" href="/assets/js/141.b2a3eaa6.js"><link rel="prefetch" href="/assets/js/142.8765938e.js"><link rel="prefetch" href="/assets/js/143.877037ca.js"><link rel="prefetch" href="/assets/js/144.0c63859f.js"><link rel="prefetch" href="/assets/js/145.0826322f.js"><link rel="prefetch" href="/assets/js/146.0c7793ea.js"><link rel="prefetch" href="/assets/js/147.208c0c3d.js"><link rel="prefetch" href="/assets/js/148.e7e56ea0.js"><link rel="prefetch" href="/assets/js/149.269f672b.js"><link rel="prefetch" href="/assets/js/15.6dd745f8.js"><link rel="prefetch" href="/assets/js/150.5b335113.js"><link rel="prefetch" href="/assets/js/151.98e0c301.js"><link rel="prefetch" href="/assets/js/152.b8f48d96.js"><link rel="prefetch" href="/assets/js/153.bfeb3233.js"><link rel="prefetch" href="/assets/js/154.60508725.js"><link rel="prefetch" href="/assets/js/155.b8a1e762.js"><link rel="prefetch" href="/assets/js/156.a002dc45.js"><link rel="prefetch" href="/assets/js/157.5e547455.js"><link rel="prefetch" href="/assets/js/158.d2f2e77b.js"><link rel="prefetch" href="/assets/js/159.200ec9a4.js"><link rel="prefetch" href="/assets/js/16.6860f890.js"><link rel="prefetch" href="/assets/js/160.c842c71c.js"><link rel="prefetch" href="/assets/js/161.b69b41de.js"><link rel="prefetch" href="/assets/js/162.abaa0820.js"><link rel="prefetch" href="/assets/js/163.781d45a1.js"><link rel="prefetch" href="/assets/js/164.489c9172.js"><link rel="prefetch" href="/assets/js/166.f605c3b7.js"><link rel="prefetch" href="/assets/js/167.187f7fef.js"><link rel="prefetch" href="/assets/js/168.8e751948.js"><link rel="prefetch" href="/assets/js/169.5c50b84f.js"><link rel="prefetch" href="/assets/js/17.96a61fae.js"><link rel="prefetch" href="/assets/js/170.c145b06c.js"><link rel="prefetch" href="/assets/js/171.1ff621e6.js"><link rel="prefetch" href="/assets/js/172.b5012bca.js"><link rel="prefetch" href="/assets/js/173.5bfa26a7.js"><link rel="prefetch" href="/assets/js/174.09fa2f55.js"><link rel="prefetch" href="/assets/js/175.d9227914.js"><link rel="prefetch" href="/assets/js/176.00adae9b.js"><link rel="prefetch" href="/assets/js/177.919b9f47.js"><link rel="prefetch" href="/assets/js/178.7e815bb2.js"><link rel="prefetch" href="/assets/js/179.7abd2d00.js"><link rel="prefetch" href="/assets/js/18.e9d7c71b.js"><link rel="prefetch" href="/assets/js/180.655d5d4a.js"><link rel="prefetch" href="/assets/js/181.b46b1de0.js"><link rel="prefetch" href="/assets/js/182.2e8f1a2a.js"><link rel="prefetch" href="/assets/js/183.22265de0.js"><link rel="prefetch" href="/assets/js/184.74507e51.js"><link rel="prefetch" href="/assets/js/185.bfa1144d.js"><link rel="prefetch" href="/assets/js/186.823452a1.js"><link rel="prefetch" href="/assets/js/187.4d75455f.js"><link rel="prefetch" href="/assets/js/188.916ab9d4.js"><link rel="prefetch" href="/assets/js/189.add9f2bf.js"><link rel="prefetch" href="/assets/js/19.f46a344f.js"><link rel="prefetch" href="/assets/js/190.193af7ee.js"><link rel="prefetch" href="/assets/js/191.30e19787.js"><link rel="prefetch" href="/assets/js/192.485b0912.js"><link rel="prefetch" href="/assets/js/193.ec31135d.js"><link rel="prefetch" href="/assets/js/194.b6f1ea36.js"><link rel="prefetch" href="/assets/js/195.f41818b6.js"><link rel="prefetch" href="/assets/js/196.3997fb55.js"><link rel="prefetch" href="/assets/js/197.9316466e.js"><link rel="prefetch" href="/assets/js/198.d6eaf8d5.js"><link rel="prefetch" href="/assets/js/199.7833a5cf.js"><link rel="prefetch" href="/assets/js/20.3e59b7db.js"><link rel="prefetch" href="/assets/js/200.09ac4b4c.js"><link rel="prefetch" href="/assets/js/201.c181d266.js"><link rel="prefetch" href="/assets/js/202.0c17f434.js"><link rel="prefetch" href="/assets/js/203.f325f13a.js"><link rel="prefetch" href="/assets/js/204.cc6ab889.js"><link rel="prefetch" href="/assets/js/205.5dea103e.js"><link rel="prefetch" href="/assets/js/206.d4bed4f0.js"><link rel="prefetch" href="/assets/js/207.570e9c30.js"><link rel="prefetch" href="/assets/js/208.15c57dde.js"><link rel="prefetch" href="/assets/js/209.052fb626.js"><link rel="prefetch" href="/assets/js/21.0d860ace.js"><link rel="prefetch" href="/assets/js/210.17da69e7.js"><link rel="prefetch" href="/assets/js/211.0437b47a.js"><link rel="prefetch" href="/assets/js/212.6d3516a5.js"><link rel="prefetch" href="/assets/js/213.2016ed1e.js"><link rel="prefetch" href="/assets/js/214.8d375069.js"><link rel="prefetch" href="/assets/js/215.6895df63.js"><link rel="prefetch" href="/assets/js/216.c044b620.js"><link rel="prefetch" href="/assets/js/217.1ff7a370.js"><link rel="prefetch" href="/assets/js/218.2b5c6610.js"><link rel="prefetch" href="/assets/js/219.3d1b7c68.js"><link rel="prefetch" href="/assets/js/22.395f0662.js"><link rel="prefetch" href="/assets/js/220.2f7d0eb4.js"><link rel="prefetch" href="/assets/js/221.0d5c483a.js"><link rel="prefetch" href="/assets/js/222.b4e8edd9.js"><link rel="prefetch" href="/assets/js/223.ed8cd7c5.js"><link rel="prefetch" href="/assets/js/224.70f8536d.js"><link rel="prefetch" href="/assets/js/225.877f00f4.js"><link rel="prefetch" href="/assets/js/226.e6433587.js"><link rel="prefetch" href="/assets/js/227.57bea06d.js"><link rel="prefetch" href="/assets/js/228.46f056e8.js"><link rel="prefetch" href="/assets/js/229.e075c130.js"><link rel="prefetch" href="/assets/js/23.918096ae.js"><link rel="prefetch" href="/assets/js/230.513baab1.js"><link rel="prefetch" href="/assets/js/231.107ef86e.js"><link rel="prefetch" href="/assets/js/232.498787e8.js"><link rel="prefetch" href="/assets/js/233.c9c37e3d.js"><link rel="prefetch" href="/assets/js/234.3205c614.js"><link rel="prefetch" href="/assets/js/235.6e73d096.js"><link rel="prefetch" href="/assets/js/236.1cd1beda.js"><link rel="prefetch" href="/assets/js/237.4708c31e.js"><link rel="prefetch" href="/assets/js/238.8e5fe2c7.js"><link rel="prefetch" href="/assets/js/239.d6960886.js"><link rel="prefetch" href="/assets/js/24.191c578f.js"><link rel="prefetch" href="/assets/js/240.ac10844d.js"><link rel="prefetch" href="/assets/js/241.d176cd12.js"><link rel="prefetch" href="/assets/js/242.05602258.js"><link rel="prefetch" href="/assets/js/243.04d4eea2.js"><link rel="prefetch" href="/assets/js/244.666552a4.js"><link rel="prefetch" href="/assets/js/245.391a0ebb.js"><link rel="prefetch" href="/assets/js/246.bbc73f23.js"><link rel="prefetch" href="/assets/js/247.2fb1308f.js"><link rel="prefetch" href="/assets/js/248.cb32facb.js"><link rel="prefetch" href="/assets/js/249.8f2c20c3.js"><link rel="prefetch" href="/assets/js/25.9fa7a0f1.js"><link rel="prefetch" href="/assets/js/250.aee82d40.js"><link rel="prefetch" href="/assets/js/251.b27f9949.js"><link rel="prefetch" href="/assets/js/252.0d3a1c08.js"><link rel="prefetch" href="/assets/js/253.dbac77db.js"><link rel="prefetch" href="/assets/js/254.daeb0894.js"><link rel="prefetch" href="/assets/js/255.9ae341b8.js"><link rel="prefetch" href="/assets/js/256.0914df92.js"><link rel="prefetch" href="/assets/js/257.17692151.js"><link rel="prefetch" href="/assets/js/258.6a51affa.js"><link rel="prefetch" href="/assets/js/259.cfa1b7e2.js"><link rel="prefetch" href="/assets/js/26.977b91ed.js"><link rel="prefetch" href="/assets/js/260.01a0a834.js"><link rel="prefetch" href="/assets/js/261.7c6786a8.js"><link rel="prefetch" href="/assets/js/262.40aa6ec8.js"><link rel="prefetch" href="/assets/js/263.9b768341.js"><link rel="prefetch" href="/assets/js/264.3516b6ee.js"><link rel="prefetch" href="/assets/js/265.24ebac38.js"><link rel="prefetch" href="/assets/js/266.d0f18960.js"><link rel="prefetch" href="/assets/js/267.cb67bfa7.js"><link rel="prefetch" href="/assets/js/268.49a739ea.js"><link rel="prefetch" href="/assets/js/269.319f9495.js"><link rel="prefetch" href="/assets/js/27.cbf02bc2.js"><link rel="prefetch" href="/assets/js/270.0ab89f8c.js"><link rel="prefetch" href="/assets/js/271.5ebfdaad.js"><link rel="prefetch" href="/assets/js/272.d978c09e.js"><link rel="prefetch" href="/assets/js/273.c2ca9559.js"><link rel="prefetch" href="/assets/js/274.ef3c0b4e.js"><link rel="prefetch" href="/assets/js/275.0cb280a9.js"><link rel="prefetch" href="/assets/js/276.f01bb24d.js"><link rel="prefetch" href="/assets/js/277.4336236b.js"><link rel="prefetch" href="/assets/js/278.91b80a10.js"><link rel="prefetch" href="/assets/js/279.a3dba48a.js"><link rel="prefetch" href="/assets/js/28.ea6f85eb.js"><link rel="prefetch" href="/assets/js/280.28c7e56d.js"><link rel="prefetch" href="/assets/js/281.b40bcb2f.js"><link rel="prefetch" href="/assets/js/282.8b95f9c1.js"><link rel="prefetch" href="/assets/js/283.112bae13.js"><link rel="prefetch" href="/assets/js/284.32679d92.js"><link rel="prefetch" href="/assets/js/285.5d940ba6.js"><link rel="prefetch" href="/assets/js/286.7644400d.js"><link rel="prefetch" href="/assets/js/287.3e55ea4a.js"><link rel="prefetch" href="/assets/js/288.e008719f.js"><link rel="prefetch" href="/assets/js/289.288c8559.js"><link rel="prefetch" href="/assets/js/29.09e2943e.js"><link rel="prefetch" href="/assets/js/290.5e886e4a.js"><link rel="prefetch" href="/assets/js/291.317a7f21.js"><link rel="prefetch" href="/assets/js/292.8e9221de.js"><link rel="prefetch" href="/assets/js/293.d2e72c3b.js"><link rel="prefetch" href="/assets/js/294.b08bb0a5.js"><link rel="prefetch" href="/assets/js/295.0ff3e8b8.js"><link rel="prefetch" href="/assets/js/296.8db2437f.js"><link rel="prefetch" href="/assets/js/297.df969d5b.js"><link rel="prefetch" href="/assets/js/298.5e04335e.js"><link rel="prefetch" href="/assets/js/299.30af4295.js"><link rel="prefetch" href="/assets/js/30.8ce7bb1c.js"><link rel="prefetch" href="/assets/js/300.bbee17de.js"><link rel="prefetch" href="/assets/js/301.658e30a9.js"><link rel="prefetch" href="/assets/js/302.83a48594.js"><link rel="prefetch" href="/assets/js/303.25b5c5d0.js"><link rel="prefetch" href="/assets/js/304.d1cda2a7.js"><link rel="prefetch" href="/assets/js/305.ec45274c.js"><link rel="prefetch" href="/assets/js/306.f5481c32.js"><link rel="prefetch" href="/assets/js/307.477c6cfe.js"><link rel="prefetch" href="/assets/js/308.2fc60e29.js"><link rel="prefetch" href="/assets/js/309.d3153724.js"><link rel="prefetch" href="/assets/js/31.9a171aa4.js"><link rel="prefetch" href="/assets/js/310.cd447685.js"><link rel="prefetch" href="/assets/js/311.aa55b174.js"><link rel="prefetch" href="/assets/js/312.975cb9f5.js"><link rel="prefetch" href="/assets/js/313.ff1ed35d.js"><link rel="prefetch" href="/assets/js/314.0f909559.js"><link rel="prefetch" href="/assets/js/315.db32db01.js"><link rel="prefetch" href="/assets/js/32.947f503d.js"><link rel="prefetch" href="/assets/js/33.59e6f3ca.js"><link rel="prefetch" href="/assets/js/34.d611cc6b.js"><link rel="prefetch" href="/assets/js/35.1bcf17ab.js"><link rel="prefetch" href="/assets/js/36.4ce4f82a.js"><link rel="prefetch" href="/assets/js/37.0054f8c4.js"><link rel="prefetch" href="/assets/js/38.b4bdef00.js"><link rel="prefetch" href="/assets/js/39.436a4cf2.js"><link rel="prefetch" href="/assets/js/4.71970d79.js"><link rel="prefetch" href="/assets/js/40.3c0f9211.js"><link rel="prefetch" href="/assets/js/41.db84a37b.js"><link rel="prefetch" href="/assets/js/42.d490b527.js"><link rel="prefetch" href="/assets/js/43.53ff8034.js"><link rel="prefetch" href="/assets/js/44.6ac3003e.js"><link rel="prefetch" href="/assets/js/45.c5e657d2.js"><link rel="prefetch" href="/assets/js/46.9c37bbc9.js"><link rel="prefetch" href="/assets/js/47.8cc0235f.js"><link rel="prefetch" href="/assets/js/48.46917f1a.js"><link rel="prefetch" href="/assets/js/49.4956c196.js"><link rel="prefetch" href="/assets/js/5.b5c477bb.js"><link rel="prefetch" href="/assets/js/50.c350ef1e.js"><link rel="prefetch" href="/assets/js/51.228f9fb4.js"><link rel="prefetch" href="/assets/js/52.d0ea8325.js"><link rel="prefetch" href="/assets/js/53.bcf8531d.js"><link rel="prefetch" href="/assets/js/54.823cdd86.js"><link rel="prefetch" href="/assets/js/55.dd739e97.js"><link rel="prefetch" href="/assets/js/56.0a6fa41e.js"><link rel="prefetch" href="/assets/js/57.e8c7ac20.js"><link rel="prefetch" href="/assets/js/58.9a6ccc24.js"><link rel="prefetch" href="/assets/js/59.a3e64ba9.js"><link rel="prefetch" href="/assets/js/6.8d75c7c7.js"><link rel="prefetch" href="/assets/js/60.4ef57d04.js"><link rel="prefetch" href="/assets/js/61.b2221af0.js"><link rel="prefetch" href="/assets/js/62.d5e651a6.js"><link rel="prefetch" href="/assets/js/63.7cf7bbf5.js"><link rel="prefetch" href="/assets/js/64.a1b2ab5f.js"><link rel="prefetch" href="/assets/js/65.795f8ce1.js"><link rel="prefetch" href="/assets/js/66.766bae3c.js"><link rel="prefetch" href="/assets/js/67.33fffa58.js"><link rel="prefetch" href="/assets/js/68.34cad213.js"><link rel="prefetch" href="/assets/js/69.44ab1539.js"><link rel="prefetch" href="/assets/js/7.c826a528.js"><link rel="prefetch" href="/assets/js/70.0b157f44.js"><link rel="prefetch" href="/assets/js/71.dda3257f.js"><link rel="prefetch" href="/assets/js/72.e4fd59e4.js"><link rel="prefetch" href="/assets/js/73.5bfac475.js"><link rel="prefetch" href="/assets/js/74.106dce7c.js"><link rel="prefetch" href="/assets/js/75.febe432a.js"><link rel="prefetch" href="/assets/js/76.9d7b680c.js"><link rel="prefetch" href="/assets/js/77.53d02bdd.js"><link rel="prefetch" href="/assets/js/78.78f8bd3e.js"><link rel="prefetch" href="/assets/js/79.765020db.js"><link rel="prefetch" href="/assets/js/8.94c271b3.js"><link rel="prefetch" href="/assets/js/80.58708562.js"><link rel="prefetch" href="/assets/js/81.b496be82.js"><link rel="prefetch" href="/assets/js/82.e7fb031b.js"><link rel="prefetch" href="/assets/js/83.9a97b3c4.js"><link rel="prefetch" href="/assets/js/84.46388e53.js"><link rel="prefetch" href="/assets/js/85.273a246a.js"><link rel="prefetch" href="/assets/js/86.0f1a102d.js"><link rel="prefetch" href="/assets/js/87.0340887c.js"><link rel="prefetch" href="/assets/js/88.2464434e.js"><link rel="prefetch" href="/assets/js/89.9c7259c6.js"><link rel="prefetch" href="/assets/js/9.13823324.js"><link rel="prefetch" href="/assets/js/90.fc961b8c.js"><link rel="prefetch" href="/assets/js/91.05ce823e.js"><link rel="prefetch" href="/assets/js/92.6f598c32.js"><link rel="prefetch" href="/assets/js/93.9b4a4e9b.js"><link rel="prefetch" href="/assets/js/94.e181fada.js"><link rel="prefetch" href="/assets/js/95.1f019ce8.js"><link rel="prefetch" href="/assets/js/96.c5fdf710.js"><link rel="prefetch" href="/assets/js/97.64f5f96a.js"><link rel="prefetch" href="/assets/js/98.e761ab9f.js"><link rel="prefetch" href="/assets/js/99.b19b68c9.js">
    <link rel="stylesheet" href="/assets/css/0.styles.2d94763a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-42dd5e05><div data-v-42dd5e05><div id="loader-wrapper" class="loading-wrapper" data-v-d48f4d20 data-v-42dd5e05 data-v-42dd5e05><div class="loader-main" data-v-d48f4d20><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-95c9a4e8 data-v-42dd5e05 data-v-42dd5e05><h3 class="title" style="display:none;" data-v-95c9a4e8 data-v-95c9a4e8>Yin的笔记本</h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-95c9a4e8 data-v-95c9a4e8><input type="password" value="" data-v-95c9a4e8> <span data-v-95c9a4e8>Konck! Knock!</span> <button data-v-95c9a4e8>OK</button></label> <div class="footer" style="display:none;" data-v-95c9a4e8 data-v-95c9a4e8><span data-v-95c9a4e8><i class="iconfont reco-theme" data-v-95c9a4e8></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-95c9a4e8>vuePress-theme-reco</a></span> <span data-v-95c9a4e8><i class="iconfont reco-copyright" data-v-95c9a4e8></i> <a data-v-95c9a4e8><span data-v-95c9a4e8>Howard Yin</span>
            
          <span data-v-95c9a4e8>2021 - </span>
          2025
        </a></span></div></div> <div class="hide" data-v-42dd5e05><header class="navbar" data-v-42dd5e05><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" alt="Yin的笔记本" class="logo"> <span class="site-name">Yin的笔记本</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/CNCF/" class="nav-link"><i class="iconfont undefined"></i>
  CNCF
</a></li><li class="dropdown-item"><!----> <a href="/categories/Docker/" class="nav-link"><i class="iconfont undefined"></i>
  Docker
</a></li><li class="dropdown-item"><!----> <a href="/categories/namespaces/" class="nav-link"><i class="iconfont undefined"></i>
  namespaces
</a></li><li class="dropdown-item"><!----> <a href="/categories/Kubernetes/" class="nav-link"><i class="iconfont undefined"></i>
  Kubernetes
</a></li><li class="dropdown-item"><!----> <a href="/categories/Kubernetes对象/" class="nav-link"><i class="iconfont undefined"></i>
  Kubernetes对象
</a></li><li class="dropdown-item"><!----> <a href="/categories/Linux/" class="nav-link"><i class="iconfont undefined"></i>
  Linux
</a></li><li class="dropdown-item"><!----> <a href="/categories/MyIdeas/" class="nav-link"><i class="iconfont undefined"></i>
  MyIdeas
</a></li><li class="dropdown-item"><!----> <a href="/categories/Revolution/" class="nav-link"><i class="iconfont undefined"></i>
  Revolution
</a></li><li class="dropdown-item"><!----> <a href="/categories/WebRTC/" class="nav-link"><i class="iconfont undefined"></i>
  WebRTC
</a></li><li class="dropdown-item"><!----> <a href="/categories/云计算/" class="nav-link"><i class="iconfont undefined"></i>
  云计算
</a></li><li class="dropdown-item"><!----> <a href="/categories/人工智能/" class="nav-link"><i class="iconfont undefined"></i>
  人工智能
</a></li><li class="dropdown-item"><!----> <a href="/categories/分布式/" class="nav-link"><i class="iconfont undefined"></i>
  分布式
</a></li><li class="dropdown-item"><!----> <a href="/categories/图像处理/" class="nav-link"><i class="iconfont undefined"></i>
  图像处理
</a></li><li class="dropdown-item"><!----> <a href="/categories/图形学/" class="nav-link"><i class="iconfont undefined"></i>
  图形学
</a></li><li class="dropdown-item"><!----> <a href="/categories/微服务/" class="nav-link"><i class="iconfont undefined"></i>
  微服务
</a></li><li class="dropdown-item"><!----> <a href="/categories/数学/" class="nav-link"><i class="iconfont undefined"></i>
  数学
</a></li><li class="dropdown-item"><!----> <a href="/categories/OJ笔记/" class="nav-link"><i class="iconfont undefined"></i>
  OJ笔记
</a></li><li class="dropdown-item"><!----> <a href="/categories/博弈论/" class="nav-link"><i class="iconfont undefined"></i>
  博弈论
</a></li><li class="dropdown-item"><!----> <a href="/categories/形式语言与自动机/" class="nav-link"><i class="iconfont undefined"></i>
  形式语言与自动机
</a></li><li class="dropdown-item"><!----> <a href="/categories/数据库/" class="nav-link"><i class="iconfont undefined"></i>
  数据库
</a></li><li class="dropdown-item"><!----> <a href="/categories/服务器运维/" class="nav-link"><i class="iconfont undefined"></i>
  服务器运维
</a></li><li class="dropdown-item"><!----> <a href="/categories/编程语言/" class="nav-link"><i class="iconfont undefined"></i>
  编程语言
</a></li><li class="dropdown-item"><!----> <a href="/categories/C/" class="nav-link"><i class="iconfont undefined"></i>
  C
</a></li><li class="dropdown-item"><!----> <a href="/categories/Git/" class="nav-link"><i class="iconfont undefined"></i>
  Git
</a></li><li class="dropdown-item"><!----> <a href="/categories/Go/" class="nav-link"><i class="iconfont undefined"></i>
  Go
</a></li><li class="dropdown-item"><!----> <a href="/categories/Java/" class="nav-link"><i class="iconfont undefined"></i>
  Java
</a></li><li class="dropdown-item"><!----> <a href="/categories/JavaScript/" class="nav-link"><i class="iconfont undefined"></i>
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/categories/Python/" class="nav-link"><i class="iconfont undefined"></i>
  Python
</a></li><li class="dropdown-item"><!----> <a href="/categories/Nvidia/" class="nav-link"><i class="iconfont undefined"></i>
  Nvidia
</a></li><li class="dropdown-item"><!----> <a href="/categories/Shell/" class="nav-link"><i class="iconfont undefined"></i>
  Shell
</a></li><li class="dropdown-item"><!----> <a href="/categories/Tex/" class="nav-link"><i class="iconfont undefined"></i>
  Tex
</a></li><li class="dropdown-item"><!----> <a href="/categories/Rust/" class="nav-link"><i class="iconfont undefined"></i>
  Rust
</a></li><li class="dropdown-item"><!----> <a href="/categories/Vue/" class="nav-link"><i class="iconfont undefined"></i>
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/categories/视频编解码/" class="nav-link"><i class="iconfont undefined"></i>
  视频编解码
</a></li><li class="dropdown-item"><!----> <a href="/categories/计算机网络/" class="nav-link"><i class="iconfont undefined"></i>
  计算机网络
</a></li><li class="dropdown-item"><!----> <a href="/categories/SDN/" class="nav-link"><i class="iconfont undefined"></i>
  SDN
</a></li><li class="dropdown-item"><!----> <a href="/categories/论文笔记/" class="nav-link"><i class="iconfont undefined"></i>
  论文笔记
</a></li><li class="dropdown-item"><!----> <a href="/categories/讨论/" class="nav-link"><i class="iconfont undefined"></i>
  讨论
</a></li><li class="dropdown-item"><!----> <a href="/categories/边缘计算/" class="nav-link"><i class="iconfont undefined"></i>
  边缘计算
</a></li><li class="dropdown-item"><!----> <a href="/categories/量子信息技术/" class="nav-link"><i class="iconfont undefined"></i>
  量子信息技术
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><a href="http://profile.yindaheng98.top" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-account"></i>
  About
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/yindaheng98/Notebook/tree/master/学习笔记" target="_blank" rel="noopener noreferrer" class="repo-link"><i class="iconfont reco-查看源码"></i>
    查看源码
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask" data-v-42dd5e05></div> <aside class="sidebar" data-v-42dd5e05><div class="personal-info-wrapper" data-v-0ac41e2e><img src="/avatar.svg" alt="author-avatar" class="personal-img" data-v-0ac41e2e> <h3 class="name" data-v-0ac41e2e>
    Howard Yin
  </h3> <div class="num" data-v-0ac41e2e><div data-v-0ac41e2e><h3 data-v-0ac41e2e>304</h3> <h6 data-v-0ac41e2e>Article</h6></div> <div data-v-0ac41e2e><h3 data-v-0ac41e2e>153</h3> <h6 data-v-0ac41e2e>Tag</h6></div></div> <hr data-v-0ac41e2e></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/CNCF/" class="nav-link"><i class="iconfont undefined"></i>
  CNCF
</a></li><li class="dropdown-item"><!----> <a href="/categories/Docker/" class="nav-link"><i class="iconfont undefined"></i>
  Docker
</a></li><li class="dropdown-item"><!----> <a href="/categories/namespaces/" class="nav-link"><i class="iconfont undefined"></i>
  namespaces
</a></li><li class="dropdown-item"><!----> <a href="/categories/Kubernetes/" class="nav-link"><i class="iconfont undefined"></i>
  Kubernetes
</a></li><li class="dropdown-item"><!----> <a href="/categories/Kubernetes对象/" class="nav-link"><i class="iconfont undefined"></i>
  Kubernetes对象
</a></li><li class="dropdown-item"><!----> <a href="/categories/Linux/" class="nav-link"><i class="iconfont undefined"></i>
  Linux
</a></li><li class="dropdown-item"><!----> <a href="/categories/MyIdeas/" class="nav-link"><i class="iconfont undefined"></i>
  MyIdeas
</a></li><li class="dropdown-item"><!----> <a href="/categories/Revolution/" class="nav-link"><i class="iconfont undefined"></i>
  Revolution
</a></li><li class="dropdown-item"><!----> <a href="/categories/WebRTC/" class="nav-link"><i class="iconfont undefined"></i>
  WebRTC
</a></li><li class="dropdown-item"><!----> <a href="/categories/云计算/" class="nav-link"><i class="iconfont undefined"></i>
  云计算
</a></li><li class="dropdown-item"><!----> <a href="/categories/人工智能/" class="nav-link"><i class="iconfont undefined"></i>
  人工智能
</a></li><li class="dropdown-item"><!----> <a href="/categories/分布式/" class="nav-link"><i class="iconfont undefined"></i>
  分布式
</a></li><li class="dropdown-item"><!----> <a href="/categories/图像处理/" class="nav-link"><i class="iconfont undefined"></i>
  图像处理
</a></li><li class="dropdown-item"><!----> <a href="/categories/图形学/" class="nav-link"><i class="iconfont undefined"></i>
  图形学
</a></li><li class="dropdown-item"><!----> <a href="/categories/微服务/" class="nav-link"><i class="iconfont undefined"></i>
  微服务
</a></li><li class="dropdown-item"><!----> <a href="/categories/数学/" class="nav-link"><i class="iconfont undefined"></i>
  数学
</a></li><li class="dropdown-item"><!----> <a href="/categories/OJ笔记/" class="nav-link"><i class="iconfont undefined"></i>
  OJ笔记
</a></li><li class="dropdown-item"><!----> <a href="/categories/博弈论/" class="nav-link"><i class="iconfont undefined"></i>
  博弈论
</a></li><li class="dropdown-item"><!----> <a href="/categories/形式语言与自动机/" class="nav-link"><i class="iconfont undefined"></i>
  形式语言与自动机
</a></li><li class="dropdown-item"><!----> <a href="/categories/数据库/" class="nav-link"><i class="iconfont undefined"></i>
  数据库
</a></li><li class="dropdown-item"><!----> <a href="/categories/服务器运维/" class="nav-link"><i class="iconfont undefined"></i>
  服务器运维
</a></li><li class="dropdown-item"><!----> <a href="/categories/编程语言/" class="nav-link"><i class="iconfont undefined"></i>
  编程语言
</a></li><li class="dropdown-item"><!----> <a href="/categories/C/" class="nav-link"><i class="iconfont undefined"></i>
  C
</a></li><li class="dropdown-item"><!----> <a href="/categories/Git/" class="nav-link"><i class="iconfont undefined"></i>
  Git
</a></li><li class="dropdown-item"><!----> <a href="/categories/Go/" class="nav-link"><i class="iconfont undefined"></i>
  Go
</a></li><li class="dropdown-item"><!----> <a href="/categories/Java/" class="nav-link"><i class="iconfont undefined"></i>
  Java
</a></li><li class="dropdown-item"><!----> <a href="/categories/JavaScript/" class="nav-link"><i class="iconfont undefined"></i>
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/categories/Python/" class="nav-link"><i class="iconfont undefined"></i>
  Python
</a></li><li class="dropdown-item"><!----> <a href="/categories/Nvidia/" class="nav-link"><i class="iconfont undefined"></i>
  Nvidia
</a></li><li class="dropdown-item"><!----> <a href="/categories/Shell/" class="nav-link"><i class="iconfont undefined"></i>
  Shell
</a></li><li class="dropdown-item"><!----> <a href="/categories/Tex/" class="nav-link"><i class="iconfont undefined"></i>
  Tex
</a></li><li class="dropdown-item"><!----> <a href="/categories/Rust/" class="nav-link"><i class="iconfont undefined"></i>
  Rust
</a></li><li class="dropdown-item"><!----> <a href="/categories/Vue/" class="nav-link"><i class="iconfont undefined"></i>
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/categories/视频编解码/" class="nav-link"><i class="iconfont undefined"></i>
  视频编解码
</a></li><li class="dropdown-item"><!----> <a href="/categories/计算机网络/" class="nav-link"><i class="iconfont undefined"></i>
  计算机网络
</a></li><li class="dropdown-item"><!----> <a href="/categories/SDN/" class="nav-link"><i class="iconfont undefined"></i>
  SDN
</a></li><li class="dropdown-item"><!----> <a href="/categories/论文笔记/" class="nav-link"><i class="iconfont undefined"></i>
  论文笔记
</a></li><li class="dropdown-item"><!----> <a href="/categories/讨论/" class="nav-link"><i class="iconfont undefined"></i>
  讨论
</a></li><li class="dropdown-item"><!----> <a href="/categories/边缘计算/" class="nav-link"><i class="iconfont undefined"></i>
  边缘计算
</a></li><li class="dropdown-item"><!----> <a href="/categories/量子信息技术/" class="nav-link"><i class="iconfont undefined"></i>
  量子信息技术
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><a href="http://profile.yindaheng98.top" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-account"></i>
  About
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/yindaheng98/Notebook/tree/master/学习笔记" target="_blank" rel="noopener noreferrer" class="repo-link"><i class="iconfont reco-查看源码"></i>
    查看源码
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>详解3D Gaussian Splatting CUDA Kernel：前向传播</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/%E5%9B%BE%E5%BD%A2%E5%AD%A6/3D%E9%AB%98%E6%96%AF%E4%BB%A3%E7%A0%81%E8%A7%A3%E6%9E%90.html#foward函数-rasterizegaussianscuda" class="sidebar-link">foward函数: RasterizeGaussiansCUDA</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/%E5%9B%BE%E5%BD%A2%E5%AD%A6/3D%E9%AB%98%E6%96%AF%E4%BB%A3%E7%A0%81%E8%A7%A3%E6%9E%90.html#开头" class="sidebar-link">开头</a></li><li class="sidebar-sub-header"><a href="/%E5%9B%BE%E5%BD%A2%E5%AD%A6/3D%E9%AB%98%E6%96%AF%E4%BB%A3%E7%A0%81%E8%A7%A3%E6%9E%90.html#分配显存空间" class="sidebar-link">分配显存空间</a></li><li class="sidebar-sub-header"><a href="/%E5%9B%BE%E5%BD%A2%E5%AD%A6/3D%E9%AB%98%E6%96%AF%E4%BB%A3%E7%A0%81%E8%A7%A3%E6%9E%90.html#渲染过程的入口" class="sidebar-link">渲染过程的入口</a></li></ul></li><li><a href="/%E5%9B%BE%E5%BD%A2%E5%AD%A6/3D%E9%AB%98%E6%96%AF%E4%BB%A3%E7%A0%81%E8%A7%A3%E6%9E%90.html#深入cudarasterizer-rasterizer-forward（一）主要数据结构及初始化" class="sidebar-link">深入CudaRasterizer::Rasterizer::forward（一）主要数据结构及初始化</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/%E5%9B%BE%E5%BD%A2%E5%AD%A6/3D%E9%AB%98%E6%96%AF%E4%BB%A3%E7%A0%81%E8%A7%A3%E6%9E%90.html#深入cudarasterizer-rasterizer-forward（二）预处理过程forward-preprocess" class="sidebar-link">深入CudaRasterizer::Rasterizer::forward（二）预处理过程FORWARD::preprocess</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/%E5%9B%BE%E5%BD%A2%E5%AD%A6/3D%E9%AB%98%E6%96%AF%E4%BB%A3%E7%A0%81%E8%A7%A3%E6%9E%90.html#并行预处理函数preprocesscuda" class="sidebar-link">并行预处理函数preprocessCUDA</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/%E5%9B%BE%E5%BD%A2%E5%AD%A6/3D%E9%AB%98%E6%96%AF%E4%BB%A3%E7%A0%81%E8%A7%A3%E6%9E%90.html#preprocesscuda函数开头" class="sidebar-link">preprocessCUDA函数开头</a></li><li class="sidebar-sub-header"><a href="/%E5%9B%BE%E5%BD%A2%E5%AD%A6/3D%E9%AB%98%E6%96%AF%E4%BB%A3%E7%A0%81%E8%A7%A3%E6%9E%90.html#剔除近处的高斯球" class="sidebar-link">剔除近处的高斯球</a></li><li class="sidebar-sub-header"><a href="/%E5%9B%BE%E5%BD%A2%E5%AD%A6/3D%E9%AB%98%E6%96%AF%E4%BB%A3%E7%A0%81%E8%A7%A3%E6%9E%90.html#高斯球中心坐标转换到相机坐标系" class="sidebar-link">高斯球中心坐标转换到相机坐标系</a></li><li class="sidebar-sub-header"><a href="/%E5%9B%BE%E5%BD%A2%E5%AD%A6/3D%E9%AB%98%E6%96%AF%E4%BB%A3%E7%A0%81%E8%A7%A3%E6%9E%90.html#由高斯球参数计算3d协方差矩阵" class="sidebar-link">由高斯球参数计算3D协方差矩阵</a></li><li class="sidebar-sub-header"><a href="/%E5%9B%BE%E5%BD%A2%E5%AD%A6/3D%E9%AB%98%E6%96%AF%E4%BB%A3%E7%A0%81%E8%A7%A3%E6%9E%90.html#_3d协方差矩阵计算函数computecov3d" class="sidebar-link">3D协方差矩阵计算函数computeCov3D</a></li><li class="sidebar-sub-header"><a href="/%E5%9B%BE%E5%BD%A2%E5%AD%A6/3D%E9%AB%98%E6%96%AF%E4%BB%A3%E7%A0%81%E8%A7%A3%E6%9E%90.html#_3d协方差矩阵计算投影到成像平面上的2d协方差" class="sidebar-link">3D协方差矩阵计算投影到成像平面上的2D协方差</a></li><li class="sidebar-sub-header"><a href="/%E5%9B%BE%E5%BD%A2%E5%AD%A6/3D%E9%AB%98%E6%96%AF%E4%BB%A3%E7%A0%81%E8%A7%A3%E6%9E%90.html#_2d协方差矩阵计算函数computecov2d" class="sidebar-link">2D协方差矩阵计算函数computeCov2D</a></li><li class="sidebar-sub-header"><a href="/%E5%9B%BE%E5%BD%A2%E5%AD%A6/3D%E9%AB%98%E6%96%AF%E4%BB%A3%E7%A0%81%E8%A7%A3%E6%9E%90.html#_2d协方差矩阵求逆" class="sidebar-link">2D协方差矩阵求逆</a></li><li class="sidebar-sub-header"><a href="/%E5%9B%BE%E5%BD%A2%E5%AD%A6/3D%E9%AB%98%E6%96%AF%E4%BB%A3%E7%A0%81%E8%A7%A3%E6%9E%90.html#计算高斯球与成像平面上哪些tiles相交" class="sidebar-link">计算高斯球与成像平面上哪些tiles相交</a></li><li class="sidebar-sub-header"><a href="/%E5%9B%BE%E5%BD%A2%E5%AD%A6/3D%E9%AB%98%E6%96%AF%E4%BB%A3%E7%A0%81%E8%A7%A3%E6%9E%90.html#从球谐函数系数求投影点颜色" class="sidebar-link">从球谐函数系数求投影点颜色</a></li><li class="sidebar-sub-header"><a href="/%E5%9B%BE%E5%BD%A2%E5%AD%A6/3D%E9%AB%98%E6%96%AF%E4%BB%A3%E7%A0%81%E8%A7%A3%E6%9E%90.html#记录重要信息" class="sidebar-link">记录重要信息</a></li></ul></li><li><a href="/%E5%9B%BE%E5%BD%A2%E5%AD%A6/3D%E9%AB%98%E6%96%AF%E4%BB%A3%E7%A0%81%E8%A7%A3%E6%9E%90.html#深入cudarasterizer-rasterizer-forward（三）高斯球排序" class="sidebar-link">深入CudaRasterizer::Rasterizer::forward（三）高斯球排序</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/%E5%9B%BE%E5%BD%A2%E5%AD%A6/3D%E9%AB%98%E6%96%AF%E4%BB%A3%E7%A0%81%E8%A7%A3%E6%9E%90.html#构造排序用的keys" class="sidebar-link">构造排序用的Keys</a></li><li class="sidebar-sub-header"><a href="/%E5%9B%BE%E5%BD%A2%E5%AD%A6/3D%E9%AB%98%E6%96%AF%E4%BB%A3%E7%A0%81%E8%A7%A3%E6%9E%90.html#对高斯球进行基数排序" class="sidebar-link">对高斯球进行基数排序</a></li><li class="sidebar-sub-header"><a href="/%E5%9B%BE%E5%BD%A2%E5%AD%A6/3D%E9%AB%98%E6%96%AF%E4%BB%A3%E7%A0%81%E8%A7%A3%E6%9E%90.html#计算每个tile要渲染的部分在point-list-keys上的起点和终点" class="sidebar-link">计算每个tile要渲染的部分在point_list_keys上的起点和终点</a></li></ul></li><li><a href="/%E5%9B%BE%E5%BD%A2%E5%AD%A6/3D%E9%AB%98%E6%96%AF%E4%BB%A3%E7%A0%81%E8%A7%A3%E6%9E%90.html#深入cudarasterizer-rasterizer-forward（四）渲染过程forward-render" class="sidebar-link">深入CudaRasterizer::Rasterizer::forward（四）渲染过程FORWARD::render</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/%E5%9B%BE%E5%BD%A2%E5%AD%A6/3D%E9%AB%98%E6%96%AF%E4%BB%A3%E7%A0%81%E8%A7%A3%E6%9E%90.html#并行渲染函数rendercuda" class="sidebar-link">并行渲染函数renderCUDA</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/%E5%9B%BE%E5%BD%A2%E5%AD%A6/3D%E9%AB%98%E6%96%AF%E4%BB%A3%E7%A0%81%E8%A7%A3%E6%9E%90.html#获取当前tile对应的像素range和thread对应的像素坐标" class="sidebar-link">获取当前tile对应的像素range和thread对应的像素坐标</a></li><li class="sidebar-sub-header"><a href="/%E5%9B%BE%E5%BD%A2%E5%AD%A6/3D%E9%AB%98%E6%96%AF%E4%BB%A3%E7%A0%81%E8%A7%A3%E6%9E%90.html#获取当前tile对应的像素range" class="sidebar-link">获取当前tile对应的像素range</a></li><li class="sidebar-sub-header"><a href="/%E5%9B%BE%E5%BD%A2%E5%AD%A6/3D%E9%AB%98%E6%96%AF%E4%BB%A3%E7%A0%81%E8%A7%A3%E6%9E%90.html#渲染前的初始化" class="sidebar-link">渲染前的初始化</a></li><li class="sidebar-sub-header"><a href="/%E5%9B%BE%E5%BD%A2%E5%AD%A6/3D%E9%AB%98%E6%96%AF%E4%BB%A3%E7%A0%81%E8%A7%A3%E6%9E%90.html#for循环处理该像素的每个高斯球" class="sidebar-link">for循环处理该像素的每个高斯球</a></li></ul></li></ul></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-95c9a4e8 data-v-42dd5e05><h3 class="title" style="display:none;" data-v-95c9a4e8 data-v-95c9a4e8>详解3D Gaussian Splatting CUDA Kernel：前向传播</h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-95c9a4e8 data-v-95c9a4e8><input type="password" value="" data-v-95c9a4e8> <span data-v-95c9a4e8>Konck! Knock!</span> <button data-v-95c9a4e8>OK</button></label> <div class="footer" style="display:none;" data-v-95c9a4e8 data-v-95c9a4e8><span data-v-95c9a4e8><i class="iconfont reco-theme" data-v-95c9a4e8></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-95c9a4e8>vuePress-theme-reco</a></span> <span data-v-95c9a4e8><i class="iconfont reco-copyright" data-v-95c9a4e8></i> <a data-v-95c9a4e8><span data-v-95c9a4e8>Howard Yin</span>
            
          <span data-v-95c9a4e8>2021 - </span>
          2025
        </a></span></div></div> <div data-v-42dd5e05><main class="page"><div class="page-title" style="display:none;"><h1>详解3D Gaussian Splatting CUDA Kernel：前向传播</h1> <hr> <div data-v-3d9cec6e><i class="iconfont reco-account" data-v-3d9cec6e><span data-v-3d9cec6e>Howard Yin</span></i> <i class="iconfont reco-date" data-v-3d9cec6e><span data-v-3d9cec6e>2024-11-24 18:43:00</span></i> <!----> <i class="iconfont reco-tag tags" data-v-3d9cec6e><span class="tag-item" data-v-3d9cec6e>图形学</span><span class="tag-item" data-v-3d9cec6e>3D Gaussian Splatting</span></i></div></div> <div class="theme-reco-content content__default" style="display:none;"><p><img src="zhimg.com/v2-7cbe3b0c3b67ce80593fad0d73a814b5_r.jpg" alt=""></p> <p>PyBind绑定了3个函数，核心函数就两个：<code>rasterize_gaussians</code>和<code>rasterize_gaussians_backward</code></p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token function">PYBIND11_MODULE</span><span class="token punctuation">(</span>TORCH_EXTENSION_NAME<span class="token punctuation">,</span> m<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  m<span class="token punctuation">.</span><span class="token function">def</span><span class="token punctuation">(</span><span class="token string">&quot;rasterize_gaussians&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>RasterizeGaussiansCUDA<span class="token punctuation">)</span><span class="token punctuation">;</span>
  m<span class="token punctuation">.</span><span class="token function">def</span><span class="token punctuation">(</span><span class="token string">&quot;rasterize_gaussians_backward&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>RasterizeGaussiansBackwardCUDA<span class="token punctuation">)</span><span class="token punctuation">;</span>
  m<span class="token punctuation">.</span><span class="token function">def</span><span class="token punctuation">(</span><span class="token string">&quot;mark_visible&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>markVisible<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="foward函数-rasterizegaussianscuda"><a href="#foward函数-rasterizegaussianscuda" class="header-anchor">#</a> foward函数: <code>RasterizeGaussiansCUDA</code></h2> <h3 id="开头"><a href="#开头" class="header-anchor">#</a> 开头</h3> <p>最外层的渲染函数，输入输出差不多都是<code>torch::Tensor</code>，和Python里的输入输出直接对应：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>std<span class="token operator">::</span>tuple<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> torch<span class="token operator">::</span>Tensor<span class="token punctuation">,</span> torch<span class="token operator">::</span>Tensor<span class="token punctuation">,</span> torch<span class="token operator">::</span>Tensor<span class="token punctuation">,</span> torch<span class="token operator">::</span>Tensor<span class="token punctuation">,</span> torch<span class="token operator">::</span>Tensor<span class="token operator">&gt;</span>
<span class="token function">RasterizeGaussiansCUDA</span><span class="token punctuation">(</span>
	<span class="token keyword">const</span> torch<span class="token operator">::</span>Tensor<span class="token operator">&amp;</span> background<span class="token punctuation">,</span>
	<span class="token keyword">const</span> torch<span class="token operator">::</span>Tensor<span class="token operator">&amp;</span> means3D<span class="token punctuation">,</span>
    <span class="token keyword">const</span> torch<span class="token operator">::</span>Tensor<span class="token operator">&amp;</span> colors<span class="token punctuation">,</span>
    <span class="token keyword">const</span> torch<span class="token operator">::</span>Tensor<span class="token operator">&amp;</span> opacity<span class="token punctuation">,</span>
	<span class="token keyword">const</span> torch<span class="token operator">::</span>Tensor<span class="token operator">&amp;</span> scales<span class="token punctuation">,</span>
	<span class="token keyword">const</span> torch<span class="token operator">::</span>Tensor<span class="token operator">&amp;</span> rotations<span class="token punctuation">,</span>
	<span class="token keyword">const</span> <span class="token keyword">float</span> scale_modifier<span class="token punctuation">,</span>
	<span class="token keyword">const</span> torch<span class="token operator">::</span>Tensor<span class="token operator">&amp;</span> cov3D_precomp<span class="token punctuation">,</span>
	<span class="token keyword">const</span> torch<span class="token operator">::</span>Tensor<span class="token operator">&amp;</span> viewmatrix<span class="token punctuation">,</span>
	<span class="token keyword">const</span> torch<span class="token operator">::</span>Tensor<span class="token operator">&amp;</span> projmatrix<span class="token punctuation">,</span>
	<span class="token keyword">const</span> <span class="token keyword">float</span> tan_fovx<span class="token punctuation">,</span> 
	<span class="token keyword">const</span> <span class="token keyword">float</span> tan_fovy<span class="token punctuation">,</span>
    <span class="token keyword">const</span> <span class="token keyword">int</span> image_height<span class="token punctuation">,</span>
    <span class="token keyword">const</span> <span class="token keyword">int</span> image_width<span class="token punctuation">,</span>
	<span class="token keyword">const</span> torch<span class="token operator">::</span>Tensor<span class="token operator">&amp;</span> sh<span class="token punctuation">,</span>
	<span class="token keyword">const</span> <span class="token keyword">int</span> degree<span class="token punctuation">,</span>
	<span class="token keyword">const</span> torch<span class="token operator">::</span>Tensor<span class="token operator">&amp;</span> campos<span class="token punctuation">,</span>
	<span class="token keyword">const</span> <span class="token keyword">bool</span> prefiltered<span class="token punctuation">,</span>
	<span class="token keyword">const</span> <span class="token keyword">bool</span> debug<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>means3D<span class="token punctuation">.</span><span class="token function">ndimension</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">2</span> <span class="token operator">||</span> means3D<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">AT_ERROR</span><span class="token punctuation">(</span><span class="token string">&quot;means3D must have dimensions (num_points, 3)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">const</span> <span class="token keyword">int</span> P <span class="token operator">=</span> means3D<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//高斯点数量</span>
  <span class="token keyword">const</span> <span class="token keyword">int</span> H <span class="token operator">=</span> image_height<span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token keyword">int</span> W <span class="token operator">=</span> image_width<span class="token punctuation">;</span>

  <span class="token keyword">auto</span> int_opts <span class="token operator">=</span> means3D<span class="token punctuation">.</span><span class="token function">options</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">dtype</span><span class="token punctuation">(</span>torch<span class="token operator">::</span>kInt32<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">auto</span> float_opts <span class="token operator">=</span> means3D<span class="token punctuation">.</span><span class="token function">options</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">dtype</span><span class="token punctuation">(</span>torch<span class="token operator">::</span>kFloat32<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><h3 id="分配显存空间"><a href="#分配显存空间" class="header-anchor">#</a> 分配显存空间</h3> <p>给<code>out_color</code>和<code>radii</code>分配显存空间，初始化<code>geomBuffer</code>、<code>binningBuffer</code>、<code>imgBuffer</code>：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>  torch<span class="token operator">::</span>Tensor out_color <span class="token operator">=</span> torch<span class="token operator">::</span><span class="token function">full</span><span class="token punctuation">(</span><span class="token punctuation">{</span>NUM_CHANNELS<span class="token punctuation">,</span> H<span class="token punctuation">,</span> W<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> float_opts<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//分配显存空间用于存储渲染图</span>
  torch<span class="token operator">::</span>Tensor radii <span class="token operator">=</span> torch<span class="token operator">::</span><span class="token function">full</span><span class="token punctuation">(</span><span class="token punctuation">{</span>P<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> means3D<span class="token punctuation">.</span><span class="token function">options</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">dtype</span><span class="token punctuation">(</span>torch<span class="token operator">::</span>kInt32<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//分配显存空间用于存储每个高斯球在渲染图中的半径</span>
  
  torch<span class="token operator">::</span>Device <span class="token function">device</span><span class="token punctuation">(</span>torch<span class="token operator">::</span>kCUDA<span class="token punctuation">)</span><span class="token punctuation">;</span>
  torch<span class="token operator">::</span>TensorOptions <span class="token function">options</span><span class="token punctuation">(</span>torch<span class="token operator">::</span>kByte<span class="token punctuation">)</span><span class="token punctuation">;</span>
  torch<span class="token operator">::</span>Tensor geomBuffer <span class="token operator">=</span> torch<span class="token operator">::</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span><span class="token function">device</span><span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//初始化, 还未分配显存空间</span>
  torch<span class="token operator">::</span>Tensor binningBuffer <span class="token operator">=</span> torch<span class="token operator">::</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span><span class="token function">device</span><span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//初始化, 还未分配显存空间</span>
  torch<span class="token operator">::</span>Tensor imgBuffer <span class="token operator">=</span> torch<span class="token operator">::</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span><span class="token function">device</span><span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//初始化, 还未分配显存空间</span>
  std<span class="token operator">::</span>function<span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">(</span>size_t<span class="token punctuation">)</span><span class="token operator">&gt;</span> geomFunc <span class="token operator">=</span> <span class="token function">resizeFunctional</span><span class="token punctuation">(</span>geomBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  std<span class="token operator">::</span>function<span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">(</span>size_t<span class="token punctuation">)</span><span class="token operator">&gt;</span> binningFunc <span class="token operator">=</span> <span class="token function">resizeFunctional</span><span class="token punctuation">(</span>binningBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  std<span class="token operator">::</span>function<span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">(</span>size_t<span class="token punctuation">)</span><span class="token operator">&gt;</span> imgFunc <span class="token operator">=</span> <span class="token function">resizeFunctional</span><span class="token punctuation">(</span>imgBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>这里的<code>resizeFunctional</code>是一个闭包，输出一个调显存空间大小lambda表达式，给后面代码里面分配显存用：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>std<span class="token operator">::</span>function<span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">(</span>size_t N<span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token function">resizeFunctional</span><span class="token punctuation">(</span>torch<span class="token operator">::</span>Tensor<span class="token operator">&amp;</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">auto</span> lambda <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">&amp;</span>t<span class="token punctuation">]</span><span class="token punctuation">(</span>size_t N<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        t<span class="token punctuation">.</span><span class="token function">resize_</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">long</span><span class="token punctuation">)</span>N<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">contiguous</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">data_ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> lambda<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>这里的<code>out_color</code>和<code>radii</code>好理解，分别是渲染结果和高斯球在渲染图中的半径，但<code>geomBuffer</code>、<code>binningBuffer</code>、<code>imgBuffer</code>是存的什么？且看后文。</p> <h3 id="渲染过程的入口"><a href="#渲染过程的入口" class="header-anchor">#</a> 渲染过程的入口</h3> <p>调用<code>CudaRasterizer::Rasterizer::forward</code>执行渲染，结果构造为Python里的tuple：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>  <span class="token keyword">int</span> rendered <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>P <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
	  <span class="token keyword">int</span> M <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	  <span class="token keyword">if</span><span class="token punctuation">(</span>sh<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
	  <span class="token punctuation">{</span>
		M <span class="token operator">=</span> sh<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

	  rendered <span class="token operator">=</span> CudaRasterizer<span class="token operator">::</span>Rasterizer<span class="token operator">::</span><span class="token function">forward</span><span class="token punctuation">(</span>
	    geomFunc<span class="token punctuation">,</span>
		binningFunc<span class="token punctuation">,</span>
		imgFunc<span class="token punctuation">,</span>
	    P<span class="token punctuation">,</span> degree<span class="token punctuation">,</span> M<span class="token punctuation">,</span>
		background<span class="token punctuation">.</span><span class="token function">contiguous</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>data<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		W<span class="token punctuation">,</span> H<span class="token punctuation">,</span>
		means3D<span class="token punctuation">.</span><span class="token function">contiguous</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>data<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		sh<span class="token punctuation">.</span><span class="token function">contiguous</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>data_ptr<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		colors<span class="token punctuation">.</span><span class="token function">contiguous</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>data<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
		opacity<span class="token punctuation">.</span><span class="token function">contiguous</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>data<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
		scales<span class="token punctuation">.</span><span class="token function">contiguous</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>data_ptr<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		scale_modifier<span class="token punctuation">,</span>
		rotations<span class="token punctuation">.</span><span class="token function">contiguous</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>data_ptr<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		cov3D_precomp<span class="token punctuation">.</span><span class="token function">contiguous</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>data<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
		viewmatrix<span class="token punctuation">.</span><span class="token function">contiguous</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>data<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
		projmatrix<span class="token punctuation">.</span><span class="token function">contiguous</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>data<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		campos<span class="token punctuation">.</span><span class="token function">contiguous</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>data<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		tan_fovx<span class="token punctuation">,</span>
		tan_fovy<span class="token punctuation">,</span>
		prefiltered<span class="token punctuation">,</span>
		out_color<span class="token punctuation">.</span><span class="token function">contiguous</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>data<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		radii<span class="token punctuation">.</span><span class="token function">contiguous</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>data<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		debug<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> std<span class="token operator">::</span><span class="token function">make_tuple</span><span class="token punctuation">(</span>rendered<span class="token punctuation">,</span> out_color<span class="token punctuation">,</span> radii<span class="token punctuation">,</span> geomBuffer<span class="token punctuation">,</span> binningBuffer<span class="token punctuation">,</span> imgBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><h2 id="深入cudarasterizer-rasterizer-forward（一）主要数据结构及初始化"><a href="#深入cudarasterizer-rasterizer-forward（一）主要数据结构及初始化" class="header-anchor">#</a> 深入<code>CudaRasterizer::Rasterizer::forward</code>（一）主要数据结构及初始化</h2> <p>真 · 渲染过程的入口：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">// Forward rendering procedure for differentiable rasterization</span>
<span class="token comment">// of Gaussians.</span>
<span class="token keyword">int</span> CudaRasterizer<span class="token operator">::</span>Rasterizer<span class="token operator">::</span><span class="token function">forward</span><span class="token punctuation">(</span>
	std<span class="token operator">::</span>function<span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">*</span> <span class="token punctuation">(</span>size_t<span class="token punctuation">)</span><span class="token operator">&gt;</span> geometryBuffer<span class="token punctuation">,</span>
	std<span class="token operator">::</span>function<span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">*</span> <span class="token punctuation">(</span>size_t<span class="token punctuation">)</span><span class="token operator">&gt;</span> binningBuffer<span class="token punctuation">,</span>
	std<span class="token operator">::</span>function<span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">*</span> <span class="token punctuation">(</span>size_t<span class="token punctuation">)</span><span class="token operator">&gt;</span> imageBuffer<span class="token punctuation">,</span>
	<span class="token keyword">const</span> <span class="token keyword">int</span> P<span class="token punctuation">,</span> <span class="token keyword">int</span> D<span class="token punctuation">,</span> <span class="token keyword">int</span> M<span class="token punctuation">,</span>
	<span class="token keyword">const</span> <span class="token keyword">float</span><span class="token operator">*</span> background<span class="token punctuation">,</span>
	<span class="token keyword">const</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">,</span>
	<span class="token keyword">const</span> <span class="token keyword">float</span><span class="token operator">*</span> means3D<span class="token punctuation">,</span>
	<span class="token keyword">const</span> <span class="token keyword">float</span><span class="token operator">*</span> shs<span class="token punctuation">,</span>
	<span class="token keyword">const</span> <span class="token keyword">float</span><span class="token operator">*</span> colors_precomp<span class="token punctuation">,</span>
	<span class="token keyword">const</span> <span class="token keyword">float</span><span class="token operator">*</span> opacities<span class="token punctuation">,</span>
	<span class="token keyword">const</span> <span class="token keyword">float</span><span class="token operator">*</span> scales<span class="token punctuation">,</span>
	<span class="token keyword">const</span> <span class="token keyword">float</span> scale_modifier<span class="token punctuation">,</span>
	<span class="token keyword">const</span> <span class="token keyword">float</span><span class="token operator">*</span> rotations<span class="token punctuation">,</span>
	<span class="token keyword">const</span> <span class="token keyword">float</span><span class="token operator">*</span> cov3D_precomp<span class="token punctuation">,</span>
	<span class="token keyword">const</span> <span class="token keyword">float</span><span class="token operator">*</span> viewmatrix<span class="token punctuation">,</span>
	<span class="token keyword">const</span> <span class="token keyword">float</span><span class="token operator">*</span> projmatrix<span class="token punctuation">,</span>
	<span class="token keyword">const</span> <span class="token keyword">float</span><span class="token operator">*</span> cam_pos<span class="token punctuation">,</span>
	<span class="token keyword">const</span> <span class="token keyword">float</span> tan_fovx<span class="token punctuation">,</span> <span class="token keyword">float</span> tan_fovy<span class="token punctuation">,</span>
	<span class="token keyword">const</span> <span class="token keyword">bool</span> prefiltered<span class="token punctuation">,</span>
	<span class="token keyword">float</span><span class="token operator">*</span> out_color<span class="token punctuation">,</span>
	<span class="token keyword">int</span><span class="token operator">*</span> radii<span class="token punctuation">,</span>
	<span class="token keyword">bool</span> debug<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>预处理前的初始化：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>	<span class="token keyword">const</span> <span class="token keyword">float</span> focal_y <span class="token operator">=</span> height <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">2.0f</span> <span class="token operator">*</span> tan_fovy<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//计算焦距fx,fy</span>
	<span class="token keyword">const</span> <span class="token keyword">float</span> focal_x <span class="token operator">=</span> width <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">2.0f</span> <span class="token operator">*</span> tan_fovx<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//计算焦距fx,fy</span>

	size_t chunk_size <span class="token operator">=</span> required<span class="token operator">&lt;</span>GeometryState<span class="token operator">&gt;</span><span class="token punctuation">(</span>P<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//计算所需的显存大小</span>
	<span class="token keyword">char</span><span class="token operator">*</span> chunkptr <span class="token operator">=</span> <span class="token function">geometryBuffer</span><span class="token punctuation">(</span>chunk_size<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//分配显存块，并返回首地址</span>
	GeometryState geomState <span class="token operator">=</span> GeometryState<span class="token operator">::</span><span class="token function">fromChunk</span><span class="token punctuation">(</span>chunkptr<span class="token punctuation">,</span> P<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//将分配的显存块初始化为GeometryState</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>radii <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		radii <span class="token operator">=</span> geomState<span class="token punctuation">.</span>internal_radii<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	dim3 <span class="token function">tile_grid</span><span class="token punctuation">(</span><span class="token punctuation">(</span>width <span class="token operator">+</span> BLOCK_X <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> BLOCK_X<span class="token punctuation">,</span> <span class="token punctuation">(</span>height <span class="token operator">+</span> BLOCK_Y <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> BLOCK_Y<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//图像划分为16x16的tiles，xy方向上各有多少tiles</span>
	dim3 <span class="token function">block</span><span class="token punctuation">(</span>BLOCK_X<span class="token punctuation">,</span> BLOCK_Y<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//块中线程数量，16*16</span>

	<span class="token comment">// Dynamically resize image-based auxiliary buffers during training</span>
	size_t img_chunk_size <span class="token operator">=</span> required<span class="token operator">&lt;</span>ImageState<span class="token operator">&gt;</span><span class="token punctuation">(</span>width <span class="token operator">*</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//计算所需的显存大小</span>
	<span class="token keyword">char</span><span class="token operator">*</span> img_chunkptr <span class="token operator">=</span> <span class="token function">imageBuffer</span><span class="token punctuation">(</span>img_chunk_size<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//分配显存块，返回首地址</span>
	ImageState imgState <span class="token operator">=</span> ImageState<span class="token operator">::</span><span class="token function">fromChunk</span><span class="token punctuation">(</span>img_chunkptr<span class="token punctuation">,</span> width <span class="token operator">*</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//将分配的显存块初始化为ImageState</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>NUM_CHANNELS <span class="token operator">!=</span> <span class="token number">3</span> <span class="token operator">&amp;&amp;</span> colors_precomp <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token keyword">throw</span> std<span class="token operator">::</span><span class="token function">runtime_error</span><span class="token punctuation">(</span><span class="token string">&quot;For non-RGB, provide precomputed Gaussian colors!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p><code>GeometryState</code>和<code>ImageState</code>的定义在<code>rasterizer_impl.h</code>，里面就是一大堆数组，用来存储渲染中的各种数据，后面可以看到每个数组的用法：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>	<span class="token keyword">struct</span> <span class="token class-name">GeometryState</span>
	<span class="token punctuation">{</span>
		size_t scan_size<span class="token punctuation">;</span>
		<span class="token keyword">float</span><span class="token operator">*</span> depths<span class="token punctuation">;</span>
		<span class="token keyword">char</span><span class="token operator">*</span> scanning_space<span class="token punctuation">;</span>
		<span class="token keyword">bool</span><span class="token operator">*</span> clamped<span class="token punctuation">;</span>
		<span class="token keyword">int</span><span class="token operator">*</span> internal_radii<span class="token punctuation">;</span>
		float2<span class="token operator">*</span> means2D<span class="token punctuation">;</span>
		<span class="token keyword">float</span><span class="token operator">*</span> cov3D<span class="token punctuation">;</span>
		float4<span class="token operator">*</span> conic_opacity<span class="token punctuation">;</span>
		<span class="token keyword">float</span><span class="token operator">*</span> rgb<span class="token punctuation">;</span>
		<span class="token keyword">uint32_t</span><span class="token operator">*</span> point_offsets<span class="token punctuation">;</span>
		<span class="token keyword">uint32_t</span><span class="token operator">*</span> tiles_touched<span class="token punctuation">;</span>

		<span class="token keyword">static</span> GeometryState <span class="token function">fromChunk</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">&amp;</span> chunk<span class="token punctuation">,</span> size_t P<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>

	<span class="token keyword">struct</span> <span class="token class-name">ImageState</span>
	<span class="token punctuation">{</span>
		uint2<span class="token operator">*</span> ranges<span class="token punctuation">;</span>
		<span class="token keyword">uint32_t</span><span class="token operator">*</span> n_contrib<span class="token punctuation">;</span>
		<span class="token keyword">float</span><span class="token operator">*</span> accum_alpha<span class="token punctuation">;</span>

		<span class="token keyword">static</span> ImageState <span class="token function">fromChunk</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">&amp;</span> chunk<span class="token punctuation">,</span> size_t N<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>这里的<code>required</code>是在调用<code>GeometryState</code>或<code>ImageState</code>里面的<code>fromChunk</code>：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>	<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> T<span class="token operator">&gt;</span> 
	size_t <span class="token function">required</span><span class="token punctuation">(</span>size_t P<span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token keyword">char</span><span class="token operator">*</span> size <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
		T<span class="token operator">::</span><span class="token function">fromChunk</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> P<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>size_t<span class="token punctuation">)</span>size<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">128</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><code>GeometryState</code>的<code>fromChunk</code>实现为：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>CudaRasterizer<span class="token operator">::</span>GeometryState CudaRasterizer<span class="token operator">::</span>GeometryState<span class="token operator">::</span><span class="token function">fromChunk</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">&amp;</span> chunk<span class="token punctuation">,</span> size_t P<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	GeometryState geom<span class="token punctuation">;</span>
	<span class="token function">obtain</span><span class="token punctuation">(</span>chunk<span class="token punctuation">,</span> geom<span class="token punctuation">.</span>depths<span class="token punctuation">,</span> P<span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">obtain</span><span class="token punctuation">(</span>chunk<span class="token punctuation">,</span> geom<span class="token punctuation">.</span>clamped<span class="token punctuation">,</span> P <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">obtain</span><span class="token punctuation">(</span>chunk<span class="token punctuation">,</span> geom<span class="token punctuation">.</span>internal_radii<span class="token punctuation">,</span> P<span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">obtain</span><span class="token punctuation">(</span>chunk<span class="token punctuation">,</span> geom<span class="token punctuation">.</span>means2D<span class="token punctuation">,</span> P<span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">obtain</span><span class="token punctuation">(</span>chunk<span class="token punctuation">,</span> geom<span class="token punctuation">.</span>cov3D<span class="token punctuation">,</span> P <span class="token operator">*</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">obtain</span><span class="token punctuation">(</span>chunk<span class="token punctuation">,</span> geom<span class="token punctuation">.</span>conic_opacity<span class="token punctuation">,</span> P<span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">obtain</span><span class="token punctuation">(</span>chunk<span class="token punctuation">,</span> geom<span class="token punctuation">.</span>rgb<span class="token punctuation">,</span> P <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">obtain</span><span class="token punctuation">(</span>chunk<span class="token punctuation">,</span> geom<span class="token punctuation">.</span>tiles_touched<span class="token punctuation">,</span> P<span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//参数：第三个in，第四个out，最后一个num。当第一个参数为NULL时, 所需的分配大小被写入第二个参数，并且不执行任何工作 https://github.com/dmlc/cub/blob/master/cub/device/device_scan.cuh</span>
	cub<span class="token operator">::</span>DeviceScan<span class="token operator">::</span><span class="token function">InclusiveSum</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">,</span> geom<span class="token punctuation">.</span>scan_size<span class="token punctuation">,</span> geom<span class="token punctuation">.</span>tiles_touched<span class="token punctuation">,</span> geom<span class="token punctuation">.</span>tiles_touched<span class="token punctuation">,</span> P<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//算出计算数组前缀和所需的内存空间大小，InclusiveSum表示包括自身，ExclusiveSum表示不包括自身</span>
	<span class="token function">obtain</span><span class="token punctuation">(</span>chunk<span class="token punctuation">,</span> geom<span class="token punctuation">.</span>scanning_space<span class="token punctuation">,</span> geom<span class="token punctuation">.</span>scan_size<span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//按照算出的内存空间大小，给geom.scanning_space分配空间。看来后面会有计算数组前缀和的操作，这个geom.scanning_space就是在计算数组前缀和时用来存放中间结果的数组了</span>
	<span class="token function">obtain</span><span class="token punctuation">(</span>chunk<span class="token punctuation">,</span> geom<span class="token punctuation">.</span>point_offsets<span class="token punctuation">,</span> P<span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> geom<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p><code>ImageState</code>的<code>fromChunk</code>实现为：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>CudaRasterizer<span class="token operator">::</span>ImageState CudaRasterizer<span class="token operator">::</span>ImageState<span class="token operator">::</span><span class="token function">fromChunk</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">&amp;</span> chunk<span class="token punctuation">,</span> size_t N<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	ImageState img<span class="token punctuation">;</span>
	<span class="token function">obtain</span><span class="token punctuation">(</span>chunk<span class="token punctuation">,</span> img<span class="token punctuation">.</span>accum_alpha<span class="token punctuation">,</span> N<span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">obtain</span><span class="token punctuation">(</span>chunk<span class="token punctuation">,</span> img<span class="token punctuation">.</span>n_contrib<span class="token punctuation">,</span> N<span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">obtain</span><span class="token punctuation">(</span>chunk<span class="token punctuation">,</span> img<span class="token punctuation">.</span>ranges<span class="token punctuation">,</span> N<span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> img<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>其中<code>obtain</code>就是把<code>chunk</code>开始的一段显存空间首地址赋值给<code>ptr</code>然后对<code>chunk</code>自增：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>	<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> T<span class="token operator">&gt;</span>
	<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">obtain</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">&amp;</span> chunk<span class="token punctuation">,</span> T<span class="token operator">*</span><span class="token operator">&amp;</span> ptr<span class="token punctuation">,</span> std<span class="token operator">::</span>size_t count<span class="token punctuation">,</span> std<span class="token operator">::</span>size_t alignment<span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		std<span class="token operator">::</span>size_t offset <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>std<span class="token operator">::</span>uintptr_t<span class="token operator">&gt;</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span> <span class="token operator">+</span> alignment <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token punctuation">(</span>alignment <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		ptr <span class="token operator">=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>T<span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
		chunk <span class="token operator">=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>ptr <span class="token operator">+</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>这样就能理解前面的内分配过程了：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>	size_t chunk_size <span class="token operator">=</span> required<span class="token operator">&lt;</span>GeometryState<span class="token operator">&gt;</span><span class="token punctuation">(</span>P<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//计算所需的显存大小</span>
	<span class="token keyword">char</span><span class="token operator">*</span> chunkptr <span class="token operator">=</span> <span class="token function">geometryBuffer</span><span class="token punctuation">(</span>chunk_size<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//分配显存块，并返回首地址</span>
	GeometryState geomState <span class="token operator">=</span> GeometryState<span class="token operator">::</span><span class="token function">fromChunk</span><span class="token punctuation">(</span>chunkptr<span class="token punctuation">,</span> P<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//将分配的显存块初始化为GeometryState</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><code>required</code>调用<code>fromChunk</code>时有<code>char* size = nullptr;</code>，实际上<code>size</code>是0，于是放进<code>fromChunk</code>的<code>chunk</code>参数里就自增得到所需的内存大小，然后调用<code>resizeFunctional</code>实际分配内存和<code>fromChunk</code>给数组指针赋值。</p> <h2 id="深入cudarasterizer-rasterizer-forward（二）预处理过程forward-preprocess"><a href="#深入cudarasterizer-rasterizer-forward（二）预处理过程forward-preprocess" class="header-anchor">#</a> 深入<code>CudaRasterizer::Rasterizer::forward</code>（二）预处理过程<code>FORWARD::preprocess</code></h2> <p><code>FORWARD::preprocess</code>计算每一个高斯球投影出来的圆半径及覆盖的范围。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>	<span class="token comment">// Run preprocessing per-Gaussian (transformation, bounding, conversion of SHs to RGB)</span>
	<span class="token function">CHECK_CUDA</span><span class="token punctuation">(</span>FORWARD<span class="token operator">::</span><span class="token function">preprocess</span><span class="token punctuation">(</span>
		P<span class="token punctuation">,</span> D<span class="token punctuation">,</span> M<span class="token punctuation">,</span>
		means3D<span class="token punctuation">,</span>
		<span class="token punctuation">(</span>glm<span class="token operator">::</span>vec3<span class="token operator">*</span><span class="token punctuation">)</span>scales<span class="token punctuation">,</span>
		scale_modifier<span class="token punctuation">,</span>
		<span class="token punctuation">(</span>glm<span class="token operator">::</span>vec4<span class="token operator">*</span><span class="token punctuation">)</span>rotations<span class="token punctuation">,</span>
		opacities<span class="token punctuation">,</span>
		shs<span class="token punctuation">,</span>
		geomState<span class="token punctuation">.</span>clamped<span class="token punctuation">,</span>
		cov3D_precomp<span class="token punctuation">,</span>
		colors_precomp<span class="token punctuation">,</span>
		viewmatrix<span class="token punctuation">,</span> projmatrix<span class="token punctuation">,</span>
		<span class="token punctuation">(</span>glm<span class="token operator">::</span>vec3<span class="token operator">*</span><span class="token punctuation">)</span>cam_pos<span class="token punctuation">,</span>
		width<span class="token punctuation">,</span> height<span class="token punctuation">,</span>
		focal_x<span class="token punctuation">,</span> focal_y<span class="token punctuation">,</span>
		tan_fovx<span class="token punctuation">,</span> tan_fovy<span class="token punctuation">,</span>
		radii<span class="token punctuation">,</span>
		geomState<span class="token punctuation">.</span>means2D<span class="token punctuation">,</span>
		geomState<span class="token punctuation">.</span>depths<span class="token punctuation">,</span>
		geomState<span class="token punctuation">.</span>cov3D<span class="token punctuation">,</span>
		geomState<span class="token punctuation">.</span>rgb<span class="token punctuation">,</span>
		geomState<span class="token punctuation">.</span>conic_opacity<span class="token punctuation">,</span>
		tile_grid<span class="token punctuation">,</span>
		geomState<span class="token punctuation">.</span>tiles_touched<span class="token punctuation">,</span>
		prefiltered
	<span class="token punctuation">)</span><span class="token punctuation">,</span> debug<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>这个<code>preprocess</code>函数经过一层封装，实际上是并行调用<code>preprocessCUDA</code>对每个高斯球进行处理：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">void</span> FORWARD<span class="token operator">::</span><span class="token function">preprocess</span><span class="token punctuation">(</span><span class="token keyword">int</span> P<span class="token punctuation">,</span> <span class="token keyword">int</span> D<span class="token punctuation">,</span> <span class="token keyword">int</span> M<span class="token punctuation">,</span>
	<span class="token keyword">const</span> <span class="token keyword">float</span><span class="token operator">*</span> means3D<span class="token punctuation">,</span>
	<span class="token keyword">const</span> glm<span class="token operator">::</span>vec3<span class="token operator">*</span> scales<span class="token punctuation">,</span>
	<span class="token keyword">const</span> <span class="token keyword">float</span> scale_modifier<span class="token punctuation">,</span>
	<span class="token keyword">const</span> glm<span class="token operator">::</span>vec4<span class="token operator">*</span> rotations<span class="token punctuation">,</span>
	<span class="token keyword">const</span> <span class="token keyword">float</span><span class="token operator">*</span> opacities<span class="token punctuation">,</span>
	<span class="token keyword">const</span> <span class="token keyword">float</span><span class="token operator">*</span> shs<span class="token punctuation">,</span>
	<span class="token keyword">bool</span><span class="token operator">*</span> clamped<span class="token punctuation">,</span>
	<span class="token keyword">const</span> <span class="token keyword">float</span><span class="token operator">*</span> cov3D_precomp<span class="token punctuation">,</span>
	<span class="token keyword">const</span> <span class="token keyword">float</span><span class="token operator">*</span> colors_precomp<span class="token punctuation">,</span>
	<span class="token keyword">const</span> <span class="token keyword">float</span><span class="token operator">*</span> viewmatrix<span class="token punctuation">,</span>
	<span class="token keyword">const</span> <span class="token keyword">float</span><span class="token operator">*</span> projmatrix<span class="token punctuation">,</span>
	<span class="token keyword">const</span> glm<span class="token operator">::</span>vec3<span class="token operator">*</span> cam_pos<span class="token punctuation">,</span>
	<span class="token keyword">const</span> <span class="token keyword">int</span> W<span class="token punctuation">,</span> <span class="token keyword">int</span> H<span class="token punctuation">,</span>
	<span class="token keyword">const</span> <span class="token keyword">float</span> focal_x<span class="token punctuation">,</span> <span class="token keyword">float</span> focal_y<span class="token punctuation">,</span>
	<span class="token keyword">const</span> <span class="token keyword">float</span> tan_fovx<span class="token punctuation">,</span> <span class="token keyword">float</span> tan_fovy<span class="token punctuation">,</span>
	<span class="token keyword">int</span><span class="token operator">*</span> radii<span class="token punctuation">,</span>
	float2<span class="token operator">*</span> means2D<span class="token punctuation">,</span>
	<span class="token keyword">float</span><span class="token operator">*</span> depths<span class="token punctuation">,</span>
	<span class="token keyword">float</span><span class="token operator">*</span> cov3Ds<span class="token punctuation">,</span>
	<span class="token keyword">float</span><span class="token operator">*</span> rgb<span class="token punctuation">,</span>
	float4<span class="token operator">*</span> conic_opacity<span class="token punctuation">,</span>
	<span class="token keyword">const</span> dim3 grid<span class="token punctuation">,</span>
	<span class="token keyword">uint32_t</span><span class="token operator">*</span> tiles_touched<span class="token punctuation">,</span>
	<span class="token keyword">bool</span> prefiltered<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	preprocessCUDA<span class="token operator">&lt;</span>NUM_CHANNELS<span class="token operator">&gt;</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">&lt;</span><span class="token punctuation">(</span>P <span class="token operator">+</span> <span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">256</span> <span class="token operator">&gt;&gt;</span> <span class="token operator">&gt;</span> <span class="token punctuation">(</span> <span class="token comment">//一个线程处理一个高斯球</span>
		P<span class="token punctuation">,</span> D<span class="token punctuation">,</span> M<span class="token punctuation">,</span>
		means3D<span class="token punctuation">,</span>
		scales<span class="token punctuation">,</span>
		scale_modifier<span class="token punctuation">,</span>
		rotations<span class="token punctuation">,</span>
		opacities<span class="token punctuation">,</span>
		shs<span class="token punctuation">,</span>
		clamped<span class="token punctuation">,</span>
		cov3D_precomp<span class="token punctuation">,</span>
		colors_precomp<span class="token punctuation">,</span>
		viewmatrix<span class="token punctuation">,</span> 
		projmatrix<span class="token punctuation">,</span>
		cam_pos<span class="token punctuation">,</span>
		W<span class="token punctuation">,</span> H<span class="token punctuation">,</span>
		tan_fovx<span class="token punctuation">,</span> tan_fovy<span class="token punctuation">,</span>
		focal_x<span class="token punctuation">,</span> focal_y<span class="token punctuation">,</span>
		radii<span class="token punctuation">,</span>
		means2D<span class="token punctuation">,</span>
		depths<span class="token punctuation">,</span>
		cov3Ds<span class="token punctuation">,</span>
		rgb<span class="token punctuation">,</span>
		conic_opacity<span class="token punctuation">,</span>
		grid<span class="token punctuation">,</span>
		tiles_touched<span class="token punctuation">,</span>
		prefiltered
		<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br></div></div><h2 id="并行预处理函数preprocesscuda"><a href="#并行预处理函数preprocesscuda" class="header-anchor">#</a> 并行预处理函数<code>preprocessCUDA</code></h2> <h3 id="preprocesscuda函数开头"><a href="#preprocesscuda函数开头" class="header-anchor">#</a> <code>preprocessCUDA</code>函数开头</h3> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">// Perform initial steps for each Gaussian prior to rasterization.</span>
<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">int</span> C<span class="token operator">&gt;</span>
__global__ <span class="token keyword">void</span> <span class="token function">preprocessCUDA</span><span class="token punctuation">(</span><span class="token keyword">int</span> P<span class="token punctuation">,</span> <span class="token keyword">int</span> D<span class="token punctuation">,</span> <span class="token keyword">int</span> M<span class="token punctuation">,</span> <span class="token comment">// P是高斯球的数量、D和M是球谐函数的级数</span>
	<span class="token keyword">const</span> <span class="token keyword">float</span><span class="token operator">*</span> orig_points<span class="token punctuation">,</span> <span class="token comment">//高斯球中心在世界空间下的坐标</span>
	<span class="token keyword">const</span> glm<span class="token operator">::</span>vec3<span class="token operator">*</span> scales<span class="token punctuation">,</span>
	<span class="token keyword">const</span> <span class="token keyword">float</span> scale_modifier<span class="token punctuation">,</span>
	<span class="token keyword">const</span> glm<span class="token operator">::</span>vec4<span class="token operator">*</span> rotations<span class="token punctuation">,</span>
	<span class="token keyword">const</span> <span class="token keyword">float</span><span class="token operator">*</span> opacities<span class="token punctuation">,</span>
	<span class="token keyword">const</span> <span class="token keyword">float</span><span class="token operator">*</span> shs<span class="token punctuation">,</span>
	<span class="token keyword">bool</span><span class="token operator">*</span> clamped<span class="token punctuation">,</span>
	<span class="token keyword">const</span> <span class="token keyword">float</span><span class="token operator">*</span> cov3D_precomp<span class="token punctuation">,</span>
	<span class="token keyword">const</span> <span class="token keyword">float</span><span class="token operator">*</span> colors_precomp<span class="token punctuation">,</span>
	<span class="token keyword">const</span> <span class="token keyword">float</span><span class="token operator">*</span> viewmatrix<span class="token punctuation">,</span> <span class="token comment">// view transform matrix，世界空间坐标转相机空间坐标</span>
	<span class="token keyword">const</span> <span class="token keyword">float</span><span class="token operator">*</span> projmatrix<span class="token punctuation">,</span> <span class="token comment">// 这里的projmatrix其实是projection transform和view transform的合体，直接把世界空间坐标转NDC空间坐标</span>
	<span class="token keyword">const</span> glm<span class="token operator">::</span>vec3<span class="token operator">*</span> cam_pos<span class="token punctuation">,</span>
	<span class="token keyword">const</span> <span class="token keyword">int</span> W<span class="token punctuation">,</span> <span class="token keyword">int</span> H<span class="token punctuation">,</span>
	<span class="token keyword">const</span> <span class="token keyword">float</span> tan_fovx<span class="token punctuation">,</span> <span class="token keyword">float</span> tan_fovy<span class="token punctuation">,</span>
	<span class="token keyword">const</span> <span class="token keyword">float</span> focal_x<span class="token punctuation">,</span> <span class="token keyword">float</span> focal_y<span class="token punctuation">,</span>
	<span class="token keyword">int</span><span class="token operator">*</span> radii<span class="token punctuation">,</span>
	float2<span class="token operator">*</span> points_xy_image<span class="token punctuation">,</span>
	<span class="token keyword">float</span><span class="token operator">*</span> depths<span class="token punctuation">,</span>
	<span class="token keyword">float</span><span class="token operator">*</span> cov3Ds<span class="token punctuation">,</span>
	<span class="token keyword">float</span><span class="token operator">*</span> rgb<span class="token punctuation">,</span>
	float4<span class="token operator">*</span> conic_opacity<span class="token punctuation">,</span>
	<span class="token keyword">const</span> dim3 grid<span class="token punctuation">,</span> <span class="token comment">//block块的范围</span>
	<span class="token keyword">uint32_t</span><span class="token operator">*</span> tiles_touched<span class="token punctuation">,</span>
	<span class="token keyword">bool</span> prefiltered<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">auto</span> idx <span class="token operator">=</span> cg<span class="token operator">::</span><span class="token function">this_grid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thread_rank</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//线程在组内的标号，区间为[0,num_threads)</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>idx <span class="token operator">&gt;=</span> P<span class="token punctuation">)</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">//如果编号大于高斯球的数量，则返回，也就是说一个线程对应一个高斯球处理</span>

	<span class="token comment">// Initialize radius and touched tiles to 0. If this isn't changed,</span>
	<span class="token comment">// this Gaussian will not be processed further.</span>
	radii<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//高斯球半径</span>
	tiles_touched<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//高斯球在图片上覆盖的tile数量</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><h3 id="剔除近处的高斯球"><a href="#剔除近处的高斯球" class="header-anchor">#</a> 剔除近处的高斯球</h3> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>	<span class="token comment">// Perform near culling, quit if outside.</span>
	float3 p_view<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_frustum</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span> orig_points<span class="token punctuation">,</span> viewmatrix<span class="token punctuation">,</span> projmatrix<span class="token punctuation">,</span> prefiltered<span class="token punctuation">,</span> p_view<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">//执行近剔除，如果高斯球离成像平面太近则退出</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="高斯球中心坐标转换到相机坐标系"><a href="#高斯球中心坐标转换到相机坐标系" class="header-anchor">#</a> 高斯球中心坐标转换到相机坐标系</h3> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>	<span class="token comment">// Transform point by projecting</span>
	float3 p_orig <span class="token operator">=</span> <span class="token punctuation">{</span> orig_points<span class="token punctuation">[</span><span class="token number">3</span> <span class="token operator">*</span> idx<span class="token punctuation">]</span><span class="token punctuation">,</span> orig_points<span class="token punctuation">[</span><span class="token number">3</span> <span class="token operator">*</span> idx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> orig_points<span class="token punctuation">[</span><span class="token number">3</span> <span class="token operator">*</span> idx <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">//高斯球中心在世界空间下的坐标</span>
	float4 p_hom <span class="token operator">=</span> <span class="token function">transformPoint4x4</span><span class="token punctuation">(</span>p_orig<span class="token punctuation">,</span> projmatrix<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//世界空间坐标直接转NDC坐标，并且自动变齐次</span>
	<span class="token keyword">float</span> p_w <span class="token operator">=</span> <span class="token number">1.0f</span> <span class="token operator">/</span> <span class="token punctuation">(</span>p_hom<span class="token punctuation">.</span>w <span class="token operator">+</span> <span class="token number">0.0000001f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	float3 p_proj <span class="token operator">=</span> <span class="token punctuation">{</span> p_hom<span class="token punctuation">.</span>x <span class="token operator">*</span> p_w<span class="token punctuation">,</span> p_hom<span class="token punctuation">.</span>y <span class="token operator">*</span> p_w<span class="token punctuation">,</span> p_hom<span class="token punctuation">.</span>z <span class="token operator">*</span> p_w <span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">//齐次转回非齐次</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="由高斯球参数计算3d协方差矩阵"><a href="#由高斯球参数计算3d协方差矩阵" class="header-anchor">#</a> 由高斯球参数计算3D协方差矩阵</h3> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>	<span class="token comment">// If 3D covariance matrix is precomputed, use it, otherwise compute</span>
	<span class="token comment">// from scaling and rotation parameters. </span>
	<span class="token keyword">const</span> <span class="token keyword">float</span><span class="token operator">*</span> cov3D<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>cov3D_precomp <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		cov3D <span class="token operator">=</span> cov3D_precomp <span class="token operator">+</span> idx <span class="token operator">*</span> <span class="token number">6</span><span class="token punctuation">;</span> <span class="token comment">//预设的3D协方差</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span>
	<span class="token punctuation">{</span>
		<span class="token function">computeCov3D</span><span class="token punctuation">(</span>scales<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">,</span> scale_modifier<span class="token punctuation">,</span> rotations<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">,</span> cov3Ds <span class="token operator">+</span> idx <span class="token operator">*</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//用高斯球的scales和rotations其3D协方差，放进cov3Ds里</span>
		cov3D <span class="token operator">=</span> cov3Ds <span class="token operator">+</span> idx <span class="token operator">*</span> <span class="token number">6</span><span class="token punctuation">;</span> <span class="token comment">//从cov3Ds里读取高斯球的3D协方差矩阵</span>
	<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="_3d协方差矩阵计算函数computecov3d"><a href="#_3d协方差矩阵计算函数computecov3d" class="header-anchor">#</a> 3D协方差矩阵计算函数<code>computeCov3D</code></h3> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">// Forward method for converting scale and rotation properties of each</span>
<span class="token comment">// Gaussian to a 3D covariance matrix in world space. Also takes care</span>
<span class="token comment">// of quaternion normalization.</span>
__device__ <span class="token keyword">void</span> <span class="token function">computeCov3D</span><span class="token punctuation">(</span><span class="token keyword">const</span> glm<span class="token operator">::</span>vec3 scale<span class="token punctuation">,</span> <span class="token keyword">float</span> mod<span class="token punctuation">,</span> <span class="token keyword">const</span> glm<span class="token operator">::</span>vec4 rot<span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token operator">*</span> cov3D<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="从scale参数计算缩放矩阵"><a href="#从scale参数计算缩放矩阵" class="header-anchor">#</a> 从<code>scale</code>参数计算缩放矩阵<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi></mrow><annotation encoding="application/x-tex">S</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span></span></span></span></h4> <p>首先根据高斯球的<code>scale</code>参数创建缩放矩阵：</p> <p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.15999999999999992em" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>s</mi><mi>x</mi></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>s</mi><mi>y</mi></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>s</mi><mi>z</mi></msub></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">S=\left[\begin{matrix}s_x &amp; 0 &amp; 0 \\0 &amp; s_y &amp; 0 \\0 &amp; 0 &amp; s_z\end{matrix}\right]
</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:3.6010299999999997em;vertical-align:-1.55002em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.0510099999999998em;"><span style="top:-2.2500000000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎣</span></span></span><span style="top:-2.8099900000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-4.05101em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎡</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55002em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.8099999999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span><span style="top:-1.8099999999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.8099999999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.04398em;">z</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.0510099999999998em;"><span style="top:-2.2500000000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎦</span></span></span><span style="top:-2.8099900000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-4.05101em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎤</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55002em;"><span></span></span></span></span></span></span></span></span></span></span></span></p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>	<span class="token comment">// Create scaling matrix</span>
	glm<span class="token operator">::</span>mat3 S <span class="token operator">=</span> glm<span class="token operator">::</span><span class="token function">mat3</span><span class="token punctuation">(</span><span class="token number">1.0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	S<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> mod <span class="token operator">*</span> scale<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
	S<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> mod <span class="token operator">*</span> scale<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
	S<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> mod <span class="token operator">*</span> scale<span class="token punctuation">.</span>z<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>其中的<code>mod</code>来自于外面Python传来的<code>scale_modifier</code>，在使用图形界面看3DGS场景的时候可见调节高斯球大小的功能就是由此实现。</p> <h4 id="从四元数计算旋转矩阵"><a href="#从四元数计算旋转矩阵" class="header-anchor">#</a> 从四元数计算旋转矩阵<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi></mrow><annotation encoding="application/x-tex">R</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.00773em;">R</span></span></span></span></h4> <p>旋转矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi></mrow><annotation encoding="application/x-tex">R</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.00773em;">R</span></span></span></span> 可以从归一化的四元数 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>q</mi><mo>=</mo><mo stretchy="false">[</mo><mi>r</mi><mo separator="true">,</mo><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo separator="true">,</mo><mi>z</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">q = [r, x, y, z]</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">q</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.04398em;">z</span><span class="mclose">]</span></span></span></span> 计算得出：</p> <p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.15999999999999992em" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>1</mn><mo>−</mo><mn>2</mn><mo stretchy="false">(</mo><msup><mi>y</mi><mn>2</mn></msup><mo>+</mo><msup><mi>z</mi><mn>2</mn></msup><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>2</mn><mo stretchy="false">(</mo><mi>x</mi><mi>y</mi><mo>−</mo><mi>r</mi><mi>z</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>2</mn><mo stretchy="false">(</mo><mi>x</mi><mi>z</mi><mo>+</mo><mi>r</mi><mi>y</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>2</mn><mo stretchy="false">(</mo><mi>x</mi><mi>y</mi><mo>+</mo><mi>r</mi><mi>z</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>1</mn><mo>−</mo><mn>2</mn><mo stretchy="false">(</mo><msup><mi>x</mi><mn>2</mn></msup><mo>+</mo><msup><mi>z</mi><mn>2</mn></msup><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>2</mn><mo stretchy="false">(</mo><mi>y</mi><mi>z</mi><mo>−</mo><mi>r</mi><mi>x</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>2</mn><mo stretchy="false">(</mo><mi>x</mi><mi>z</mi><mo>−</mo><mi>r</mi><mi>y</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>2</mn><mo stretchy="false">(</mo><mi>y</mi><mi>z</mi><mo>+</mo><mi>r</mi><mi>x</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>1</mn><mo>−</mo><mn>2</mn><mo stretchy="false">(</mo><msup><mi>x</mi><mn>2</mn></msup><mo>+</mo><msup><mi>y</mi><mn>2</mn></msup><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">R = \left[\begin{matrix}
1 - 2(y^2 + z^2) &amp; 2(xy - rz) &amp; 2(xz + ry) \\
2(xy + rz) &amp; 1 - 2(x^2 + z^2) &amp; 2(yz - rx) \\
2(xz - ry) &amp; 2(yz + rx) &amp; 1 - 2(x^2 + y^2)
\end{matrix}\right]</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:3.6010299999999997em;vertical-align:-1.55002em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.0510099999999998em;"><span style="top:-2.2500000000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎣</span></span></span><span style="top:-2.8099900000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-4.05101em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎡</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55002em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">2</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault" style="margin-right:0.04398em;">z</span><span class="mclose">)</span></span></span><span style="top:-1.8099999999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mord mathdefault" style="margin-right:0.04398em;">z</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault" style="margin-right:0.04398em;">z</span><span class="mclose">)</span></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">2</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-1.8099999999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mord mathdefault" style="margin-right:0.04398em;">z</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">x</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mord mathdefault" style="margin-right:0.04398em;">z</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mclose">)</span></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mord mathdefault" style="margin-right:0.04398em;">z</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">x</span><span class="mclose">)</span></span></span><span style="top:-1.8099999999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">2</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.0510099999999998em;"><span style="top:-2.2500000000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎦</span></span></span><span style="top:-2.8099900000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-4.05101em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎤</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55002em;"><span></span></span></span></span></span></span></span></span></span></span></span></p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>	<span class="token comment">// Normalize quaternion to get valid rotation</span>
	glm<span class="token operator">::</span>vec4 q <span class="token operator">=</span> rot<span class="token punctuation">;</span><span class="token comment">// / glm::length(rot);</span>
	<span class="token keyword">float</span> r <span class="token operator">=</span> q<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
	<span class="token keyword">float</span> x <span class="token operator">=</span> q<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
	<span class="token keyword">float</span> y <span class="token operator">=</span> q<span class="token punctuation">.</span>z<span class="token punctuation">;</span>
	<span class="token keyword">float</span> z <span class="token operator">=</span> q<span class="token punctuation">.</span>w<span class="token punctuation">;</span>

	<span class="token comment">// Compute rotation matrix from quaternion</span>
	glm<span class="token operator">::</span>mat3 R <span class="token operator">=</span> glm<span class="token operator">::</span><span class="token function">mat3</span><span class="token punctuation">(</span>
		<span class="token number">1.f</span> <span class="token operator">-</span> <span class="token number">2.f</span> <span class="token operator">*</span> <span class="token punctuation">(</span>y <span class="token operator">*</span> y <span class="token operator">+</span> z <span class="token operator">*</span> z<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2.f</span> <span class="token operator">*</span> <span class="token punctuation">(</span>x <span class="token operator">*</span> y <span class="token operator">-</span> r <span class="token operator">*</span> z<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2.f</span> <span class="token operator">*</span> <span class="token punctuation">(</span>x <span class="token operator">*</span> z <span class="token operator">+</span> r <span class="token operator">*</span> y<span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token number">2.f</span> <span class="token operator">*</span> <span class="token punctuation">(</span>x <span class="token operator">*</span> y <span class="token operator">+</span> r <span class="token operator">*</span> z<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1.f</span> <span class="token operator">-</span> <span class="token number">2.f</span> <span class="token operator">*</span> <span class="token punctuation">(</span>x <span class="token operator">*</span> x <span class="token operator">+</span> z <span class="token operator">*</span> z<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2.f</span> <span class="token operator">*</span> <span class="token punctuation">(</span>y <span class="token operator">*</span> z <span class="token operator">-</span> r <span class="token operator">*</span> x<span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token number">2.f</span> <span class="token operator">*</span> <span class="token punctuation">(</span>x <span class="token operator">*</span> z <span class="token operator">-</span> r <span class="token operator">*</span> y<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2.f</span> <span class="token operator">*</span> <span class="token punctuation">(</span>y <span class="token operator">*</span> z <span class="token operator">+</span> r <span class="token operator">*</span> x<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1.f</span> <span class="token operator">-</span> <span class="token number">2.f</span> <span class="token operator">*</span> <span class="token punctuation">(</span>x <span class="token operator">*</span> x <span class="token operator">+</span> y <span class="token operator">*</span> y<span class="token punctuation">)</span>
	<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h4 id="计算3d协方差矩阵"><a href="#计算3d协方差矩阵" class="header-anchor">#</a> 计算3D协方差矩阵<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Σ</mi></mrow><annotation encoding="application/x-tex">\Sigma</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord">Σ</span></span></span></span></h4> <p>由缩放矩阵<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi></mrow><annotation encoding="application/x-tex">S</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span></span></span></span>和旋转矩阵<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi></mrow><annotation encoding="application/x-tex">R</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.00773em;">R</span></span></span></span>计算3D协方差矩阵的公式来自3DGS原论文：</p> <p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Σ</mi><mo>=</mo><mi>R</mi><mi>S</mi><msup><mi>S</mi><mi>T</mi></msup><msup><mi>R</mi><mi>T</mi></msup></mrow><annotation encoding="application/x-tex">\Sigma=RSS^TR^T
</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord">Σ</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8913309999999999em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913309999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913309999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span></span></p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>	glm<span class="token operator">::</span>mat3 M <span class="token operator">=</span> S <span class="token operator">*</span> R<span class="token punctuation">;</span>

	<span class="token comment">// Compute 3D world covariance matrix Sigma</span>
	glm<span class="token operator">::</span>mat3 Sigma <span class="token operator">=</span> glm<span class="token operator">::</span><span class="token function">transpose</span><span class="token punctuation">(</span>M<span class="token punctuation">)</span> <span class="token operator">*</span> M<span class="token punctuation">;</span>

	<span class="token comment">// Covariance is symmetric, only store upper right</span>
	cov3D<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> Sigma<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	cov3D<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> Sigma<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	cov3D<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> Sigma<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	cov3D<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> Sigma<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	cov3D<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> Sigma<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	cov3D<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> Sigma<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="_3d协方差矩阵计算投影到成像平面上的2d协方差"><a href="#_3d协方差矩阵计算投影到成像平面上的2d协方差" class="header-anchor">#</a> 3D协方差矩阵计算投影到成像平面上的2D协方差</h3> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>	<span class="token comment">// Compute 2D screen-space covariance matrix</span>
	float3 cov <span class="token operator">=</span> <span class="token function">computeCov2D</span><span class="token punctuation">(</span>p_orig<span class="token punctuation">,</span> focal_x<span class="token punctuation">,</span> focal_y<span class="token punctuation">,</span> tan_fovx<span class="token punctuation">,</span> tan_fovy<span class="token punctuation">,</span> cov3D<span class="token punctuation">,</span> viewmatrix<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//计算椭球投影成椭圆的样子[cov.x,cov.y,cov.y,cov.z]，即2D协方差矩阵[abbc]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="_2d协方差矩阵计算函数computecov2d"><a href="#_2d协方差矩阵计算函数computecov2d" class="header-anchor">#</a> 2D协方差矩阵计算函数<code>computeCov2D</code></h3> <p>按注释所讲，此函数对应公式来自于&quot;EWA Splatting&quot; (Zwicker et al., 2002)原论文：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">// Forward version of 2D covariance matrix computation</span>
__device__ float3 <span class="token function">computeCov2D</span><span class="token punctuation">(</span><span class="token keyword">const</span> float3<span class="token operator">&amp;</span> mean<span class="token punctuation">,</span> <span class="token keyword">float</span> focal_x<span class="token punctuation">,</span> <span class="token keyword">float</span> focal_y<span class="token punctuation">,</span> <span class="token keyword">float</span> tan_fovx<span class="token punctuation">,</span> <span class="token keyword">float</span> tan_fovy<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">float</span><span class="token operator">*</span> cov3D<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">float</span><span class="token operator">*</span> viewmatrix<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token comment">// The following models the steps outlined by equations 29</span>
	<span class="token comment">// and 31 in &quot;EWA Splatting&quot; (Zwicker et al., 2002). </span>
	<span class="token comment">// Additionally considers aspect / scaling of viewport.</span>
	<span class="token comment">// Transposes used to account for row-/column-major conventions.</span>
	float3 t <span class="token operator">=</span> <span class="token function">transformPoint4x3</span><span class="token punctuation">(</span>mean<span class="token punctuation">,</span> viewmatrix<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 高斯球中心点坐标变换到相机坐标系</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h4 id="限制高斯球中心点坐标范围"><a href="#限制高斯球中心点坐标范围" class="header-anchor">#</a> 限制高斯球中心点坐标范围</h4> <p>此举意在保持数值稳定性避免精度溢出：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>	<span class="token keyword">const</span> <span class="token keyword">float</span> limx <span class="token operator">=</span> <span class="token number">1.3f</span> <span class="token operator">*</span> tan_fovx<span class="token punctuation">;</span>
	<span class="token keyword">const</span> <span class="token keyword">float</span> limy <span class="token operator">=</span> <span class="token number">1.3f</span> <span class="token operator">*</span> tan_fovy<span class="token punctuation">;</span>
	<span class="token keyword">const</span> <span class="token keyword">float</span> txtz <span class="token operator">=</span> t<span class="token punctuation">.</span>x <span class="token operator">/</span> t<span class="token punctuation">.</span>z<span class="token punctuation">;</span> <span class="token comment">// xy除了个z</span>
	<span class="token keyword">const</span> <span class="token keyword">float</span> tytz <span class="token operator">=</span> t<span class="token punctuation">.</span>y <span class="token operator">/</span> t<span class="token punctuation">.</span>z<span class="token punctuation">;</span>
	t<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>limx<span class="token punctuation">,</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token operator">-</span>limx<span class="token punctuation">,</span> txtz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> t<span class="token punctuation">.</span>z<span class="token punctuation">;</span> <span class="token comment">// 限制大小后又把z给乘回去了</span>
	t<span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>limy<span class="token punctuation">,</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token operator">-</span>limy<span class="token punctuation">,</span> tytz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> t<span class="token punctuation">.</span>z<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h4 id="计算雅可比矩阵"><a href="#计算雅可比矩阵" class="header-anchor">#</a> 计算雅可比矩阵<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>J</mi></mrow><annotation encoding="application/x-tex">J</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.09618em;">J</span></span></span></span></h4> <p>在3D到2D的投影计算过程中，雅可比矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>J</mi></mrow><annotation encoding="application/x-tex">J</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.09618em;">J</span></span></span></span> 表示2维空间坐标<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>u</mi><mo separator="true">,</mo><mi>v</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(u,v)</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathdefault">u</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mclose">)</span></span></span></span>对3维空间中的坐标<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo separator="true">,</mo><mi>z</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(x,y,z)</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.04398em;">z</span><span class="mclose">)</span></span></span></span>的导数，即：</p> <p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>J</mi><mo>=</mo><mfrac><mrow><mi mathvariant="normal">∂</mi><mo stretchy="false">(</mo><mi>u</mi><mo separator="true">,</mo><mi>v</mi><mo stretchy="false">)</mo></mrow><mrow><mi mathvariant="normal">∂</mi><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo separator="true">,</mo><mi>z</mi><mo stretchy="false">)</mo></mrow></mfrac><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.15999999999999992em" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>u</mi></mrow><mrow><mi mathvariant="normal">∂</mi><mi>x</mi></mrow></mfrac></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>u</mi></mrow><mrow><mi mathvariant="normal">∂</mi><mi>y</mi></mrow></mfrac></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>u</mi></mrow><mrow><mi mathvariant="normal">∂</mi><mi>z</mi></mrow></mfrac></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>v</mi></mrow><mrow><mi mathvariant="normal">∂</mi><mi>x</mi></mrow></mfrac></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>v</mi></mrow><mrow><mi mathvariant="normal">∂</mi><mi>y</mi></mrow></mfrac></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>v</mi></mrow><mrow><mi mathvariant="normal">∂</mi><mi>z</mi></mrow></mfrac></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">J=\frac{\partial (u,v)}{\partial (x,y,z)}=\left[
		\begin{matrix}
		\frac{\partial u}{\partial x} &amp; \frac{\partial u}{\partial y} &amp; \frac{\partial u}{\partial z} \\
		\frac{\partial v}{\partial x} &amp; \frac{\partial v}{\partial y} &amp; \frac{\partial v}{\partial z}\\
		\end{matrix}
\right]</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.09618em;">J</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.363em;vertical-align:-0.936em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.04398em;">z</span><span class="mclose">)</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mopen">(</span><span class="mord mathdefault">u</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:3.0000299999999998em;vertical-align:-1.25003em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6112159999999998em;"><span style="top:-3.731108em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801079999999999em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em;">∂</span><span class="mord mathdefault mtight">x</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em;">∂</span><span class="mord mathdefault mtight">u</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-2.369892em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801079999999999em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em;">∂</span><span class="mord mathdefault mtight">x</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em;">∂</span><span class="mord mathdefault mtight" style="margin-right:0.03588em;">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.1112159999999998em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6112159999999998em;"><span style="top:-3.731108em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801079999999999em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em;">∂</span><span class="mord mathdefault mtight" style="margin-right:0.03588em;">y</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em;">∂</span><span class="mord mathdefault mtight">u</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.481108em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-2.369892em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801079999999999em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em;">∂</span><span class="mord mathdefault mtight" style="margin-right:0.03588em;">y</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em;">∂</span><span class="mord mathdefault mtight" style="margin-right:0.03588em;">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.481108em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.1112159999999998em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6112159999999998em;"><span style="top:-3.731108em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801079999999999em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em;">∂</span><span class="mord mathdefault mtight" style="margin-right:0.04398em;">z</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em;">∂</span><span class="mord mathdefault mtight">u</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-2.369892em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801079999999999em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em;">∂</span><span class="mord mathdefault mtight" style="margin-right:0.04398em;">z</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em;">∂</span><span class="mord mathdefault mtight" style="margin-right:0.03588em;">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.1112159999999998em;"><span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size4">]</span></span></span></span></span></span></span></p> <p>3DGS只针对透视投影，根据<a href="/图形学/相机参数与坐标系变换.html">透视投影的计算公式</a>：</p> <p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>z</mi><mrow><mo fence="true">[</mo><mtable rowspacing="0.15999999999999992em" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi>u</mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi>v</mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.15999999999999992em" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>f</mi><mi>x</mi></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>c</mi><mi>x</mi></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>f</mi><mi>y</mi></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>c</mi><mi>y</mi></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo>⋅</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.15999999999999992em" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi>x</mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi>y</mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi>z</mi></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo>=</mo><mi>z</mi><mrow><mo fence="true">[</mo><mtable rowspacing="0.15999999999999992em" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>f</mi><mi>x</mi></msub><mfrac><mi>x</mi><mi>z</mi></mfrac><mo>+</mo><msub><mi>c</mi><mi>x</mi></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>f</mi><mi>y</mi></msub><mfrac><mi>y</mi><mi>z</mi></mfrac><mo>+</mo><msub><mi>c</mi><mi>y</mi></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">z
\left[
\begin{matrix}
    u\\v\\1
\end{matrix}
\right]
=
\left[
\begin{matrix}
    f_x&amp;0&amp;c_x\\0&amp;f_y&amp;c_y\\0&amp;0&amp;1
\end{matrix}
\right]
\cdot
\left[
\begin{matrix}
    x\\y\\z
\end{matrix}
\right]
=
z
\left[
\begin{matrix}
    f_x\frac{x}{z}+c_x\\f_y\frac{y}{z}+c_y\\1
\end{matrix}
\right]
</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:3.6010299999999997em;vertical-align:-1.55002em;"></span><span class="mord mathdefault" style="margin-right:0.04398em;">z</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.0510099999999998em;"><span style="top:-2.2500000000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎣</span></span></span><span style="top:-2.8099900000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-4.05101em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎡</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55002em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">u</span></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">v</span></span></span><span style="top:-1.8099999999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.0510099999999998em;"><span style="top:-2.2500000000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎦</span></span></span><span style="top:-2.8099900000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-4.05101em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎤</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55002em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:3.6010299999999997em;vertical-align:-1.55002em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.0510099999999998em;"><span style="top:-2.2500000000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎣</span></span></span><span style="top:-2.8099900000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-4.05101em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎡</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55002em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.8099999999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span><span style="top:-1.8099999999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span><span style="top:-1.8099999999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.0510099999999998em;"><span style="top:-2.2500000000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎦</span></span></span><span style="top:-2.8099900000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-4.05101em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎤</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55002em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:3.6010299999999997em;vertical-align:-1.55002em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.0510099999999998em;"><span style="top:-2.2500000000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎣</span></span></span><span style="top:-2.8099900000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-4.05101em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎡</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55002em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">x</span></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span></span></span><span style="top:-1.8099999999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.04398em;">z</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.0510099999999998em;"><span style="top:-2.2500000000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎦</span></span></span><span style="top:-2.8099900000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-4.05101em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎤</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55002em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:3.6010299999999997em;vertical-align:-1.55002em;"></span><span class="mord mathdefault" style="margin-right:0.04398em;">z</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.0510099999999998em;"><span style="top:-2.2500000000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎣</span></span></span><span style="top:-2.8099900000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-4.05101em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎡</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55002em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.695392em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.04398em;">z</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7475em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.04398em;">z</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.446108em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">y</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span><span style="top:-1.8099999999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.0510099999999998em;"><span style="top:-2.2500000000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎦</span></span></span><span style="top:-2.8099900000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-4.05101em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎤</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55002em;"><span></span></span></span></span></span></span></span></span></span></span></span></p> <p>可知<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>u</mi><mo separator="true">,</mo><mi>v</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(u,v)</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathdefault">u</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mclose">)</span></span></span></span>和<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo separator="true">,</mo><mi>z</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(x,y,z)</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.04398em;">z</span><span class="mclose">)</span></span></span></span>的对应关系：</p> <p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable rowspacing="0.24999999999999992em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mi>u</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><msub><mi>f</mi><mi>x</mi></msub><mfrac><mi>x</mi><mi>z</mi></mfrac><mo>+</mo><msub><mi>c</mi><mi>x</mi></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mi>v</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><msub><mi>f</mi><mi>y</mi></msub><mfrac><mi>y</mi><mi>z</mi></mfrac><mo>+</mo><msub><mi>c</mi><mi>y</mi></msub></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}
u&amp;=f_x\frac{x}{z}+c_x\\
v&amp;=f_y\frac{y}{z}+c_y\\
\end{aligned}
</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:4.18712em;vertical-align:-1.84356em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.34356em;"><span style="top:-4.34356em;"><span class="pstrut" style="height:3.1075600000000003em;"></span><span class="mord"><span class="mord mathdefault">u</span></span></span><span style="top:-2.2500000000000004em;"><span class="pstrut" style="height:3.1075600000000003em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.84356em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.34356em;"><span style="top:-4.34356em;"><span class="pstrut" style="height:3.1075600000000003em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.10756em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.04398em;">z</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.2500000000000004em;"><span class="pstrut" style="height:3.1075600000000003em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1075599999999999em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.04398em;">z</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.84356em;"><span></span></span></span></span></span></span></span></span></span></span></span></p> <p>进而求导得雅可比矩阵<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>J</mi></mrow><annotation encoding="application/x-tex">J</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.09618em;">J</span></span></span></span>：</p> <p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>J</mi><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.15999999999999992em" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>f</mi><mi>x</mi></msub><mfrac><mn>1</mn><mi>z</mi></mfrac></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>−</mo><msub><mi>f</mi><mi>x</mi></msub><mfrac><mi>x</mi><msup><mi>z</mi><mn>2</mn></msup></mfrac></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>f</mi><mi>y</mi></msub><mfrac><mn>1</mn><mi>z</mi></mfrac></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>−</mo><msub><mi>f</mi><mi>y</mi></msub><mfrac><mi>y</mi><msup><mi>z</mi><mn>2</mn></msup></mfrac></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">J=\left[
		\begin{matrix}
		f_x\frac{1}{z} &amp; 0 &amp; -f_x\frac{x}{z^2} \\
		0 &amp; f_y\frac{1}{z} &amp; -f_y\frac{y}{z^2} \\
		\end{matrix}
\right]</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.09618em;">J</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.410216em;vertical-align:-0.9551080000000003em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.4551079999999998em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.04398em;">z</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-2.404892em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9551080000000003em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.4551079999999998em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-2.404892em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.04398em;">z</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9551080000000003em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.4551079999999998em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">−</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.695392em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7463142857142857em;"><span style="top:-2.786em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-2.404892em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">−</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7475em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7463142857142857em;"><span style="top:-2.786em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.446108em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">y</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9551080000000003em;"><span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span></span></span></span></span></p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>	glm<span class="token operator">::</span>mat3 J <span class="token operator">=</span> glm<span class="token operator">::</span><span class="token function">mat3</span><span class="token punctuation">(</span>
		focal_x <span class="token operator">/</span> t<span class="token punctuation">.</span>z<span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token punctuation">(</span>focal_x <span class="token operator">*</span> t<span class="token punctuation">.</span>x<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span>z <span class="token operator">*</span> t<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token number">0.0f</span><span class="token punctuation">,</span> focal_y <span class="token operator">/</span> t<span class="token punctuation">.</span>z<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token punctuation">(</span>focal_y <span class="token operator">*</span> t<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span>z <span class="token operator">*</span> t<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>代码里的<code>J</code>为了方便<code>glm</code>库的加速所以加上了一行0。</p> <h4 id="计算2d协方差矩阵"><a href="#计算2d协方差矩阵" class="header-anchor">#</a> 计算2D协方差矩阵<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="normal">Σ</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></mrow><annotation encoding="application/x-tex">\Sigma'</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.751892em;vertical-align:0em;"></span><span class="mord"><span class="mord">Σ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></h4> <p>2D协方差矩阵公式来自3DGS原论文：</p> <p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="normal">Σ</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo>=</mo><mi>J</mi><mi>W</mi><mi mathvariant="normal">Σ</mi><msup><mi>W</mi><mi>T</mi></msup><msup><mi>J</mi><mi>T</mi></msup></mrow><annotation encoding="application/x-tex">\Sigma'=JW\Sigma W^TJ^T
</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.801892em;vertical-align:0em;"></span><span class="mord"><span class="mord">Σ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.801892em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8913309999999999em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.09618em;">J</span><span class="mord mathdefault" style="margin-right:0.13889em;">W</span><span class="mord">Σ</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913309999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.09618em;">J</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913309999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span></span></p> <p>其中，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>W</mi></mrow><annotation encoding="application/x-tex">W</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">W</span></span></span></span>为视角变换矩阵的前3x3部分：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>	glm<span class="token operator">::</span>mat3 W <span class="token operator">=</span> glm<span class="token operator">::</span><span class="token function">mat3</span><span class="token punctuation">(</span>
		viewmatrix<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> viewmatrix<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> viewmatrix<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
		viewmatrix<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> viewmatrix<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> viewmatrix<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
		viewmatrix<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> viewmatrix<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span> viewmatrix<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>注：
上面的<strong>雅可比矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>J</mi></mrow><annotation encoding="application/x-tex">J</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.09618em;">J</span></span></span></span></strong> 蕴含<strong>相机内参</strong>的信息、<strong>视角变换矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>W</mi></mrow><annotation encoding="application/x-tex">W</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">W</span></span></span></span></strong> 蕴含<strong>相机外参</strong>信息。
于是已知相机内外参和3D协方差矩阵<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Σ</mi></mrow><annotation encoding="application/x-tex">\Sigma</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord">Σ</span></span></span></span>则可计算高斯球投影在成像平面上的2D协方差矩阵<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="normal">Σ</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></mrow><annotation encoding="application/x-tex">\Sigma'</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.751892em;vertical-align:0em;"></span><span class="mord"><span class="mord">Σ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span>，很好理解。</p> <p>注：公式<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="normal">Σ</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo>=</mo><mi>J</mi><mi>W</mi><mi mathvariant="normal">Σ</mi><msup><mi>W</mi><mi>T</mi></msup><msup><mi>J</mi><mi>T</mi></msup></mrow><annotation encoding="application/x-tex">\Sigma'=JW\Sigma W^TJ^T</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.751892em;vertical-align:0em;"></span><span class="mord"><span class="mord">Σ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8413309999999999em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.09618em;">J</span><span class="mord mathdefault" style="margin-right:0.13889em;">W</span><span class="mord">Σ</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.09618em;">J</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span>的这种投影已经包含了正交投影所需的各种变换，具体怎么由正交投影推导出这么简洁优美的表达形式的要去看&quot;EWA Splatting&quot; (Zwicker et al., 2002)原论文。</p> <p>计算<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="normal">Σ</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo>=</mo><mi>J</mi><mi>W</mi><mi mathvariant="normal">Σ</mi><msup><mi>W</mi><mi>T</mi></msup><msup><mi>J</mi><mi>T</mi></msup></mrow><annotation encoding="application/x-tex">\Sigma'=JW\Sigma W^TJ^T</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.751892em;vertical-align:0em;"></span><span class="mord"><span class="mord">Σ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8413309999999999em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.09618em;">J</span><span class="mord mathdefault" style="margin-right:0.13889em;">W</span><span class="mord">Σ</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.09618em;">J</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span>：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>	glm<span class="token operator">::</span>mat3 T <span class="token operator">=</span> W <span class="token operator">*</span> J<span class="token punctuation">;</span>

	glm<span class="token operator">::</span>mat3 Vrk <span class="token operator">=</span> glm<span class="token operator">::</span><span class="token function">mat3</span><span class="token punctuation">(</span>
		cov3D<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> cov3D<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> cov3D<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
		cov3D<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> cov3D<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> cov3D<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
		cov3D<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> cov3D<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> cov3D<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	glm<span class="token operator">::</span>mat3 cov <span class="token operator">=</span> glm<span class="token operator">::</span><span class="token function">transpose</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span> <span class="token operator">*</span> glm<span class="token operator">::</span><span class="token function">transpose</span><span class="token punctuation">(</span>Vrk<span class="token punctuation">)</span> <span class="token operator">*</span> T<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>这里的<code>Vrk</code>就是<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Σ</mi></mrow><annotation encoding="application/x-tex">\Sigma</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord">Σ</span></span></span></span></p> <p>最后保存计算结果：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>	<span class="token comment">// Apply low-pass filter: every Gaussian should be at least</span>
	<span class="token comment">// one pixel wide/high. Discard 3rd row and column.</span>
	cov<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">0.3f</span><span class="token punctuation">;</span>
	cov<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">0.3f</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token keyword">float</span><span class="token punctuation">(</span>cov<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token punctuation">(</span>cov<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token punctuation">(</span>cov<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="_2d协方差矩阵求逆"><a href="#_2d协方差矩阵求逆" class="header-anchor">#</a> 2D协方差矩阵求逆</h3> <p>求坐标<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold-italic">x</mi></mrow><annotation encoding="application/x-tex">\bm x</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.44444em;vertical-align:0em;"></span><span class="mord"><span class="mord boldsymbol">x</span></span></span></span></span>上的高斯函数值<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>G</mi><mo stretchy="false">(</mo><mi mathvariant="bold-italic">x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">G(\bm x)</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">G</span><span class="mopen">(</span><span class="mord"><span class="mord boldsymbol">x</span></span><span class="mclose">)</span></span></span></span>公式来自3DGS原论文：</p> <p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>G</mi><mo stretchy="false">(</mo><mi mathvariant="bold-italic">x</mi><mo stretchy="false">)</mo><mo>=</mo><msup><mi>e</mi><mrow><mo>−</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><msup><mi mathvariant="bold-italic">x</mi><mi>T</mi></msup><msup><mi mathvariant="normal">Σ</mi><mrow><mo>−</mo><mn>1</mn></mrow></msup><mi mathvariant="bold-italic">x</mi></mrow></msup></mrow><annotation encoding="application/x-tex">G(\bm x)=e^{-\frac{1}{2}\bm x^T\Sigma^{-1}\bm x}
</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">G</span><span class="mopen">(</span><span class="mord"><span class="mord boldsymbol">x</span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.056365em;vertical-align:0em;"></span><span class="mord"><span class="mord mathdefault">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.056365em;"><span style="top:-3.4130000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight"><span class="mopen nulldelimiter sizing reset-size3 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8443142857142858em;"><span style="top:-2.656em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span style="top:-3.2255000000000003em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line mtight" style="border-bottom-width:0.049em;"></span></span><span style="top:-3.384em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.344em;"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size3 size6"></span></span><span class="mord mtight"><span class="mord mtight"><span class="mord boldsymbol mtight">x</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9190928571428572em;"><span style="top:-2.931em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class="mord mtight"><span class="mord mtight">Σ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913142857142857em;"><span style="top:-2.931em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mord mtight"><span class="mord boldsymbol mtight">x</span></span></span></span></span></span></span></span></span></span></span></span></span></span></p> <p>所以为了后面渲染过程方便计算这里先算出了<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="normal">Σ</mi><mrow><mo>−</mo><mn>1</mn></mrow></msup></mrow><annotation encoding="application/x-tex">\Sigma^{-1}</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord">Σ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span></span>保存为<code>conic</code>，称为“锥体(conic)参数”（高斯球投影为实心椭圆，其边界为圆锥曲线）：</p> <p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable rowspacing="0.24999999999999992em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mi mathvariant="normal">Σ</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.15999999999999992em" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi>a</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi>b</mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi>b</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi>c</mi></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msup><mi mathvariant="normal">Σ</mi><mrow><mo>−</mo><mn>1</mn></mrow></msup></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mfrac><msup><mi mathvariant="normal">Σ</mi><mo>∗</mo></msup><mrow><mi mathvariant="normal">∣</mi><mi mathvariant="normal">Σ</mi><mi mathvariant="normal">∣</mi></mrow></mfrac><mo>=</mo><mfrac><mrow><mo fence="true">[</mo><mtable rowspacing="0.15999999999999992em" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi>c</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>−</mo><mi>b</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>−</mo><mi>b</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi>a</mi></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mrow><mi>a</mi><mi>c</mi><mo>−</mo><msup><mi>b</mi><mn>2</mn></msup></mrow></mfrac></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}
\Sigma&amp;=\left[\begin{matrix}a&amp;b\\b&amp;c\end{matrix}\right]\\
\Sigma^{-1}&amp;=\frac{\Sigma^*}{|\Sigma|}=\frac{\left[\begin{matrix}c&amp;-b\\-b&amp;a\end{matrix}\right]}{ac-b^2}
\end{aligned}
</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:6.7260599999999995em;vertical-align:-3.1130299999999997em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.6130299999999997em;"><span style="top:-6.953060000000001em;"><span class="pstrut" style="height:4.79003em;"></span><span class="mord"><span class="mord">Σ</span></span></span><span style="top:-2.9130000000000003em;"><span class="pstrut" style="height:4.79003em;"></span><span class="mord"><span class="mord"><span class="mord">Σ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.864108em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.1130299999999997em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.6130299999999997em;"><span style="top:-6.953060000000001em;"><span class="pstrut" style="height:4.79003em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">a</span></span></span><span style="top:-2.4099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">b</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9500000000000004em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">b</span></span></span><span style="top:-2.4099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9500000000000004em;"><span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span></span></span><span style="top:-2.9130000000000003em;"><span class="pstrut" style="height:4.79003em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.365696em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">∣</span><span class="mord">Σ</span><span class="mord">∣</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord">Σ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.688696em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.7900300000000002em;"><span style="top:-2.7640000000000002em;"><span class="pstrut" style="height:3.45em;"></span><span class="mord"><span class="mord mathdefault">a</span><span class="mord mathdefault">c</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault">b</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-3.68em;"><span class="pstrut" style="height:3.45em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-4.790030000000001em;"><span class="pstrut" style="height:3.45em;"></span><span class="mord"><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">c</span></span></span><span style="top:-2.4099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">−</span><span class="mord mathdefault">b</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9500000000000004em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">−</span><span class="mord mathdefault">b</span></span></span><span style="top:-2.4099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9500000000000004em;"><span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7693300000000001em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.1130299999999997em;"><span></span></span></span></span></span></span></span></span></span></span></span></p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>	<span class="token comment">// Invert covariance (EWA algorithm) //求2D协方差矩阵的行列式</span>
	<span class="token keyword">float</span> det <span class="token operator">=</span> <span class="token punctuation">(</span>cov<span class="token punctuation">.</span>x <span class="token operator">*</span> cov<span class="token punctuation">.</span>z <span class="token operator">-</span> cov<span class="token punctuation">.</span>y <span class="token operator">*</span> cov<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//协方差矩阵[abbc]的模ac-b^2</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>det <span class="token operator">==</span> <span class="token number">0.0f</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">//协方差矩阵的模为0说明投影出来椭圆面积为0，退出</span>
	<span class="token keyword">float</span> det_inv <span class="token operator">=</span> <span class="token number">1.f</span> <span class="token operator">/</span> det<span class="token punctuation">;</span> <span class="token comment">//协方差矩阵[abbc]的行列式</span>
	float3 conic <span class="token operator">=</span> <span class="token punctuation">{</span> cov<span class="token punctuation">.</span>z <span class="token operator">*</span> det_inv<span class="token punctuation">,</span> <span class="token operator">-</span>cov<span class="token punctuation">.</span>y <span class="token operator">*</span> det_inv<span class="token punctuation">,</span> cov<span class="token punctuation">.</span>x <span class="token operator">*</span> det_inv <span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">//协方差矩阵[abbc]的逆 = det*(c,-b,a)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="计算高斯球与成像平面上哪些tiles相交"><a href="#计算高斯球与成像平面上哪些tiles相交" class="header-anchor">#</a> 计算高斯球与成像平面上哪些tiles相交</h3> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>	<span class="token comment">// Compute extent in screen space (by finding eigenvalues of</span>
	<span class="token comment">// 2D covariance matrix). Use extent to compute a bounding rectangle</span>
	<span class="token comment">// of screen-space tiles that this Gaussian overlaps with. Quit if</span>
	<span class="token comment">// rectangle covers 0 tiles. </span>
	<span class="token keyword">float</span> mid <span class="token operator">=</span> <span class="token number">0.5f</span> <span class="token operator">*</span> <span class="token punctuation">(</span>cov<span class="token punctuation">.</span>x <span class="token operator">+</span> cov<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">float</span> lambda1 <span class="token operator">=</span> mid <span class="token operator">+</span> <span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0.1f</span><span class="token punctuation">,</span> mid <span class="token operator">*</span> mid <span class="token operator">-</span> det<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">float</span> lambda2 <span class="token operator">=</span> mid <span class="token operator">-</span> <span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0.1f</span><span class="token punctuation">,</span> mid <span class="token operator">*</span> mid <span class="token operator">-</span> det<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">float</span> my_radius <span class="token operator">=</span> <span class="token function">ceil</span><span class="token punctuation">(</span><span class="token number">3.f</span> <span class="token operator">*</span> <span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span>lambda1<span class="token punctuation">,</span> lambda2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//这里的3就是正态分布的3sigma法则，max表明用于算覆盖范围的半径是长轴半径</span>
	float2 point_image <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token function">ndc2Pix</span><span class="token punctuation">(</span>p_proj<span class="token punctuation">.</span>x<span class="token punctuation">,</span> W<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">ndc2Pix</span><span class="token punctuation">(</span>p_proj<span class="token punctuation">.</span>y<span class="token punctuation">,</span> H<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">//ndc坐标转换到像素坐标</span>
	uint2 rect_min<span class="token punctuation">,</span> rect_max<span class="token punctuation">;</span>
	<span class="token function">getRect</span><span class="token punctuation">(</span>point_image<span class="token punctuation">,</span> my_radius<span class="token punctuation">,</span> rect_min<span class="token punctuation">,</span> rect_max<span class="token punctuation">,</span> grid<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//计算高斯球覆盖了哪些tile，返回rect_min, rect_max</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>rect_max<span class="token punctuation">.</span>x <span class="token operator">-</span> rect_min<span class="token punctuation">.</span>x<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>rect_max<span class="token punctuation">.</span>y <span class="token operator">-</span> rect_min<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>其中<code>ndc2Pix</code>把相机ndc坐标系上的坐标转换到像素坐标：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>__forceinline__ __device__ <span class="token keyword">float</span> <span class="token function">ndc2Pix</span><span class="token punctuation">(</span><span class="token keyword">float</span> v<span class="token punctuation">,</span> <span class="token keyword">int</span> S<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>v <span class="token operator">+</span> <span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token operator">*</span> S <span class="token operator">-</span> <span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><code>getRect</code>函数定义如下，可以看出，计算方法是以高斯球中心为中点，边长为长轴半径x2的方形区域的相交区域：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>__forceinline__ __device__ <span class="token keyword">void</span> <span class="token function">getRect</span><span class="token punctuation">(</span><span class="token keyword">const</span> float2 p<span class="token punctuation">,</span> <span class="token keyword">int</span> max_radius<span class="token punctuation">,</span> uint2<span class="token operator">&amp;</span> rect_min<span class="token punctuation">,</span> uint2<span class="token operator">&amp;</span> rect_max<span class="token punctuation">,</span> dim3 grid<span class="token punctuation">)</span> <span class="token comment">//grid是成像平面的范围</span>
<span class="token punctuation">{</span>
	rect_min <span class="token operator">=</span> <span class="token punctuation">{</span>
		<span class="token function">min</span><span class="token punctuation">(</span>grid<span class="token punctuation">.</span>x<span class="token punctuation">,</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x <span class="token operator">-</span> max_radius<span class="token punctuation">)</span> <span class="token operator">/</span> BLOCK_X<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//BLOCK_X=BLOCK_Y=16，所以是16x16为一个tile</span>
		<span class="token function">min</span><span class="token punctuation">(</span>grid<span class="token punctuation">.</span>y<span class="token punctuation">,</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>y <span class="token operator">-</span> max_radius<span class="token punctuation">)</span> <span class="token operator">/</span> BLOCK_Y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
	rect_max <span class="token operator">=</span> <span class="token punctuation">{</span>
		<span class="token function">min</span><span class="token punctuation">(</span>grid<span class="token punctuation">.</span>x<span class="token punctuation">,</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x <span class="token operator">+</span> max_radius <span class="token operator">+</span> BLOCK_X <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> BLOCK_X<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token function">min</span><span class="token punctuation">(</span>grid<span class="token punctuation">.</span>y<span class="token punctuation">,</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>y <span class="token operator">+</span> max_radius <span class="token operator">+</span> BLOCK_Y <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> BLOCK_Y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="从球谐函数系数求投影点颜色"><a href="#从球谐函数系数求投影点颜色" class="header-anchor">#</a> 从球谐函数系数求投影点颜色</h3> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>	<span class="token comment">// If colors have been precomputed, use them, otherwise convert</span>
	<span class="token comment">// spherical harmonics coefficients to RGB color.</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>colors_precomp <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		glm<span class="token operator">::</span>vec3 result <span class="token operator">=</span> <span class="token function">computeColorFromSH</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span> D<span class="token punctuation">,</span> M<span class="token punctuation">,</span> <span class="token punctuation">(</span>glm<span class="token operator">::</span>vec3<span class="token operator">*</span><span class="token punctuation">)</span>orig_points<span class="token punctuation">,</span> <span class="token operator">*</span>cam_pos<span class="token punctuation">,</span> shs<span class="token punctuation">,</span> clamped<span class="token punctuation">)</span><span class="token punctuation">;</span>
		rgb<span class="token punctuation">[</span>idx <span class="token operator">*</span> C <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> result<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
		rgb<span class="token punctuation">[</span>idx <span class="token operator">*</span> C <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> result<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
		rgb<span class="token punctuation">[</span>idx <span class="token operator">*</span> C <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> result<span class="token punctuation">.</span>z<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="记录重要信息"><a href="#记录重要信息" class="header-anchor">#</a> 记录重要信息</h3> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>	<span class="token comment">// Store some useful helper data for the next steps.</span>
	depths<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">=</span> p_view<span class="token punctuation">.</span>z<span class="token punctuation">;</span> <span class="token comment">//该高斯椭球中心距成像平面距离(深度)</span>
	radii<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">=</span> my_radius<span class="token punctuation">;</span> <span class="token comment">//该高斯椭球投影在成像平面上的长轴半径</span>
	points_xy_image<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">=</span> point_image<span class="token punctuation">;</span> <span class="token comment">//该高斯椭球中心在成像平面上的像素坐标</span>
	<span class="token comment">// Inverse 2D covariance and opacity neatly pack into one float4</span>
	conic_opacity<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> conic<span class="token punctuation">.</span>x<span class="token punctuation">,</span> conic<span class="token punctuation">.</span>y<span class="token punctuation">,</span> conic<span class="token punctuation">.</span>z<span class="token punctuation">,</span> opacities<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">//高斯椭球的协方差逆矩阵和透明度放在一起了</span>
	tiles_touched<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>rect_max<span class="token punctuation">.</span>y <span class="token operator">-</span> rect_min<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>rect_max<span class="token punctuation">.</span>x <span class="token operator">-</span> rect_min<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//该高斯椭球与多少个tiles相交</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="深入cudarasterizer-rasterizer-forward（三）高斯球排序"><a href="#深入cudarasterizer-rasterizer-forward（三）高斯球排序" class="header-anchor">#</a> 深入<code>CudaRasterizer::Rasterizer::forward</code>（三）高斯球排序</h2> <p>预处理后的初始化：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>	<span class="token comment">// Compute prefix sum over full list of touched tile counts by Gaussians</span>
	<span class="token comment">// E.g., [2, 3, 0, 2, 1] -&gt; [2, 5, 5, 7, 8]</span>
	<span class="token function">CHECK_CUDA</span><span class="token punctuation">(</span>cub<span class="token operator">::</span>DeviceScan<span class="token operator">::</span><span class="token function">InclusiveSum</span><span class="token punctuation">(</span>geomState<span class="token punctuation">.</span>scanning_space<span class="token punctuation">,</span> geomState<span class="token punctuation">.</span>scan_size<span class="token punctuation">,</span> geomState<span class="token punctuation">.</span>tiles_touched<span class="token punctuation">,</span> geomState<span class="token punctuation">.</span>point_offsets<span class="token punctuation">,</span> P<span class="token punctuation">)</span><span class="token punctuation">,</span> debug<span class="token punctuation">)</span> <span class="token comment">//计算tiles_touched数组的前缀和存到point_offsets中，从后面的代码可以看出，每个高斯椭球都在BinningState都分配了一片显存空间存储与其相交的所有tiles的数据，每个高斯椭球相交的tiles数量都不一样，这里point_offsets就存着每个高斯椭球对应的显存空间起点</span>

	<span class="token comment">// Retrieve total number of Gaussian instances to launch and resize aux buffers</span>
	<span class="token keyword">int</span> num_rendered<span class="token punctuation">;</span>
	<span class="token function">CHECK_CUDA</span><span class="token punctuation">(</span><span class="token function">cudaMemcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>num_rendered<span class="token punctuation">,</span> geomState<span class="token punctuation">.</span>point_offsets <span class="token operator">+</span> P <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cudaMemcpyDeviceToHost<span class="token punctuation">)</span><span class="token punctuation">,</span> debug<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//指针point_offsets+P-1是point_offsets数组(tiles_touched数组的前缀和数组)的最后一个元素的值，也即总共覆盖的tiles数量，把它赋给num_rendered，所以num_rendered就是需要渲染的tiles总量，被多个高斯球覆盖的tiles重复计数</span>

	size_t binning_chunk_size <span class="token operator">=</span> required<span class="token operator">&lt;</span>BinningState<span class="token operator">&gt;</span><span class="token punctuation">(</span>num_rendered<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//计算所需的显存大小</span>
	<span class="token keyword">char</span><span class="token operator">*</span> binning_chunkptr <span class="token operator">=</span> <span class="token function">binningBuffer</span><span class="token punctuation">(</span>binning_chunk_size<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//分配显存块，并返回首地址</span>
	BinningState binningState <span class="token operator">=</span> BinningState<span class="token operator">::</span><span class="token function">fromChunk</span><span class="token punctuation">(</span>binning_chunkptr<span class="token punctuation">,</span> num_rendered<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//将分配的显存块初始化为BinningState，每个高斯椭球都在BinningState都分配了一片显存空间存储与其相交的所有tiles的数据</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="构造排序用的keys"><a href="#构造排序用的keys" class="header-anchor">#</a> 构造排序用的Keys</h3> <p>目前为止，<code>FORWARD::preprocess</code>和前面的初始化中计算了<code>geomState</code>中的各项：高斯椭球中心在成像平面上的像素坐标<code>geomState.means2D</code>、高斯椭球中心距成像平面距离<code>geomState.depths</code>、每个高斯椭球对应的存储相交tiles的显存空间起点<code>geomState.point_offsets</code>，以及高斯椭球投影在成像平面上的长轴半径<code>radii</code>；
<code>binningState</code>里每个高斯椭球都都分配了一片显存空间存储与其相交的所有tiles的数据。
接下来将其放进<code>duplicateWithKeys</code>中初始化key用于排序，每个高斯球一个线程：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>	<span class="token comment">// For each instance to be rendered, produce adequate [ tile | depth ] key </span>
	<span class="token comment">// and corresponding dublicated Gaussian indices to be sorted</span>
	duplicateWithKeys <span class="token operator">&lt;&lt;</span> <span class="token operator">&lt;</span><span class="token punctuation">(</span>P <span class="token operator">+</span> <span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">256</span> <span class="token operator">&gt;&gt;</span> <span class="token operator">&gt;</span> <span class="token punctuation">(</span> <span class="token comment">//这里用到上步InclusiveSum得到的累计高斯球touch的tiles数</span>
		P<span class="token punctuation">,</span>
		geomState<span class="token punctuation">.</span>means2D<span class="token punctuation">,</span>
		geomState<span class="token punctuation">.</span>depths<span class="token punctuation">,</span>
		geomState<span class="token punctuation">.</span>point_offsets<span class="token punctuation">,</span> <span class="token comment">//这里用到上步InclusiveSum得到的累计高斯球touch的tiles数</span>
		binningState<span class="token punctuation">.</span>point_list_keys_unsorted<span class="token punctuation">,</span> <span class="token comment">//存储key (tileID|depth)</span>
		binningState<span class="token punctuation">.</span>point_list_unsorted<span class="token punctuation">,</span> <span class="token comment">// 存储对应的高斯球idx</span>
		radii<span class="token punctuation">,</span> <span class="token comment">//像素平面上高斯圆的半径，最长轴的3倍</span>
		tile_grid<span class="token punctuation">)</span> <span class="token comment">//全图中tile的数量</span>
	<span class="token function">CHECK_CUDA</span><span class="token punctuation">(</span><span class="token punctuation">,</span> debug<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><code>duplicateWithKeys</code>就是将每个高斯椭球深度和相交tiles的编号组合成key放进<code>gaussian_keys_unsorted</code>里、高斯椭球编号放进<code>gaussian_values_unsorted</code>里，其定义如下：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">// Generates one key/value pair for all Gaussian / tile overlaps. </span>
<span class="token comment">// Run once per Gaussian (1:N mapping).</span>
__global__ <span class="token keyword">void</span> <span class="token function">duplicateWithKeys</span><span class="token punctuation">(</span>
	<span class="token keyword">int</span> P<span class="token punctuation">,</span>
	<span class="token keyword">const</span> float2<span class="token operator">*</span> points_xy<span class="token punctuation">,</span>
	<span class="token keyword">const</span> <span class="token keyword">float</span><span class="token operator">*</span> depths<span class="token punctuation">,</span>
	<span class="token keyword">const</span> <span class="token keyword">uint32_t</span><span class="token operator">*</span> offsets<span class="token punctuation">,</span>
	<span class="token keyword">uint64_t</span><span class="token operator">*</span> gaussian_keys_unsorted<span class="token punctuation">,</span>
	<span class="token keyword">uint32_t</span><span class="token operator">*</span> gaussian_values_unsorted<span class="token punctuation">,</span>
	<span class="token keyword">int</span><span class="token operator">*</span> radii<span class="token punctuation">,</span>
	dim3 grid<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">auto</span> idx <span class="token operator">=</span> cg<span class="token operator">::</span><span class="token function">this_grid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thread_rank</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>idx <span class="token operator">&gt;=</span> P<span class="token punctuation">)</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>

	<span class="token comment">// Generate no key/value pair for invisible Gaussians</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>radii<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token comment">// Find this Gaussian's offset in buffer for writing keys/values.</span>
		<span class="token keyword">uint32_t</span> off <span class="token operator">=</span> <span class="token punctuation">(</span>idx <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> offsets<span class="token punctuation">[</span>idx <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		uint2 rect_min<span class="token punctuation">,</span> rect_max<span class="token punctuation">;</span>

		<span class="token function">getRect</span><span class="token punctuation">(</span>points_xy<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">,</span> radii<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">,</span> rect_min<span class="token punctuation">,</span> rect_max<span class="token punctuation">,</span> grid<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// For each tile that the bounding rect overlaps, emit a </span>
		<span class="token comment">// key/value pair. The key is |  tile ID  |      depth      |,</span>
		<span class="token comment">// and the value is the ID of the Gaussian. Sorting the values </span>
		<span class="token comment">// with this key yields Gaussian IDs in a list, such that they</span>
		<span class="token comment">// are first sorted by tile and then by depth. </span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> y <span class="token operator">=</span> rect_min<span class="token punctuation">.</span>y<span class="token punctuation">;</span> y <span class="token operator">&lt;</span> rect_max<span class="token punctuation">.</span>y<span class="token punctuation">;</span> y<span class="token operator">++</span><span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> x <span class="token operator">=</span> rect_min<span class="token punctuation">.</span>x<span class="token punctuation">;</span> x <span class="token operator">&lt;</span> rect_max<span class="token punctuation">.</span>x<span class="token punctuation">;</span> x<span class="token operator">++</span><span class="token punctuation">)</span>
			<span class="token punctuation">{</span>
				<span class="token keyword">uint64_t</span> key <span class="token operator">=</span> y <span class="token operator">*</span> grid<span class="token punctuation">.</span>x <span class="token operator">+</span> x<span class="token punctuation">;</span> <span class="token comment">//key的上半边是tile ID，即tile的xy坐标的组合</span>
				key <span class="token operator">&lt;&lt;=</span> <span class="token number">32</span><span class="token punctuation">;</span> <span class="token comment">//tile ID作为key的上半边</span>
				key <span class="token operator">|=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>depths<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//key的下半边为该高斯球中心的深度</span>
				gaussian_keys_unsorted<span class="token punctuation">[</span>off<span class="token punctuation">]</span> <span class="token operator">=</span> key<span class="token punctuation">;</span> <span class="token comment">//记录key</span>
				gaussian_values_unsorted<span class="token punctuation">[</span>off<span class="token punctuation">]</span> <span class="token operator">=</span> idx<span class="token punctuation">;</span> <span class="token comment">//value值为高斯球编号</span>
				off<span class="token operator">++</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><h3 id="对高斯球进行基数排序"><a href="#对高斯球进行基数排序" class="header-anchor">#</a> 对高斯球进行基数排序</h3> <p>对<code>gaussian_keys_unsorted</code>进行排序，并调整<code>gaussian_values_unsorted</code>里对应的顺序，分别放进<code>point_list_keys</code>和<code>point_list</code>里：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>	<span class="token keyword">int</span> bit <span class="token operator">=</span> <span class="token function">getHigherMsb</span><span class="token punctuation">(</span>tile_grid<span class="token punctuation">.</span>x <span class="token operator">*</span> tile_grid<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//查找最高有效位(most significant bit)，排序算法cub::DeviceRadixSort::SortPairs中需要</span>

	<span class="token comment">// Sort complete list of (duplicated) Gaussian indices by keys</span>
	<span class="token function">CHECK_CUDA</span><span class="token punctuation">(</span>cub<span class="token operator">::</span>DeviceRadixSort<span class="token operator">::</span><span class="token function">SortPairs</span><span class="token punctuation">(</span>
		binningState<span class="token punctuation">.</span>list_sorting_space<span class="token punctuation">,</span>
		binningState<span class="token punctuation">.</span>sorting_size<span class="token punctuation">,</span>
		binningState<span class="token punctuation">.</span>point_list_keys_unsorted<span class="token punctuation">,</span> binningState<span class="token punctuation">.</span>point_list_keys<span class="token punctuation">,</span>
		binningState<span class="token punctuation">.</span>point_list_unsorted<span class="token punctuation">,</span> binningState<span class="token punctuation">.</span>point_list<span class="token punctuation">,</span>
		num_rendered<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span> <span class="token operator">+</span> bit<span class="token punctuation">)</span><span class="token punctuation">,</span> debug<span class="token punctuation">)</span> <span class="token comment">//0, 32 + bit分别是The least-significant 和 most-significant bit index needed for key comparison，是可选的参数，这里应该是因为key是uint64_t很长，指定最高有效位可以减少计算量？</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="计算每个tile要渲染的部分在point-list-keys上的起点和终点"><a href="#计算每个tile要渲染的部分在point-list-keys上的起点和终点" class="header-anchor">#</a> 计算每个tile要渲染的部分在<code>point_list_keys</code>上的起点和终点</h3> <p>每个tile分配两个uint，每个要渲染的key都启动一个<code>identifyTileRanges</code>检查是否是<code>point_list_keys</code>上的tile起点或终点，如果是，将idx写入<code>imgState.ranges</code>：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>	<span class="token function">CHECK_CUDA</span><span class="token punctuation">(</span><span class="token function">cudaMemset</span><span class="token punctuation">(</span>imgState<span class="token punctuation">.</span>ranges<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> tile_grid<span class="token punctuation">.</span>x <span class="token operator">*</span> tile_grid<span class="token punctuation">.</span>y <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>uint2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> debug<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Identify start and end of per-tile workloads in sorted list</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>num_rendered <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
		identifyTileRanges <span class="token operator">&lt;&lt;</span> <span class="token operator">&lt;</span><span class="token punctuation">(</span>num_rendered <span class="token operator">+</span> <span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">256</span> <span class="token operator">&gt;&gt;</span> <span class="token operator">&gt;</span> <span class="token punctuation">(</span>
			num_rendered<span class="token punctuation">,</span>
			binningState<span class="token punctuation">.</span>point_list_keys<span class="token punctuation">,</span>
			imgState<span class="token punctuation">.</span>ranges<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">CHECK_CUDA</span><span class="token punctuation">(</span><span class="token punctuation">,</span> debug<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>其具体的计算过程<code>identifyTileRanges</code>：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">// Check keys to see if it is at the start/end of one tile's range in </span>
<span class="token comment">// the full sorted list. If yes, write start/end of this tile. </span>
<span class="token comment">// Run once per instanced (duplicated) Gaussian ID.</span>
__global__ <span class="token keyword">void</span> <span class="token function">identifyTileRanges</span><span class="token punctuation">(</span><span class="token keyword">int</span> L<span class="token punctuation">,</span> <span class="token keyword">uint64_t</span><span class="token operator">*</span> point_list_keys<span class="token punctuation">,</span> uint2<span class="token operator">*</span> ranges<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">auto</span> idx <span class="token operator">=</span> cg<span class="token operator">::</span><span class="token function">this_grid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thread_rank</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>idx <span class="token operator">&gt;=</span> L<span class="token punctuation">)</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>

	<span class="token comment">// Read tile ID from key. Update start/end of tile range if at limit.</span>
	<span class="token keyword">uint64_t</span> key <span class="token operator">=</span> point_list_keys<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//获取key</span>
	<span class="token keyword">uint32_t</span> currtile <span class="token operator">=</span> key <span class="token operator">&gt;&gt;</span> <span class="token number">32</span><span class="token punctuation">;</span> <span class="token comment">//获取tile编号</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>idx <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
		ranges<span class="token punctuation">[</span>currtile<span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//数组中第一项没有上一个，直接赋0</span>
	<span class="token keyword">else</span>
	<span class="token punctuation">{</span>
		<span class="token keyword">uint32_t</span> prevtile <span class="token operator">=</span> point_list_keys<span class="token punctuation">[</span>idx <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&gt;&gt;</span> <span class="token number">32</span><span class="token punctuation">;</span> <span class="token comment">//获取上一个tile编号</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>currtile <span class="token operator">!=</span> prevtile<span class="token punctuation">)</span> <span class="token comment">//如果上一个tile编号和这一个不一样</span>
		<span class="token punctuation">{</span>
			ranges<span class="token punctuation">[</span>prevtile<span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> idx<span class="token punctuation">;</span> <span class="token comment">//记录range</span>
			ranges<span class="token punctuation">[</span>currtile<span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> idx<span class="token punctuation">;</span> <span class="token comment">//记录range</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>idx <span class="token operator">==</span> L <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
		ranges<span class="token punctuation">[</span>currtile<span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> L<span class="token punctuation">;</span> <span class="token comment">//数组中最后一个不一定和上一个tile编号不一样，直接赋L</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h2 id="深入cudarasterizer-rasterizer-forward（四）渲染过程forward-render"><a href="#深入cudarasterizer-rasterizer-forward（四）渲染过程forward-render" class="header-anchor">#</a> 深入<code>CudaRasterizer::Rasterizer::forward</code>（四）渲染过程<code>FORWARD::render</code></h2> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>	<span class="token comment">// Let each tile blend its range of Gaussians independently in parallel</span>
	<span class="token keyword">const</span> <span class="token keyword">float</span><span class="token operator">*</span> feature_ptr <span class="token operator">=</span> colors_precomp <span class="token operator">!=</span> <span class="token keyword">nullptr</span> <span class="token operator">?</span> colors_precomp <span class="token operator">:</span> geomState<span class="token punctuation">.</span>rgb<span class="token punctuation">;</span>
	<span class="token function">CHECK_CUDA</span><span class="token punctuation">(</span>FORWARD<span class="token operator">::</span><span class="token function">render</span><span class="token punctuation">(</span>
		tile_grid<span class="token punctuation">,</span> block<span class="token punctuation">,</span> <span class="token comment">//tile_grid个tile，每个tile有block个key要渲染</span>
		imgState<span class="token punctuation">.</span>ranges<span class="token punctuation">,</span>
		binningState<span class="token punctuation">.</span>point_list<span class="token punctuation">,</span>
		width<span class="token punctuation">,</span> height<span class="token punctuation">,</span>
		geomState<span class="token punctuation">.</span>means2D<span class="token punctuation">,</span>
		feature_ptr<span class="token punctuation">,</span>
		geomState<span class="token punctuation">.</span>conic_opacity<span class="token punctuation">,</span>
		imgState<span class="token punctuation">.</span>accum_alpha<span class="token punctuation">,</span>
		imgState<span class="token punctuation">.</span>n_contrib<span class="token punctuation">,</span>
		background<span class="token punctuation">,</span>
		out_color<span class="token punctuation">)</span><span class="token punctuation">,</span> debug<span class="token punctuation">)</span>

	<span class="token keyword">return</span> num_rendered<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p><code>FORWARD::render</code>对<code>grid</code>个tile各启动<code>block</code>(16x16x1)个线程，即每个像素一个线程运行<code>renderCUDA</code>：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">void</span> FORWARD<span class="token operator">::</span><span class="token function">render</span><span class="token punctuation">(</span>
	<span class="token keyword">const</span> dim3 grid<span class="token punctuation">,</span> dim3 block<span class="token punctuation">,</span>
	<span class="token keyword">const</span> uint2<span class="token operator">*</span> ranges<span class="token punctuation">,</span>
	<span class="token keyword">const</span> <span class="token keyword">uint32_t</span><span class="token operator">*</span> point_list<span class="token punctuation">,</span>
	<span class="token keyword">int</span> W<span class="token punctuation">,</span> <span class="token keyword">int</span> H<span class="token punctuation">,</span>
	<span class="token keyword">const</span> float2<span class="token operator">*</span> means2D<span class="token punctuation">,</span>
	<span class="token keyword">const</span> <span class="token keyword">float</span><span class="token operator">*</span> colors<span class="token punctuation">,</span>
	<span class="token keyword">const</span> float4<span class="token operator">*</span> conic_opacity<span class="token punctuation">,</span>
	<span class="token keyword">float</span><span class="token operator">*</span> final_T<span class="token punctuation">,</span>
	<span class="token keyword">uint32_t</span><span class="token operator">*</span> n_contrib<span class="token punctuation">,</span>
	<span class="token keyword">const</span> <span class="token keyword">float</span><span class="token operator">*</span> bg_color<span class="token punctuation">,</span>
	<span class="token keyword">float</span><span class="token operator">*</span> out_color<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	renderCUDA<span class="token operator">&lt;</span>NUM_CHANNELS<span class="token operator">&gt;</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">&lt;</span>grid<span class="token punctuation">,</span> block <span class="token operator">&gt;&gt;</span> <span class="token operator">&gt;</span> <span class="token punctuation">(</span>
		ranges<span class="token punctuation">,</span>
		point_list<span class="token punctuation">,</span>
		W<span class="token punctuation">,</span> H<span class="token punctuation">,</span>
		means2D<span class="token punctuation">,</span>
		colors<span class="token punctuation">,</span>
		conic_opacity<span class="token punctuation">,</span>
		final_T<span class="token punctuation">,</span>
		n_contrib<span class="token punctuation">,</span>
		bg_color<span class="token punctuation">,</span>
		out_color<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h2 id="并行渲染函数rendercuda"><a href="#并行渲染函数rendercuda" class="header-anchor">#</a> 并行渲染函数<code>renderCUDA</code></h2> <p>每个像素一个<code>renderCUDA</code>线程：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">// Main rasterization method. Collaboratively works on one tile per</span>
<span class="token comment">// block, each thread treats one pixel. Alternates between fetching </span>
<span class="token comment">// and rasterizing data.</span>
<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">uint32_t</span> CHANNELS<span class="token operator">&gt;</span>
__global__ <span class="token keyword">void</span> <span class="token function">__launch_bounds__</span><span class="token punctuation">(</span>BLOCK_X <span class="token operator">*</span> BLOCK_Y<span class="token punctuation">)</span>
<span class="token function">renderCUDA</span><span class="token punctuation">(</span>
	<span class="token keyword">const</span> uint2<span class="token operator">*</span> __restrict__ ranges<span class="token punctuation">,</span>
	<span class="token keyword">const</span> <span class="token keyword">uint32_t</span><span class="token operator">*</span> __restrict__ point_list<span class="token punctuation">,</span>
	<span class="token keyword">int</span> W<span class="token punctuation">,</span> <span class="token keyword">int</span> H<span class="token punctuation">,</span>
	<span class="token keyword">const</span> float2<span class="token operator">*</span> __restrict__ points_xy_image<span class="token punctuation">,</span>
	<span class="token keyword">const</span> <span class="token keyword">float</span><span class="token operator">*</span> __restrict__ features<span class="token punctuation">,</span>
	<span class="token keyword">const</span> float4<span class="token operator">*</span> __restrict__ conic_opacity<span class="token punctuation">,</span>
	<span class="token keyword">float</span><span class="token operator">*</span> __restrict__ final_T<span class="token punctuation">,</span>
	<span class="token keyword">uint32_t</span><span class="token operator">*</span> __restrict__ n_contrib<span class="token punctuation">,</span>
	<span class="token keyword">const</span> <span class="token keyword">float</span><span class="token operator">*</span> __restrict__ bg_color<span class="token punctuation">,</span>
	<span class="token keyword">float</span><span class="token operator">*</span> __restrict__ out_color<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h3 id="获取当前tile对应的像素range和thread对应的像素坐标"><a href="#获取当前tile对应的像素range和thread对应的像素坐标" class="header-anchor">#</a> 获取当前tile对应的像素range和thread对应的像素坐标</h3> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>	<span class="token comment">// Identify current tile and associated min/max pixel range.</span>
	<span class="token keyword">auto</span> block <span class="token operator">=</span> cg<span class="token operator">::</span><span class="token function">this_thread_block</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">uint32_t</span> horizontal_blocks <span class="token operator">=</span> <span class="token punctuation">(</span>W <span class="token operator">+</span> BLOCK_X <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> BLOCK_X<span class="token punctuation">;</span>
	uint2 pix_min <span class="token operator">=</span> <span class="token punctuation">{</span> block<span class="token punctuation">.</span><span class="token function">group_index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>x <span class="token operator">*</span> BLOCK_X<span class="token punctuation">,</span> block<span class="token punctuation">.</span><span class="token function">group_index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>y <span class="token operator">*</span> BLOCK_Y <span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">//该tile覆盖范围的像素坐标</span>
	uint2 pix_max <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token function">min</span><span class="token punctuation">(</span>pix_min<span class="token punctuation">.</span>x <span class="token operator">+</span> BLOCK_X<span class="token punctuation">,</span> W<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">min</span><span class="token punctuation">(</span>pix_min<span class="token punctuation">.</span>y <span class="token operator">+</span> BLOCK_Y <span class="token punctuation">,</span> H<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">//该tile覆盖范围的像素坐标</span>
	uint2 pix <span class="token operator">=</span> <span class="token punctuation">{</span> pix_min<span class="token punctuation">.</span>x <span class="token operator">+</span> block<span class="token punctuation">.</span><span class="token function">thread_index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>x<span class="token punctuation">,</span> pix_min<span class="token punctuation">.</span>y <span class="token operator">+</span> block<span class="token punctuation">.</span><span class="token function">thread_index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>y <span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">//该thread需要处理的像素的坐标</span>
	<span class="token keyword">uint32_t</span> pix_id <span class="token operator">=</span> W <span class="token operator">*</span> pix<span class="token punctuation">.</span>y <span class="token operator">+</span> pix<span class="token punctuation">.</span>x<span class="token punctuation">;</span> <span class="token comment">//该thread对应的像素编号</span>
	float2 pixf <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>pix<span class="token punctuation">.</span>x<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>pix<span class="token punctuation">.</span>y <span class="token punctuation">}</span><span class="token punctuation">;</span>

	<span class="token comment">// Check if this thread is associated with a valid pixel or outside.</span>
	<span class="token keyword">bool</span> inside <span class="token operator">=</span> pix<span class="token punctuation">.</span>x <span class="token operator">&lt;</span> W<span class="token operator">&amp;&amp;</span> pix<span class="token punctuation">.</span>y <span class="token operator">&lt;</span> H<span class="token punctuation">;</span> <span class="token comment">//是否超出图像区域范围</span>
	<span class="token comment">// Done threads can help with fetching, but don't rasterize</span>
	<span class="token keyword">bool</span> done <span class="token operator">=</span> <span class="token operator">!</span>inside<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="获取当前tile对应的像素range"><a href="#获取当前tile对应的像素range" class="header-anchor">#</a> 获取当前tile对应的像素range</h3> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>	<span class="token comment">// Load start/end range of IDs to process in bit sorted list.</span>
	uint2 range <span class="token operator">=</span> ranges<span class="token punctuation">[</span>block<span class="token punctuation">.</span><span class="token function">group_index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>y <span class="token operator">*</span> horizontal_blocks <span class="token operator">+</span> block<span class="token punctuation">.</span><span class="token function">group_index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>x<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//当前tile在point_list_keys中的范围，包括x下界和y上界</span>
	<span class="token keyword">const</span> <span class="token keyword">int</span> rounds <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>range<span class="token punctuation">.</span>y <span class="token operator">-</span> range<span class="token punctuation">.</span>x <span class="token operator">+</span> BLOCK_SIZE <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> BLOCK_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//当前tile在point_list_keys中的range大小除BLOCK_SIZE，也即把当前线程即要处理的高斯球每BLOCK_SIZE个分一个batch，之后for循环里是一个batch一个batch的处理</span>
	<span class="token keyword">int</span> toDo <span class="token operator">=</span> range<span class="token punctuation">.</span>y <span class="token operator">-</span> range<span class="token punctuation">.</span>x<span class="token punctuation">;</span> <span class="token comment">//当前线程即要处理的高斯球数量</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="渲染前的初始化"><a href="#渲染前的初始化" class="header-anchor">#</a> 渲染前的初始化</h3> <p>初始化block内部用的<code>__shared__</code>数组和thread里用的一下变量：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>	<span class="token comment">// Allocate storage for batches of collectively fetched data.</span>
	__shared__ <span class="token keyword">int</span> collected_id<span class="token punctuation">[</span>BLOCK_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//存储block内各thread处理的高斯球的编号</span>
	__shared__ float2 collected_xy<span class="token punctuation">[</span>BLOCK_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//存储block内各thread处理的高斯球中心在2D平面的投影坐标</span>
	__shared__ float4 collected_conic_opacity<span class="token punctuation">[</span>BLOCK_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//存储block内各thread处理的高斯球的2D协方差逆矩阵和不透明度</span>

	<span class="token comment">// Initialize helper variables</span>
	<span class="token keyword">float</span> T <span class="token operator">=</span> <span class="token number">1.0f</span><span class="token punctuation">;</span> <span class="token comment">//透射率</span>
	<span class="token keyword">uint32_t</span> contributor <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//计算经过了多少高斯</span>
	<span class="token keyword">uint32_t</span> last_contributor <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//存储最终经过的高斯球数量</span>
	<span class="token keyword">float</span> C<span class="token punctuation">[</span>CHANNELS<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">//最后渲染的颜色</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>batch大小为什么等于block中的thread数量<code>BLOCK_SIZE</code>？简言之就是复用<code>BLOCK_SIZE</code>个thread分批读取数据。</p> <p>block(tile)里的每个thread(像素)都要对这个tile中的所有高斯球进行渲染，所以一个thread需要访问上面的<code>collected_*</code>数组里的每一项。
这里最速度的情况是一次把这个tile中的所有高斯球都读进来渲染，<code>collected_*</code>数组长度设置为高斯球的数量。
当然，这种方法占内存太高，本文采用的方法是利用thread进行并行读取，所以才把<code>collected_*</code>数组长度设置为<code>BLOCK_SIZE</code>，这样就是充分利用block中的<code>BLOCK_SIZE</code>个thread，读一批处理一批。</p> <h3 id="for循环处理该像素的每个高斯球"><a href="#for循环处理该像素的每个高斯球" class="header-anchor">#</a> for循环处理该像素的每个高斯球</h3> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>	<span class="token comment">// Iterate over batches until all done or range is complete</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> rounds<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">,</span> toDo <span class="token operator">-=</span> BLOCK_SIZE<span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>这个for循环分两个部分，首先<code>BLOCK_SIZE</code>个thread并行读取一批<code>BLOCK_SIZE</code>个高斯球进<code>collected_*</code>数组里：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>		<span class="token comment">// End if entire block votes that it is done rasterizing</span>
		<span class="token keyword">int</span> num_done <span class="token operator">=</span> <span class="token function">__syncthreads_count</span><span class="token punctuation">(</span>done<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//计算一个block里done为true的数量</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>num_done <span class="token operator">==</span> BLOCK_SIZE<span class="token punctuation">)</span> <span class="token comment">//如果done有BLOCK_SIZE个true，则表明所有批次的高斯球全部处理完成，可以退出</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">//如果一个block里面thread全部完成，则退出循环</span>

		<span class="token comment">// Collectively fetch per-Gaussian data from global to shared</span>
		<span class="token keyword">int</span> progress <span class="token operator">=</span> i <span class="token operator">*</span> BLOCK_SIZE <span class="token operator">+</span> block<span class="token punctuation">.</span><span class="token function">thread_rank</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//thread_rank是当前线程在组内的标号，区间为[0, num_threads)；progress是当前批次应该从第几个高斯球开始读</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>range<span class="token punctuation">.</span>x <span class="token operator">+</span> progress <span class="token operator">&lt;</span> range<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token comment">//如果当前线程有效，即处理的高斯球不越界</span>
		<span class="token punctuation">{</span> <span class="token comment">//读取一批BLOCK_SIZE个高斯球</span>
			<span class="token keyword">int</span> coll_id <span class="token operator">=</span> point_list<span class="token punctuation">[</span>range<span class="token punctuation">.</span>x <span class="token operator">+</span> progress<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//point_list表示与已排序的point_list_keys对应的高斯球编号，coll_id为当前线程处理的高斯球编号</span>
			collected_id<span class="token punctuation">[</span>block<span class="token punctuation">.</span><span class="token function">thread_rank</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> coll_id<span class="token punctuation">;</span> <span class="token comment">//读取待处理的高斯球id</span>
			collected_xy<span class="token punctuation">[</span>block<span class="token punctuation">.</span><span class="token function">thread_rank</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> points_xy_image<span class="token punctuation">[</span>coll_id<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//读取待处理的高斯球中心在像素平面的坐标</span>
			collected_conic_opacity<span class="token punctuation">[</span>block<span class="token punctuation">.</span><span class="token function">thread_rank</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> conic_opacity<span class="token punctuation">[</span>coll_id<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//读取待处理的高斯球2D协方差逆矩阵和不透明度</span>
		<span class="token punctuation">}</span>
		block<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//同步，确保读取全部完成</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>然后每个thread各自处理读进来的<code>BLOCK_SIZE</code>个高斯球：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>		<span class="token comment">// Iterate over current batch</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">!</span>done <span class="token operator">&amp;&amp;</span> j <span class="token operator">&lt;</span> <span class="token function">min</span><span class="token punctuation">(</span>BLOCK_SIZE<span class="token punctuation">,</span> toDo<span class="token punctuation">)</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token comment">//block(tile)里的每个thread(像素)都要对这个tile中的所有高斯球进行渲染</span>
		<span class="token punctuation">{</span>
			<span class="token comment">// Keep track of current position in range</span>
			contributor<span class="token operator">++</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="求高斯函数值中的指数部分"><a href="#求高斯函数值中的指数部分" class="header-anchor">#</a> 求高斯函数值<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>G</mi><mo stretchy="false">(</mo><mi mathvariant="bold-italic">x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">G(\bm x)</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">G</span><span class="mopen">(</span><span class="mord"><span class="mord boldsymbol">x</span></span><span class="mclose">)</span></span></span></span>中的指数部分</h4> <p>求高斯函数值<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>G</mi><mo stretchy="false">(</mo><mi mathvariant="bold-italic">x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">G(\bm x)</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">G</span><span class="mopen">(</span><span class="mord"><span class="mord boldsymbol">x</span></span><span class="mclose">)</span></span></span></span>公式来自3DGS原论文：</p> <p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>G</mi><mo stretchy="false">(</mo><mi mathvariant="bold-italic">x</mi><mo stretchy="false">)</mo><mo>=</mo><msup><mi>e</mi><mrow><mo>−</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><msup><mi mathvariant="bold-italic">x</mi><mi>T</mi></msup><msup><mi mathvariant="normal">Σ</mi><mrow><mo>−</mo><mn>1</mn></mrow></msup><mi mathvariant="bold-italic">x</mi></mrow></msup></mrow><annotation encoding="application/x-tex">G(\bm x)=e^{-\frac{1}{2}\bm x^T\Sigma^{-1}\bm x}
</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">G</span><span class="mopen">(</span><span class="mord"><span class="mord boldsymbol">x</span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.056365em;vertical-align:0em;"></span><span class="mord"><span class="mord mathdefault">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.056365em;"><span style="top:-3.4130000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight"><span class="mopen nulldelimiter sizing reset-size3 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8443142857142858em;"><span style="top:-2.656em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span style="top:-3.2255000000000003em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line mtight" style="border-bottom-width:0.049em;"></span></span><span style="top:-3.384em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.344em;"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size3 size6"></span></span><span class="mord mtight"><span class="mord mtight"><span class="mord boldsymbol mtight">x</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9190928571428572em;"><span style="top:-2.931em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class="mord mtight"><span class="mord mtight">Σ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913142857142857em;"><span style="top:-2.931em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mord mtight"><span class="mord boldsymbol mtight">x</span></span></span></span></span></span></span></span></span></span></span></span></span></span></p> <p>其中的指数部分展开一下就是：</p> <p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable rowspacing="0.24999999999999992em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mo>−</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><msup><mi mathvariant="bold-italic">x</mi><mi>T</mi></msup><msup><mi mathvariant="normal">Σ</mi><mrow><mo>−</mo><mn>1</mn></mrow></msup><mi mathvariant="bold-italic">x</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mo>−</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><mrow><mo fence="true">[</mo><mtable rowspacing="0.15999999999999992em" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi mathvariant="normal">Δ</mi><mi>x</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi mathvariant="normal">Δ</mi><mi>y</mi></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mrow><mo fence="true">[</mo><mtable rowspacing="0.15999999999999992em" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi>A</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi>B</mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi>B</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi>C</mi></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mrow><mo fence="true">[</mo><mtable rowspacing="0.15999999999999992em" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi mathvariant="normal">Δ</mi><mi>x</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi mathvariant="normal">Δ</mi><mi>y</mi></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mo>−</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><mi>A</mi><mi mathvariant="normal">Δ</mi><msup><mi>x</mi><mn>2</mn></msup><mo>−</mo><mi>B</mi><mi mathvariant="normal">Δ</mi><mi>x</mi><mi mathvariant="normal">Δ</mi><mi>y</mi><mo>−</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><mi>C</mi><mi mathvariant="normal">Δ</mi><msup><mi>y</mi><mn>2</mn></msup></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}
-\frac{1}{2}\bm x^T\Sigma^{-1}\bm x&amp;=-\frac{1}{2}\left[\begin{matrix}\Delta x&amp;\Delta y\end{matrix}\right]\left[\begin{matrix}A&amp;B\\B&amp;C\end{matrix}\right]\left[\begin{matrix}\Delta x\\\Delta y\end{matrix}\right]\\
&amp;=-\frac{1}{2}A\Delta x^2 -B\Delta x \Delta y -\frac{1}{2}C\Delta y^2
\end{aligned}</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:5.00747em;vertical-align:-2.253735em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.753735em;"><span style="top:-4.753735000000001em;"><span class="pstrut" style="height:3.45em;"></span><span class="mord"><span class="mord">−</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="mord"><span class="mord boldsymbol">x</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913309999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class="mord"><span class="mord">Σ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.864108em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mord"><span class="mord boldsymbol">x</span></span></span></span><span style="top:-2.1822650000000006em;"><span class="pstrut" style="height:3.45em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.253735em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.753735em;"><span style="top:-4.753735000000001em;"><span class="pstrut" style="height:3.45em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord">−</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size1">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8500000000000001em;"><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">Δ</span><span class="mord mathdefault">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.35000000000000003em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8500000000000001em;"><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">Δ</span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.35000000000000003em;"><span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size1">]</span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">A</span></span></span><span style="top:-2.4099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05017em;">B</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9500000000000004em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05017em;">B</span></span></span><span style="top:-2.4099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9500000000000004em;"><span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">Δ</span><span class="mord mathdefault">x</span></span></span><span style="top:-2.4099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">Δ</span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9500000000000004em;"><span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span></span></span><span style="top:-2.1822650000000006em;"><span class="pstrut" style="height:3.45em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord">−</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord mathdefault">A</span><span class="mord">Δ</span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.05017em;">B</span><span class="mord">Δ</span><span class="mord mathdefault">x</span><span class="mord">Δ</span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mord">Δ</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.253735em;"><span></span></span></span></span></span></span></span></span></span></span></span></p> <p>其中，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi mathvariant="normal">Δ</mi><mi>x</mi><mo separator="true">,</mo><mi mathvariant="normal">Δ</mi><mi>y</mi><msup><mo stretchy="false">)</mo><mi>T</mi></msup><mo>=</mo><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo separator="true">,</mo><msub><mi>y</mi><mi>i</mi></msub><msup><mo stretchy="false">)</mo><mi>T</mi></msup><mo>−</mo><mo stretchy="false">(</mo><msub><mi>x</mi><mtext>pixel</mtext></msub><mo separator="true">,</mo><msub><mi>y</mi><mtext>pixel</mtext></msub><msup><mo stretchy="false">)</mo><mi>T</mi></msup></mrow><annotation encoding="application/x-tex">(\Delta x, \Delta y)^T=(x_i, y_i)^T-(x_{\text{pixel}}, y_{\text{pixel}})^T</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:1.0913309999999998em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">Δ</span><span class="mord mathdefault">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">Δ</span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.0913309999999998em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.1274389999999999em;vertical-align:-0.286108em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">pixel</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">pixel</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span>为高斯球在成像平面上投影的高斯椭圆中心<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo separator="true">,</mo><msub><mi>y</mi><mi>i</mi></msub><msup><mo stretchy="false">)</mo><mi>T</mi></msup></mrow><annotation encoding="application/x-tex">(x_i, y_i)^T</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:1.0913309999999998em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span>到当前像素位置<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msub><mi>x</mi><mtext>pixel</mtext></msub><mo separator="true">,</mo><msub><mi>y</mi><mtext>pixel</mtext></msub><msup><mo stretchy="false">)</mo><mi>T</mi></msup></mrow><annotation encoding="application/x-tex">(x_{\text{pixel}}, y_{\text{pixel}})^T</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:1.1274389999999999em;vertical-align:-0.286108em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">pixel</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">pixel</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span>的向量。</p> <p>对应代码中的<code>float power = -0.5f * (con_o.x * d.x * d.x + con_o.z * d.y * d.y) - con_o.y * d.x * d.y;</code>：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>			<span class="token comment">// Resample using conic matrix (cf. &quot;Surface </span>
			<span class="token comment">// Splatting&quot; by Zwicker et al., 2001)</span>
			float2 xy <span class="token operator">=</span> collected_xy<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//高斯球中心在像素平面的坐标</span>
			float2 d <span class="token operator">=</span> <span class="token punctuation">{</span> xy<span class="token punctuation">.</span>x <span class="token operator">-</span> pixf<span class="token punctuation">.</span>x<span class="token punctuation">,</span> xy<span class="token punctuation">.</span>y <span class="token operator">-</span> pixf<span class="token punctuation">.</span>y <span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">//当前像素和高斯球中心的相对位置</span>
			float4 con_o <span class="token operator">=</span> collected_conic_opacity<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//高斯球2D协方差逆矩阵和不透明度</span>
			<span class="token keyword">float</span> power <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">0.5f</span> <span class="token operator">*</span> <span class="token punctuation">(</span>con_o<span class="token punctuation">.</span>x <span class="token operator">*</span> d<span class="token punctuation">.</span>x <span class="token operator">*</span> d<span class="token punctuation">.</span>x <span class="token operator">+</span> con_o<span class="token punctuation">.</span>z <span class="token operator">*</span> d<span class="token punctuation">.</span>y <span class="token operator">*</span> d<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token operator">-</span> con_o<span class="token punctuation">.</span>y <span class="token operator">*</span> d<span class="token punctuation">.</span>x <span class="token operator">*</span> d<span class="token punctuation">.</span>y<span class="token punctuation">;</span> <span class="token comment">//通过相对位置、高斯球2D协方差逆矩阵计算高斯分布的指数部分</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>power <span class="token operator">&gt;</span> <span class="token number">0.0f</span><span class="token punctuation">)</span>
				<span class="token keyword">continue</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h4 id="alpha-blending"><a href="#alpha-blending" class="header-anchor">#</a> alpha-blending</h4> <p>alpha-blending算法计算的当前像素颜色<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi></mrow><annotation encoding="application/x-tex">C</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span></span></span></span>由高斯球<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathdefault">i</span></span></span></span>的颜色<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>C</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">C_i</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>和透明度参数<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="normal">A</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\Alpha_i</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord"><span class="mord mathrm">A</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>按深度顺序由近及远混合而成，并最后加上背景颜色<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>C</mi><mrow><mi>b</mi><mi>g</mi></mrow></msub></mrow><annotation encoding="application/x-tex">C_{bg}</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">b</span><span class="mord mathdefault mtight" style="margin-right:0.03588em;">g</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>：</p> <p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable rowspacing="0.24999999999999992em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msub><mi>α</mi><mi>k</mi></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><msub><mi mathvariant="normal">A</mi><mi>k</mi></msub><mi>G</mi><mo stretchy="false">(</mo><msub><mi mathvariant="bold-italic">x</mi><mi>k</mi></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msub><mi>T</mi><mi>j</mi></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><munderover><mo>∏</mo><mrow><mi>k</mi><mo>=</mo><mn>1</mn></mrow><mrow><mi>j</mi><mo>−</mo><mn>1</mn></mrow></munderover><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><msub><mi>α</mi><mi>k</mi></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mi>C</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><msub><mi>T</mi><mrow><mi>N</mi><mo>+</mo><mn>1</mn></mrow></msub><mo>⋅</mo><msub><mi>C</mi><mrow><mi>b</mi><mi>g</mi></mrow></msub><mo>+</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>N</mi></munderover><msub><mi>T</mi><mi>i</mi></msub><mo>⋅</mo><msub><mi>α</mi><mi>i</mi></msub><mo>⋅</mo><msub><mi>C</mi><mi>i</mi></msub></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}
\alpha_k&amp;=\Alpha_kG(\bm x_k)\\
T_j&amp;=\prod_{k=1}^{j-1} (1 - \alpha_k)\\
C&amp;=T_{N+1}\cdot C_{bg}+\sum_{i=1}^{N}T_{i}\cdot\alpha_{i}\cdot C_{i}
\end{aligned}</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:8.366895000000001em;vertical-align:-3.9334475000000007em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:4.433447500000001em;"><span style="top:-7.452224500000001em;"><span class="pstrut" style="height:3.858777em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-4.9334475em;"><span class="pstrut" style="height:3.858777em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span><span style="top:-1.5029984999999992em;"><span class="pstrut" style="height:3.858777em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.9334475000000007em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:4.433447500000001em;"><span style="top:-7.452224500000001em;"><span class="pstrut" style="height:3.858777em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mord"><span class="mord mathrm">A</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathdefault">G</span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord boldsymbol">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-4.9334475em;"><span class="pstrut" style="height:3.858777em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8587770000000001em;"><span style="top:-1.8478869999999998em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.0500049999999996em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∏</span></span></span><span style="top:-4.347113em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.302113em;"><span></span></span></span></span></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-1.5029984999999992em;"><span class="pstrut" style="height:3.858777em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.328331em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.10903em;">N</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.208331em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">b</span><span class="mord mathdefault mtight" style="margin-right:0.03588em;">g</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283360000000002em;"><span style="top:-1.872331em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.050005em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3000050000000005em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.10903em;">N</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.277669em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.9334475000000007em;"><span></span></span></span></span></span></span></span></span></span></span></span></p> <p>对应代码中的<code>float alpha = min(0.99f, con_o.w * exp(power));</code>、<code>float test_T = T * (1 - alpha)</code>、<code>C[ch] += features[collected_id[j] * CHANNELS + ch] * alpha * T;</code>、<code>out_color[ch * H * W + pix_id] = C[ch] + T * bg_color[ch];</code>：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>			<span class="token comment">// Eq. (2) from 3D Gaussian splatting paper.</span>
			<span class="token comment">// Obtain alpha by multiplying with Gaussian opacity</span>
			<span class="token comment">// and its exponential falloff from mean.</span>
			<span class="token comment">// Avoid numerical instabilities (see paper appendix). </span>
			<span class="token keyword">float</span> alpha <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span><span class="token number">0.99f</span><span class="token punctuation">,</span> con_o<span class="token punctuation">.</span>w <span class="token operator">*</span> <span class="token function">exp</span><span class="token punctuation">(</span>power<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//通过高斯分布的指数部分和不透明度计算alpha值</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>alpha <span class="token operator">&lt;</span> <span class="token number">1.0f</span> <span class="token operator">/</span> <span class="token number">255.0f</span><span class="token punctuation">)</span> <span class="token comment">//alpha值太低的高斯球不渲染</span>
				<span class="token keyword">continue</span><span class="token punctuation">;</span>
			<span class="token keyword">float</span> test_T <span class="token operator">=</span> T <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> alpha<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//由alpha值计算透射率</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>test_T <span class="token operator">&lt;</span> <span class="token number">0.0001f</span><span class="token punctuation">)</span> <span class="token comment">//透射率太低表明前几个高斯球已经遮住了这个像素，则该像素渲染结束</span>
			<span class="token punctuation">{</span>
				done <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
				<span class="token keyword">continue</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			<span class="token comment">// Eq. (3) from 3D Gaussian splatting paper.</span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> ch <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> ch <span class="token operator">&lt;</span> CHANNELS<span class="token punctuation">;</span> ch<span class="token operator">++</span><span class="token punctuation">)</span>
				C<span class="token punctuation">[</span>ch<span class="token punctuation">]</span> <span class="token operator">+=</span> features<span class="token punctuation">[</span>collected_id<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">*</span> CHANNELS <span class="token operator">+</span> ch<span class="token punctuation">]</span> <span class="token operator">*</span> alpha <span class="token operator">*</span> T<span class="token punctuation">;</span> <span class="token comment">//alpha-blending混合颜色</span>

			T <span class="token operator">=</span> test_T<span class="token punctuation">;</span> <span class="token comment">//记录透射率</span>

			<span class="token comment">// Keep track of last range entry to update this</span>
			<span class="token comment">// pixel.</span>
			last_contributor <span class="token operator">=</span> contributor<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// All threads that treat valid pixel write out their final</span>
	<span class="token comment">// rendering data to the frame and auxiliary buffers.</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>inside<span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		final_T<span class="token punctuation">[</span>pix_id<span class="token punctuation">]</span> <span class="token operator">=</span> T<span class="token punctuation">;</span> <span class="token comment">//记录最终的透射率</span>
		n_contrib<span class="token punctuation">[</span>pix_id<span class="token punctuation">]</span> <span class="token operator">=</span> last_contributor<span class="token punctuation">;</span> <span class="token comment">//记录经过几个高斯球才被遮挡</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> ch <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> ch <span class="token operator">&lt;</span> CHANNELS<span class="token punctuation">;</span> ch<span class="token operator">++</span><span class="token punctuation">)</span>
			out_color<span class="token punctuation">[</span>ch <span class="token operator">*</span> H <span class="token operator">*</span> W <span class="token operator">+</span> pix_id<span class="token punctuation">]</span> <span class="token operator">=</span> C<span class="token punctuation">[</span>ch<span class="token punctuation">]</span> <span class="token operator">+</span> T <span class="token operator">*</span> bg_color<span class="token punctuation">[</span>ch<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//记录颜色</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div></div> <footer class="page-edit" style="display:none;"><div class="edit-link"><a href="https://github.com/yindaheng98/Notebook/edit/master/学习笔记/图形学/3D高斯代码解析.md" target="_blank" rel="noopener noreferrer">帮助我们改善此页面！</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">创建于: </span> <span class="time">2024-10-09 21:55:30</span></div> <br> <div class="last-updated"><span class="prefix">更新于: </span> <span class="time">2024-11-24 18:43:09</span></div></footer> <!----> <!----></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-44bd5a18 data-v-44bd5a18><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-44bd5a18><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-44bd5a18></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-44bd5a18></path></svg></div></div></div>
    <script src="/assets/js/app.1c89d7eb.js" defer></script><script src="/assets/js/3.63b8c0eb.js" defer></script><script src="/assets/js/1.be3d2055.js" defer></script><script src="/assets/js/165.4001e6a3.js" defer></script>
  </body>
</html>
