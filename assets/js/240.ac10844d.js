(window.webpackJsonp=window.webpackJsonp||[]).push([[240],{916:function(s,a,t){"use strict";t.r(a);var n=t(4),e=Object(n.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h2",{attrs:{id:"网络配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#网络配置"}},[s._v("#")]),s._v(" 网络配置")]),s._v(" "),t("p",[s._v("初始状态：")]),s._v(" "),t("ul",[t("li",[s._v("计算中心有两个网关：\n"),t("ul",[t("li",[s._v("内网网关"),t("code",[s._v("172.22.31.254")]),s._v("，只能上校园网")]),s._v(" "),t("li",[s._v("公网关"),t("code",[s._v("172.22.5.255")]),s._v("，只能上公网")])])]),s._v(" "),t("li",[s._v("虚拟机默认网关为内网网关"),t("code",[s._v("172.22.31.254")])])]),s._v(" "),t("p",[s._v("目标状态：")]),s._v(" "),t("ul",[t("li",[s._v("既能上公网又能上校园网")])]),s._v(" "),t("p",[s._v("宿舍DHCP得到的IP地址为"),t("code",[s._v("10.208.XXX.XXX")]),s._v("，实验室DHCP得到的IP地址为"),t("code",[s._v("10.201.XXX.XXX")]),s._v("，"),t("code",[s._v("201=11001001")]),s._v("、"),t("code",[s._v("208=11010000")]),s._v("。于是推测校园网IP范围至少是"),t("code",[s._v("10.192.0.0/11")]),s._v("，至多是"),t("code",[s._v("10.192.0.0/8")]),s._v("。")]),s._v(" "),t("p",[s._v("于是，添加路由：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("route "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" -net "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.0")]),s._v(".0.0/8 gw "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.22")]),s._v(".31.254\nroute "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" default gw "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.22")]),s._v(".5.255\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("测试内网和外网均可ping通，表明路由正确。")]),s._v(" "),t("p",[s._v("需要将上述路由添加为永久配置。网上查到的资料都是要改"),t("code",[s._v("/etc/network/interfaces")]),s._v("里的配置，这种配置方法还要指定网卡。我只想要添加两个路由而已，用指令配置明明就不需要指定网卡，不喜。暂时没找到合适的配置文件，所以我把上面那两条指令直接加了个脚本在"),t("code",[s._v("/etc/ppp/ip-up.d/")]),s._v("。")]),s._v(" "),t("h2",{attrs:{id:"内网穿透"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#内网穿透"}},[s._v("#")]),s._v(" 内网穿透")]),s._v(" "),t("p",[s._v("首先尝试最基础的FRP方案：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("FRP_URL")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("https://github.com/fatedier/frp/releases/download/v0.34.3/frp_0.34.3_linux_amd64.tar.gz\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("PROXY")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("http://10.201.224.251:10801\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$FRP_URL")]),s._v(" -e "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("HTTP_PROXY")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$PROXY")]),s._v(" -e "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("HTTPS_PROXY")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$PROXY")]),s._v(" -O ~/frp.tar.gz "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" -p /etc/frp "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("tar")]),s._v(" -zxvf ~/frp.tar.gz -C /etc/frp --strip-components"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" -f ~/frp.tar.gz\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /etc/frp/frpc.ini "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("EOF\n[common]\nserver_addr = 10.201.224.251\nserver_port = 7000\nlog_level = debug\n\n[Local]\ntype = tcp\nlocal_ip = localhost\nlocal_port = 22\nremote_port = 22\n\n[Vino]\ntype = tcp\nlocal_ip = localhost\nlocal_port = 5900\nremote_port = 5900\nEOF")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /etc/systemd/system/frpc.service "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("EOF\n[Unit]\nDescription=Frp Client Service\nAfter=network.target\n\n[Service]\nType=simple\nUser=nobody\nRestart=on-failure\nRestartSec=5s\nExecStart=/etc/frp/frpc -c /etc/frp/frpc.ini\nExecReload=/etc/frp/frpc reload -c /etc/frp/frpc.ini\n\n[Install]\nWantedBy=multi-user.target\nEOF")]),s._v("\nsystemctl "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("enable")]),s._v(" frpc.service "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" systemctl start frpc.service "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" systemctl status frpc.service\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br")])]),t("p",[s._v("报错："),t("code",[s._v("Accept new mux stream error: EOF")]),s._v("，无法连接，遂放弃")]),s._v(" "),t("p",[s._v("改用SSH隧道方案：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" -NR "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0:2222:localhost:22 yin@10.201.224.251\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("在"),t("code",[s._v("sshd")]),s._v("主机上登录：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" root@localhost -p "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2222")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("发现可以登录，但在同样网络环境下的另一台主机上登录：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" root@192.168.1.11 -p "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2222")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("发现不能登录，"),t("code",[s._v("lsof")]),s._v("发现"),t("code",[s._v("sshd")]),s._v("主机只监听了"),t("code",[s._v("localhost")]),s._v("，把"),t("code",[s._v("0.0.0.0")]),s._v("换成"),t("code",[s._v("*")]),s._v("或者加上"),t("code",[s._v("-g")]),s._v("均无效。迫不得已，只能在"),t("code",[s._v("sshd")]),s._v("主机上再加一层FRP：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("FRP_URL")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("https://github.com/fatedier/frp/releases/download/v0.34.3/frp_0.34.3_linux_amd64.tar.gz\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("PROXY")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("http://10.201.224.251:10801\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$FRP_URL")]),s._v(" -e "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("HTTP_PROXY")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$PROXY")]),s._v(" -e "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("HTTPS_PROXY")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$PROXY")]),s._v(" -O ~/frp.tar.gz "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" -p /etc/frp "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("tar")]),s._v(" -zxvf ~/frp.tar.gz -C /etc/frp --strip-components"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" -f ~/frp.tar.gz\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /etc/frp/frpc.ini "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("EOF\n[common]\nserver_addr = 10.201.224.251\nserver_port = 7000\nlog_level = debug\n\n[Local]\ntype = tcp\nlocal_ip = localhost\nlocal_port = 2222\nremote_port = 2222\nEOF")]),s._v("\n/etc/frp/frpc -c /etc/frp/frpc.ini\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br")])]),t("p",[s._v("好了终于能连上ssh了，可喜可贺。接下来用同样的方法把远程桌面也加入转发。")]),s._v(" "),t("p",[s._v("在"),t("code",[s._v("sshd")]),s._v("主机：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("FRP_URL")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("https://github.com/fatedier/frp/releases/download/v0.34.3/frp_0.34.3_linux_amd64.tar.gz\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("PROXY")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("http://10.201.224.251:10801\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$FRP_URL")]),s._v(" -e "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("HTTP_PROXY")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$PROXY")]),s._v(" -e "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("HTTPS_PROXY")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$PROXY")]),s._v(" -O ~/frp.tar.gz "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" -p /etc/frp "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("tar")]),s._v(" -zxvf ~/frp.tar.gz -C /etc/frp --strip-components"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" -f ~/frp.tar.gz\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /etc/frp/frpc.ini "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("EOF\n[common]\nserver_addr = 10.201.224.251\nserver_port = 7000\nlog_level = debug\n\n[Local]\ntype = tcp\nlocal_ip = localhost\nlocal_port = 2222\nremote_port = 2222\n\n[Local]\ntype = tcp\nlocal_ip = localhost\nlocal_port = 2259\nremote_port = 2259\nEOF")]),s._v("\n/etc/frp/frpc -c /etc/frp/frpc.ini\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br")])]),t("p",[s._v("在虚拟机：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" -fNR "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0:2222:localhost:22 yin@10.201.224.251\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" -fNR "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0:2259:localhost:5900 yin@10.201.224.251\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("搞定。")])])}),[],!1,null,null,null);a.default=e.exports}}]);