(window.webpackJsonp=window.webpackJsonp||[]).push([[38],{443:function(s,t,a){s.exports=a.p+"assets/img/vpx_codec_vp9_dx.1dc40e7b.png"},591:function(s,t,a){s.exports=a.p+"assets/img/vp9_get_raw_frame.404251a5.png"},969:function(s,t,a){"use strict";a.r(t);var e=a(4),n=Object(e.a)({},(function(){var s=this,t=s.$createElement,e=s._self._c||t;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("p",[s._v("前置知识：先学会最外层的API")]),s._v(" "),e("ul",[e("li",[e("RouterLink",{attrs:{to:"/视频编解码/libvpx-simple_decoder.html"}},[s._v("《"),e("code",[s._v("libvpx")]),s._v("的使用方法简析 - simple_decoder.c》")])],1),s._v(" "),e("li",[e("RouterLink",{attrs:{to:"/视频编解码/libvpx-simple_encoder.html"}},[s._v("《"),e("code",[s._v("libvpx")]),s._v("的使用方法简析 - simple_encoder.c》")])],1)]),s._v(" "),e("p",[s._v("本文将深入一点点找到内部的编解码函数的调用过程。")]),s._v(" "),e("p",[s._v("在"),e("RouterLink",{attrs:{to:"/视频编解码/libvpx-simple_decoder.html"}},[s._v("《"),e("code",[s._v("libvpx")]),s._v("的使用方法简析 - simple_decoder.c》")]),s._v("我们了解到解码过程是调用两个API函数"),e("code",[s._v("vpx_codec_decode")]),s._v("和"),e("code",[s._v("vpx_codec_get_frame")]),s._v("，也知道了这两个函数核心也只是在调用"),e("code",[s._v("vpx_codec_iface")]),s._v("里的"),e("code",[s._v("dec.decode")]),s._v("和"),e("code",[s._v("dec.get_frame")]),s._v("。")],1),s._v(" "),e("p",[s._v("而在"),e("RouterLink",{attrs:{to:"/视频编解码/libvpx-simple_encoder.html"}},[s._v("《"),e("code",[s._v("libvpx")]),s._v("的使用方法简析 - simple_encoder.c》")]),s._v("我们也了解到编码过程也是调用两个API函数"),e("code",[s._v("vpx_codec_encode")]),s._v("和"),e("code",[s._v("vpx_codec_get_cx_data")]),s._v("，而这两个函数也是调用的"),e("code",[s._v("vpx_codec_iface")]),s._v("里的接口"),e("code",[s._v("enc.encode")]),s._v("和"),e("code",[s._v("get_cx_data")]),s._v("。")],1),s._v(" "),e("p",[s._v("除此之外，我们还知道"),e("code",[s._v("vpx_codec_iface")]),s._v("的实现分为vp8和vp9两个版本，两个版本都有各自的编码器实现和解码器实现：")]),s._v(" "),e("ul",[e("li",[s._v("vp9解码器实现是"),e("code",[s._v("vpx_codec_vp9_dx")])]),s._v(" "),e("li",[s._v("vp9编码器实现是"),e("code",[s._v("vpx_codec_vp9_cx")])]),s._v(" "),e("li",[s._v("vp8解码器实现是"),e("code",[s._v("vpx_codec_vp8_dx")])]),s._v(" "),e("li",[s._v("vp8编码器实现是"),e("code",[s._v("vpx_codec_vp8_cx")])])]),s._v(" "),e("p",[s._v("显然，这些接口实现里的函数就是具体的编解码过程。这样，我们进一步深入的入口就从这些实现开始。")]),s._v(" "),e("h2",{attrs:{id:"vp9解码"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#vp9解码"}},[s._v("#")]),s._v(" vp9解码")]),s._v(" "),e("p",[s._v("vp9解码器实现是"),e("code",[s._v("vpx_codec_vp9_dx")]),s._v("：")]),s._v(" "),e("p",[e("img",{attrs:{src:a(443),alt:""}})]),s._v(" "),e("p",[s._v("而其中"),e("code",[s._v("decoder_decode")]),s._v("就是"),e("code",[s._v("dec.decode")]),s._v("、"),e("code",[s._v("decoder_get_frame")]),s._v("就是"),e("code",[s._v("dec.get_frame")]),s._v("。")]),s._v(" "),e("h3",{attrs:{id:"decoder-get-frame"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#decoder-get-frame"}},[s._v("#")]),s._v(" "),e("code",[s._v("decoder_get_frame")])]),s._v(" "),e("p",[s._v("先看比较简单的"),e("code",[s._v("decoder_get_frame")]),s._v("：")]),s._v(" "),e("div",{staticClass:"language-c line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("static")]),s._v(" vpx_image_t "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("decoder_get_frame")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("vpx_codec_alg_priv_t "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("ctx"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                                      vpx_codec_iter_t "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("iter"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("函数开始。")]),s._v(" "),e("div",{staticClass:"language-c line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[s._v("  vpx_image_t "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("img "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token constant"}},[s._v("NULL")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("这个是要返回的结果，就是一个帧图像。")]),s._v(" "),e("div",{staticClass:"language-c line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[s._v("  "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Legacy parameter carried over from VP8. Has no effect for VP9 since we")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// always return only 1 frame per decode call.")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("iter"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[s._v("从注释中可以看到这里是一个历史遗留问题，vp9每次"),e("code",[s._v("decoder_get_frame")]),s._v("只会返回一帧，不需要像vp8那样迭代，所以迭代器参数在vp9里没用。")]),s._v(" "),e("div",{staticClass:"language-c line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[s._v("  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ctx"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("pbi "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token constant"}},[s._v("NULL")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("首先必须要有"),e("code",[s._v("ctx->pbi")]),s._v("的存在才能进行下面这些操作。")]),s._v(" "),e("div",{staticClass:"language-c line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[s._v("    YV12_BUFFER_CONFIG sd"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    vp9_ppflags_t flags "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ctx"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("base"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("init_flags "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v(" VPX_CODEC_USE_POSTPROC"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("set_ppflags")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ctx"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("flags"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[s._v("首先设置了"),e("code",[s._v("vp9_ppflags_t")]),s._v("。从这个if里的判断条件看，这应该是控制后处理过程的设置。")]),s._v(" "),e("p",[s._v("关于视频解码的后处理，可以参考ffmpeg对后处理的介绍："),e("a",{attrs:{href:"https://trac.ffmpeg.org/wiki/Postprocessing",target:"_blank",rel:"noopener noreferrer"}},[s._v("《wiki:Postprocessing》"),e("OutboundLink")],1)]),s._v(" "),e("div",{staticClass:"language-c line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[s._v("    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("vp9_get_raw_frame")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ctx"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("pbi"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("sd"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("flags"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("这里的判断就蕴含着本函数的核心处理过程：")]),s._v(" "),e("p",[e("img",{attrs:{src:a(591),alt:""}})]),s._v(" "),e("p",[s._v("可以看到，其实就是把数据从"),e("code",[s._v("pbi->common")]),s._v("里找出来放进"),e("code",[s._v("sd")]),s._v("里，并且如果有定义后处理过程就进行一下后处理。")]),s._v(" "),e("div",{staticClass:"language-c line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[s._v("      VP9_COMMON "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" cm "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("ctx"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("pbi"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("common"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n      RefCntBuffer "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" frame_bufs "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" cm"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("buffer_pool"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("frame_bufs"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("取出了一个"),e("code",[s._v("pbi")]),s._v("里的变量和一个什么buffer。")]),s._v(" "),e("div",{staticClass:"language-c line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[s._v("      ctx"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("last_show_frame "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ctx"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("pbi"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("common"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("new_fb_idx"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("这里看着像是把之前解码好的帧存储为“上一帧”的操作。")]),s._v(" "),e("div",{staticClass:"language-c line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[s._v("      "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ctx"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("need_resync"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token constant"}},[s._v("NULL")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("这个"),e("code",[s._v("need_resync")]),s._v("应该是"),e("code",[s._v("vp9_get_raw_frame")]),s._v("里面返回的什么错误吧。")]),s._v(" "),e("div",{staticClass:"language-c line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[s._v("      "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("yuvconfig2image")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("ctx"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("img"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("sd"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ctx"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("user_priv"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("这函数名显然是用于吧"),e("code",[s._v("sd")]),s._v("里的帧数据转成img格式的操作。")]),s._v(" "),e("div",{staticClass:"language-c line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[s._v("      ctx"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("img"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("fb_priv "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" frame_bufs"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("cm"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("new_fb_idx"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("raw_frame_buffer"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("priv"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("这里看着也像是把之前解码好的帧存储为“上一帧”的操作。")]),s._v(" "),e("div",{staticClass:"language-c line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[s._v("      img "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("ctx"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("img"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" img"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("返回了。这个"),e("code",[s._v("&ctx->img")]),s._v("应该就是在"),e("code",[s._v("yuvconfig2image")]),s._v("从"),e("code",[s._v("sd")]),s._v("转换过来的帧图像了。")]),s._v(" "),e("div",{staticClass:"language-c line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[s._v("    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token constant"}},[s._v("NULL")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("p",[s._v("函数结束。")]),s._v(" "),e("h3",{attrs:{id:"decoder-decode"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#decoder-decode"}},[s._v("#")]),s._v(" "),e("code",[s._v("decoder_decode")])]),s._v(" "),e("p",[s._v("再来看稍微复杂一点的"),e("code",[s._v("decoder_decode")]),s._v("：")]),s._v(" "),e("div",{staticClass:"language-c line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("static")]),s._v(" vpx_codec_err_t "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("decoder_decode")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("vpx_codec_alg_priv_t "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("ctx"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                                      "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" uint8_t "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("data"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("unsigned")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" data_sz"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                                      "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("user_priv"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("long")]),s._v(" deadline"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[s._v("函数开始。")]),s._v(" "),e("div",{staticClass:"language-c line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[s._v("  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" uint8_t "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("data_start "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" data"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" uint8_t "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" data_end "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" data "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" data_sz"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("首先是计算原始数据的起始和终止地址。")]),s._v(" "),e("div",{staticClass:"language-c line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[s._v("  vpx_codec_err_t res"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("初始化了返回值。这返回只返回了错误信息。")]),s._v(" "),e("div",{staticClass:"language-c line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[s._v("  uint32_t frame_sizes"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" frame_count"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("这个是给后面一个压缩包解码出多个帧的情况用的。从这个"),e("code",[s._v("frame_sizes")]),s._v("尺寸看应该是最多8帧。")]),s._v(" "),e("div",{staticClass:"language-c line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[s._v("  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("data "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token constant"}},[s._v("NULL")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" data_sz "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    ctx"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("flushed "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" VPX_CODEC_OK"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("p",[s._v("如果没有数据就直接返回。")]),s._v(" "),e("div",{staticClass:"language-c line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[s._v("  "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Reset flushed when receiving a valid frame.")]),s._v("\n  ctx"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("flushed "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("有数据就先flush。")]),s._v(" "),e("div",{staticClass:"language-c line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[s._v("  "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Initialize the decoder on the first frame.")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ctx"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("pbi "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token constant"}},[s._v("NULL")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" vpx_codec_err_t res "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("init_decoder")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ctx"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("res "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!=")]),s._v(" VPX_CODEC_OK"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" res"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("p",[s._v("如果没有"),e("code",[s._v("ctx->pbi")]),s._v("就先初始化。从注释上看，这个"),e("code",[s._v("ctx->pbi")]),s._v("为空是在第一帧才会出现的情况。")]),s._v(" "),e("p",[s._v("这个"),e("code",[s._v("ctx->pbi")]),s._v("前面经常见到，从这种在第一帧初始化的操作，看来是用来在解码过程中存储一些临时数据的变量。")]),s._v(" "),e("div",{staticClass:"language-c line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[s._v("  res "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("vp9_parse_superframe_index")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("data"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" data_sz"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" frame_sizes"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("frame_count"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                                   ctx"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("decrypt_cb"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ctx"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("decrypt_state"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("res "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!=")]),s._v(" VPX_CODEC_OK"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" res"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[s._v("从这个函数名上看，首先是读取superframe。")]),s._v(" "),e("p",[s._v("查一下superframe的概念，就是vpx可以将多个帧放在一个压缩包里。所以这里的"),e("code",[s._v("frame_sizes")]),s._v("和"),e("code",[s._v("frame_count")]),s._v("应该就是“输出结果”，读取superframe就是读取出superframe里面帧的数量和每个帧数据的大小。")]),s._v(" "),e("div",{staticClass:"language-c line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[s._v("  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ctx"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("svc_decoding "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" ctx"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("svc_spatial_layer "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" frame_count "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    frame_count "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ctx"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("svc_spatial_layer "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("SVC是指可适性视频编码(Scalable Video Coding)，详情请看"),e("RouterLink",{attrs:{to:"/视频编解码/SVC和视频通信.html"}},[s._v("《SVC和视频通信》")]),s._v("。")],1),s._v(" "),e("div",{staticClass:"language-c line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[s._v("  "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Decode in serial mode.")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("frame_count "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("首先是"),e("code",[s._v("frame_count>0")]),s._v("的情况。这个应该是解包superframe一个数据包有好几个帧的情况。")]),s._v(" "),e("div",{staticClass:"language-c line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[s._v("    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" i"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("i "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" i "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" frame_count"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("++")]),s._v("i"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[s._v("一个循环对每个帧进行解压。")]),s._v(" "),e("div",{staticClass:"language-c line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[s._v("      "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" uint8_t "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("data_start_copy "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" data_start"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" uint32_t frame_size "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" frame_sizes"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("i"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("首先是获取帧数据起点和大小。")]),s._v(" "),e("div",{staticClass:"language-c line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[s._v("      vpx_codec_err_t res"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("data_start "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" data "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("||")]),s._v(" frame_size "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("uint32_t"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("data_end "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" data_start"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("set_error_detail")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ctx"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Invalid frame size in index"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" VPX_CODEC_CORRUPT_FRAME"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("p",[s._v("数据错误就报错返回。")]),s._v(" "),e("div",{staticClass:"language-c line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[s._v("      res "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("decode_one")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ctx"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("data_start_copy"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" frame_size"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" user_priv"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" deadline"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("res "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!=")]),s._v(" VPX_CODEC_OK"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" res"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("这个"),e("code",[s._v("decode_one")]),s._v("应该就是解码的核心函数了。")]),s._v(" "),e("div",{staticClass:"language-c line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[s._v("      data_start "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+=")]),s._v(" frame_size"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("每次解码完成后就更新帧数据起点，很合理。")]),s._v(" "),e("div",{staticClass:"language-c line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[s._v("    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("帧解码循环结束。")]),s._v(" "),e("div",{staticClass:"language-c line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[s._v("  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("接下来是"),e("code",[s._v("frame_count<=0")]),s._v("时的操作")]),s._v(" "),e("div",{staticClass:"language-c line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[s._v("    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("while")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("data_start "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" data_end"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("这里应该就是没有"),e("code",[s._v("frame_count")]),s._v("采用直接扫描的方式")]),s._v(" "),e("div",{staticClass:"language-c line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[s._v("      "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" uint32_t frame_size "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("uint32_t"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("data_end "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" data_start"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[e("code",[s._v("frame_size")]),s._v("也是计算出来的")]),s._v(" "),e("div",{staticClass:"language-c line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[s._v("      "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" vpx_codec_err_t res "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("\n          "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("decode_one")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ctx"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("data_start"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" frame_size"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" user_priv"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" deadline"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("res "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!=")]),s._v(" VPX_CODEC_OK"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" res"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[s._v("核心操作依旧是这个"),e("code",[s._v("decode_one")]),s._v("。")]),s._v(" "),e("div",{staticClass:"language-c line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[s._v("      "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Account for suboptimal termination by the encoder.")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("while")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("data_start "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" data_end"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" uint8_t marker "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("\n            "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("read_marker")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ctx"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("decrypt_cb"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ctx"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("decrypt_state"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" data_start"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("marker"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("break")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("++")]),s._v("data_start"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br")])]),e("p",[s._v("接下来这个应该是扫描直到找到下一个帧的起始标记。")]),s._v(" "),e("div",{staticClass:"language-c line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[s._v("    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("循环结束。")]),s._v(" "),e("div",{staticClass:"language-c line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[s._v("  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" res"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("函数结束。")]),s._v(" "),e("p",[s._v("可以看出，这个"),e("code",[s._v("decoder_decode")]),s._v("主要是解析出数据包中帧的数量，然后对每一帧调用"),e("code",[s._v("decode_one")]),s._v("进行解码。")]),s._v(" "),e("h2",{attrs:{id:"decode-one"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#decode-one"}},[s._v("#")]),s._v(" "),e("code",[s._v("decode_one")])]),s._v(" "),e("p",[s._v("再看看这个"),e("code",[s._v("decode_one")]),s._v("又是什么")]),s._v(" "),e("div",{staticClass:"language-c line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("static")]),s._v(" vpx_codec_err_t "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("decode_one")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("vpx_codec_alg_priv_t "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("ctx"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                                  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" uint8_t "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("data"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("unsigned")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" data_sz"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                                  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("user_priv"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" int64_t deadline"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("deadline"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("p",[s._v("函数开始。")]),s._v(" "),e("div",{staticClass:"language-c line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[s._v("  "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Determine the stream parameters. Note that we rely on peek_si to")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// validate that we have a buffer that does not wrap around the top")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// of the heap.")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("ctx"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("si"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("h"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" is_intra_only "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" vpx_codec_err_t res "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("\n        "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("decoder_peek_si_internal")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("data"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" data_sz"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("ctx"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("si"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("is_intra_only"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                                 ctx"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("decrypt_cb"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ctx"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("decrypt_state"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("res "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!=")]),s._v(" VPX_CODEC_OK"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" res"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("ctx"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("si"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("is_kf "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("is_intra_only"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" VPX_CODEC_ERROR"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br")])]),e("p",[s._v("这是什么操作，没懂。")]),s._v(" "),e("div",{staticClass:"language-c line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[s._v("  ctx"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("user_priv "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" user_priv"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Set these even if already initialized.  The caller may have changed the")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// decrypt config between frames.")]),s._v("\n  ctx"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("pbi"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("decrypt_cb "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ctx"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("decrypt_cb"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  ctx"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("pbi"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("decrypt_state "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ctx"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("decrypt_state"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("vp9_receive_compressed_data")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ctx"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("pbi"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" data_sz"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" data"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    ctx"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("pbi"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("cur_buf"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("buf"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("corrupted "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    ctx"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("pbi"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("need_resync "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    ctx"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("need_resync "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("update_error_state")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ctx"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("ctx"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("pbi"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("common"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("error"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n  "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("check_resync")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ctx"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ctx"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("pbi"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br")])]),e("p",[s._v("核心操作应该就是这个"),e("code",[s._v("vp9_receive_compressed_data")]),s._v("了。")]),s._v(" "),e("p",[s._v("看这样子应该是出错返回1，不出错返回0。")]),s._v(" "),e("div",{staticClass:"language-c line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[s._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" VPX_CODEC_OK"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[s._v("函数结束。")]),s._v(" "),e("p",[s._v("特别注意一下最后调用的这个"),e("code",[s._v("check_resync")]),s._v("：")]),s._v(" "),e("div",{staticClass:"language-c line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("static")]),s._v(" INLINE "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("check_resync")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("vpx_codec_alg_priv_t "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" ctx"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                                "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" VP9Decoder "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" pbi"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Clear resync flag if the decoder got a key frame or intra only frame.")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ctx"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("need_resync "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" pbi"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("need_resync "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("pbi"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("common"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("intra_only "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("||")]),s._v(" pbi"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("common"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("frame_type "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" KEY_FRAME"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    ctx"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("need_resync "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br")])]),e("p",[s._v("这里面注释写道解码器会在接收到关键帧或仅帧内编码帧时进行resync，相对应的就是在收到帧间编码帧时不会resync。这个操作应该是和帧间编码有关的，可能是在收到无帧间编码的帧时清除帧间编码遗留的数据。")]),s._v(" "),e("p",[s._v("下接"),e("RouterLink",{attrs:{to:"/视频编解码/libvpx-decode.html"}},[s._v("《libvpx解码过程解读》")])],1)])}),[],!1,null,null,null);t.default=n.exports}}]);