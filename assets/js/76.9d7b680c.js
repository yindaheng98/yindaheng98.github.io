(window.webpackJsonp=window.webpackJsonp||[]).push([[76],{738:function(s,a,t){"use strict";t.r(a);var e=t(4),n=Object(e.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("p",[t("a",{attrs:{href:"https://blog.csdn.net/tanzhe2017/article/details/81004164",target:"_blank",rel:"noopener noreferrer"}},[s._v("Uts_namespace分析"),t("OutboundLink")],1)]),s._v(" "),t("h2",{attrs:{id:"uts是什么"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#uts是什么"}},[s._v("#")]),s._v(" UTS是什么")]),s._v(" "),t("p",[s._v("当前一个系统的uts是linux主机所用的操作系统的版本、硬件名称等基本信息。uts信息在操作系统内核中定义为一个结构体,其值可以通过一些"),t("code",[s._v("set*")]),s._v("函数设置：")]),s._v(" "),t("div",{staticClass:"language-c line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-c"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("new_utsname")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("char")]),s._v(" sysname"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("__NEW_UTS_LEN "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("char")]),s._v(" nodename"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("__NEW_UTS_LEN "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("char")]),s._v(" release"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("__NEW_UTS_LEN "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("char")]),s._v(" version"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("__NEW_UTS_LEN "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("char")]),s._v(" machine"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("__NEW_UTS_LEN "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("char")]),s._v(" domainname"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("__NEW_UTS_LEN "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("p",[s._v("bash中可以用"),t("code",[s._v("uname -a")]),s._v("输出全部的utsname：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("yin@DESKTOP-IG564I6:~$ uname -a\nLinux DESKTOP-IG564I6 4.4.0-18362-Microsoft #836-Microsoft Mon May 05 16:04:00 PST 2020 x86_64 x86_64 x86_64 GNU/Linux\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("其中：")]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",[s._v("UTS名称")]),s._v(" "),t("th",[s._v("值")]),s._v(" "),t("th",[s._v("含义")])])]),s._v(" "),t("tbody",[t("tr",[t("td",[s._v("sysname")]),s._v(" "),t("td",[s._v("Linux")]),s._v(" "),t("td",[s._v("内核名称")])]),s._v(" "),t("tr",[t("td",[s._v("nodename")]),s._v(" "),t("td",[s._v("DESKTOP-IG564I6")]),s._v(" "),t("td",[s._v("主机在网络节点上的名称或主机名称")])]),s._v(" "),t("tr",[t("td",[s._v("release")]),s._v(" "),t("td",[s._v("4.4.0-18362-Microsoft")]),s._v(" "),t("td",[s._v("linux操作系统内核版本号")])]),s._v(" "),t("tr",[t("td",[s._v("version")]),s._v(" "),t("td",[s._v("#836-Microsoft Mon May 05 16:04:00 PST 2020")]),s._v(" "),t("td",[s._v("操作系统版本")])]),s._v(" "),t("tr",[t("td",[s._v("machine")]),s._v(" "),t("td",[s._v("x86_64")]),s._v(" "),t("td",[s._v("主机的硬件(CPU)名")])]),s._v(" "),t("tr",[t("td",[s._v("domainname")]),s._v(" "),t("td",[s._v("无")]),s._v(" "),t("td",[s._v("域名")])]),s._v(" "),t("tr",[t("td",[s._v("processor")]),s._v(" "),t("td",[s._v("x86_64")]),s._v(" "),t("td",[s._v("处理器类型")])]),s._v(" "),t("tr",[t("td",[s._v("hardware-platform")]),s._v(" "),t("td",[s._v("x86_64")]),s._v(" "),t("td",[s._v("硬件平台类型")])]),s._v(" "),t("tr",[t("td",[s._v("operating-system")]),s._v(" "),t("td",[s._v("GNU/Linux")]),s._v(" "),t("td",[s._v("操作系统名")])])])]),s._v(" "),t("h2",{attrs:{id:"uts-namespace是什么"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#uts-namespace是什么"}},[s._v("#")]),s._v(" UTS namespace是什么")]),s._v(" "),t("p",[s._v("Uts命名空间的数据结构是uts_namespace：")]),s._v(" "),t("div",{staticClass:"language-c line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-c"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("uts_namespace")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("kref")]),s._v(" kref"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 引用计数")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("new_utsname")]),s._v(" name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("user_namespace")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("user_ns"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ucounts")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("ucounts"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ns_common")]),s._v(" ns"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("p",[s._v("核心结构体是 uts_namespace，创建的过程和前文讲的 clone 调用相关，来自 copy_utsname。另外从前文介绍可以看到 new_utsname 结构体内容是 UTS namespace 隔离的所有内容。user_namepace是user命名空间的一个指针。")]),s._v(" "),t("h2",{attrs:{id:"uts-namespace的创建、克隆、复制"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#uts-namespace的创建、克隆、复制"}},[s._v("#")]),s._v(" UTS namespace的创建、克隆、复制")]),s._v(" "),t("ul",[t("li",[s._v("创建：创建uts_namespace的过程比较简单，主要就是分配一个uts_namespace实例的内核空间("),t("code",[s._v("kmalloc")]),s._v(")，并增加一个引用计数("),t("code",[s._v("kref_init")]),s._v(")。")]),s._v(" "),t("li",[s._v("克隆：克隆一个uts_namspace首先创建一个uts_namespace，然后将旧的命名空间的内容复制到新创建的uts_namespace中。")]),s._v(" "),t("li",[s._v("复制：如果不是CLONE_NEWUTS标志，直接返回旧的命名空间，但是增加了旧的命名空间的引用计数("),t("code",[s._v("kref_init")]),s._v(")，否则就克隆一个UTS命名空间。")])]),s._v(" "),t("h1",{attrs:{id:"user-namespace"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#user-namespace"}},[s._v("#")]),s._v(" User namespace")]),s._v(" "),t("p",[s._v("一个普通用户的进程通过clone()创建的新进程在新user namespace中可以拥有不同的用户和用户组。这意味着一个进程在容器外属于一个没有特权的普通用户，但是"),t("strong",[s._v("他创建的容器进程却属于拥有所有权限的超级用户")]),s._v("，这个技术为容器提供了极大的自由。")]),s._v(" "),t("h2",{attrs:{id:"user-namespace-与其它-namespace-的关系"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#user-namespace-与其它-namespace-的关系"}},[s._v("#")]),s._v(" User namespace 与其它 namespace 的关系")]),s._v(" "),t("p",[s._v("如果你要把user namespace与其他namespace混合使用，那么依旧需要root权限。解决方案可以是"),t("strong",[s._v("先以普通用户身份创建user namespace")]),s._v("，然后"),t("strong",[s._v("在新建的namespace中作为root再clone()进程加入其他类型的namespace隔离")]),s._v("。")]),s._v(" "),t("p",[s._v("当使用包含User在内的多个namespace时，"),t("strong",[s._v("内核会保证 CLONE_NEWUSER 先被执行")]),s._v("，然后执行剩下的其他 CLONE_NEW*，这样就使得不用 root 用户而创建新的容器成为可能。")]),s._v(" "),t("p",[s._v("Linux 下的每个 namespace，都有一个 user namespace 与之关联，这个 user namespace 就是创建相应 namespace 时进程所属的 user namespace，这样保证对任何 namespace 的操作都受到 user namespace 权限的控制。例如在上面的UTS namespace结构体中有一个User namespace指针"),t("code",[s._v("struct user_namespace *user_ns;")]),s._v("。")])])}),[],!1,null,null,null);a.default=n.exports}}]);