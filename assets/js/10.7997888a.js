(window.webpackJsonp=window.webpackJsonp||[]).push([[10],{443:function(s,t,a){s.exports=a.p+"assets/img/vpx_codec_vp9_dx.1dc40e7b.png"},602:function(s,t,a){s.exports=a.p+"assets/img/get_vpx.6ecc0eb0.png"},603:function(s,t,a){s.exports=a.p+"assets/img/VpxInterface.84606de2.png"},604:function(s,t,a){s.exports=a.p+"assets/img/vpx_codec_iface_t.a7d594b6.png"},605:function(s,t,a){s.exports=a.p+"assets/img/vpx_codec_iface.7511358f.png"},606:function(s,t,a){s.exports=a.p+"assets/img/vpx_codec_vp8_dx.78058223.png"},607:function(s,t,a){s.exports=a.p+"assets/img/CODEC_INTERFACE.a74efdb0.png"},608:function(s,t,a){s.exports=a.p+"assets/img/vpx_codec_dec_init.b9d0dedf.png"},609:function(s,t,a){s.exports=a.p+"assets/img/vpx_codec_dec_init_ver.a40eeb15.png"},610:function(s,t,a){s.exports=a.p+"assets/img/vpx_video_reader_read_frame.fdd2666f.png"},611:function(s,t,a){s.exports=a.p+"assets/img/vpx_video_reader_get_frame.5f208f1b.png"},612:function(s,t,a){s.exports=a.p+"assets/img/vpx_codec_decode.ee19b79e.png"},613:function(s,t,a){s.exports=a.p+"assets/img/vpx_codec_get_frame.f8ed6791.png"},972:function(s,t,a){"use strict";a.r(t);var e=a(4),n=Object(e.a)({},(function(){var s=this,t=s.$createElement,e=s._self._c||t;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("div",{staticClass:"language-c line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/*\n *  Copyright (c) 2010 The WebM project authors. All Rights Reserved.\n *\n *  Use of this source code is governed by a BSD-style license\n *  that can be found in the LICENSE file in the root of the source\n *  tree. An additional intellectual property rights grant can be found\n *  in the file PATENTS.  All contributing project authors may\n *  be found in the AUTHORS file in the root of the source tree.\n */")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br")])]),e("h1",{attrs:{id:"开头自带的说明书"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#开头自带的说明书"}},[s._v("#")]),s._v(" 开头自带的说明书")]),s._v(" "),e("div",{staticClass:"language-c line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Simple Decoder")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ==============")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// This is an example of a simple decoder loop. It takes an input file")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// containing the compressed data (in IVF format), passes it through the")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// decoder, and writes the decompressed frames to disk. Other decoder")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// examples build upon this one.")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br")])]),e("p",[s._v("这个案例的功能是读取一个IVF格式的输入文件，解码之后把帧写到磁盘上。")]),s._v(" "),e("div",{staticClass:"language-c line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// The details of the IVF format have been elided from this example for")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// simplicity of presentation, as IVF files will not generally be used by")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// your application. In general, an IVF file consists of a file header,")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// followed by a variable number of frames. Each frame consists of a frame")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// header followed by a variable length payload. The length of the payload")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// is specified in the first four bytes of the frame header. The payload is")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// the raw compressed data.")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br")])]),e("p",[s._v("IVF格式的详情不是本示例的重点。")]),s._v(" "),e("div",{staticClass:"language-c line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Standard Includes")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// -----------------")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// For decoders, you only have to include `vpx_decoder.h` and then any")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// header files for the specific codecs you use. In this case, we're using")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// vp8.")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("p",[s._v("为了调用解码器，需要引入"),e("code",[s._v("vpx_decoder.h")]),s._v("。")]),s._v(" "),e("div",{staticClass:"language-c line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Initializing The Codec")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ----------------------")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// The libvpx decoder is initialized by the call to vpx_codec_dec_init().")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Determining the codec interface to use is handled by VpxVideoReader and the")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// functions prefixed with vpx_video_reader_. Discussion of those functions is")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// beyond the scope of this example, but the main gist is to open the input file")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// and parse just enough of it to determine if it's a VPx file and which VPx")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// codec is contained within the file.")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Note the NULL pointer passed to vpx_codec_dec_init(). We do that in this")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// example because we want the algorithm to determine the stream configuration")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// (width/height) and allocate memory automatically.")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br")])]),e("p",[s._v("初始化解码器的函数是"),e("code",[s._v("vpx_codec_dec_init()")]),s._v("。")]),s._v(" "),e("p",[s._v("使用哪个解码器接口是在"),e("code",[s._v("VpxVideoReader")]),s._v("和"),e("code",[s._v("vpx_video_reader_")]),s._v("开头的几个函数里面判断的。具体情况不在本示例的讨论范围内，本示例中解码器信息就包含在文件里面。")]),s._v(" "),e("p",[s._v("NOTE：示例中"),e("code",[s._v("vpx_codec_dec_init()")]),s._v("的第三项是解码器配置，本案例中传入的是空指针，这样可以让它自己判合适的配置和分配内存空间。")]),s._v(" "),e("div",{staticClass:"language-c line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Decoding A Frame")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ----------------")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Once the frame has been read into memory, it is decoded using the")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// `vpx_codec_decode` function. The call takes a pointer to the data")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// (`frame`) and the length of the data (`frame_size`). No application data")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// is associated with the frame in this example, so the `user_priv`")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// parameter is NULL. The `deadline` parameter is left at zero for this")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// example. This parameter is generally only used when doing adaptive post")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// processing.")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br")])]),e("p",[s._v("当帧被读入内存之后，调用"),e("code",[s._v("vpx_codec_decode")]),s._v("就可以对其进行解码。")]),s._v(" "),e("p",[s._v("这个"),e("code",[s._v("vpx_codec_decode")]),s._v("接受一个帧数据指针("),e("code",[s._v("frame")]),s._v(")和帧尺寸("),e("code",[s._v("frame_size")]),s._v(")，其他一些可有可无的调节参数("),e("code",[s._v("user_priv")]),s._v(")不在本案例的讨论范围，直接设空。本案例中的"),e("code",[s._v("deadline")]),s._v("参数设为0，这个参数主要用于自适应。")]),s._v(" "),e("div",{staticClass:"language-c line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Codecs may produce a variable number of output frames for every call to")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// `vpx_codec_decode`. These frames are retrieved by the")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// `vpx_codec_get_frame` iterator function. The iterator variable `iter` is")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// initialized to NULL each time `vpx_codec_decode` is called.")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// `vpx_codec_get_frame` is called in a loop, returning a pointer to a")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// decoded image or NULL to indicate the end of list.")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br")])]),e("p",[s._v("每次调用"),e("code",[s._v("vpx_codec_decode")]),s._v("都可能产生多个解码帧，调用"),e("code",[s._v("vpx_codec_get_frame")]),s._v("获取这些帧。")]),s._v(" "),e("p",[e("code",[s._v("vpx_codec_get_frame")]),s._v("的第二个参数接受一个迭代器指针，"),e("code",[s._v("vpx_codec_get_frame")]),s._v("会以迭代的方式输出解码后的帧。")]),s._v(" "),e("div",{staticClass:"language-c line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Processing The Decoded Data")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ---------------------------")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// In this example, we simply write the encoded data to disk. It is")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// important to honor the image's `stride` values.")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("p",[s._v("本示例中，解码之后的数据直接写进文件里。")]),s._v(" "),e("div",{staticClass:"language-c line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Cleanup")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// -------")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// The `vpx_codec_destroy` call frees any memory allocated by the codec.")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Error Handling")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// --------------")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// This example does not special case any error return codes. If there was")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// an error, a descriptive message is printed and the program exits. With")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// few exceptions, vpx_codec functions return an enumerated error status,")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// with the value `0` indicating success.")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br")])]),e("p",[e("code",[s._v("vpx_codec_destroy")]),s._v("用于清理。")]),s._v(" "),e("p",[s._v("本示例中没有什么特殊的需要处理的错误。")]),s._v(" "),e("h2",{attrs:{id:"正文开头"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#正文开头"}},[s._v("#")]),s._v(" 正文开头")]),s._v(" "),e("div",{staticClass:"language-c line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[e("span",{pre:!0,attrs:{class:"token macro property"}},[s._v("#"),e("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("include")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("<stdio.h>")])]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token macro property"}},[s._v("#"),e("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("include")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("<stdlib.h>")])]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token macro property"}},[s._v("#"),e("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("include")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("<string.h>")])]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token macro property"}},[s._v("#"),e("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("include")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"vpx/vpx_decoder.h"')])]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token macro property"}},[s._v("#"),e("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("include")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"../tools_common.h"')])]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token macro property"}},[s._v("#"),e("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("include")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"../video_reader.h"')])]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token macro property"}},[s._v("#"),e("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("include")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"./vpx_config.h"')])]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br")])]),e("p",[s._v("一堆"),e("code",[s._v("include")]),s._v("不用多讲。")]),s._v(" "),e("div",{staticClass:"language-c line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("static")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("char")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("exec_name"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("usage_exit")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("fprintf")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token constant"}},[s._v("stderr")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Usage: %s <infile> <outfile>\\n"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" exec_name"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("exit")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("EXIT_FAILURE"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("p",[s._v("这是一个输出错误并退出程序的函数，用在接下来会经常见到的"),e("code",[s._v("die")]),s._v("函数里面，就是输出一些错误而已，不用太在意。")]),s._v(" "),e("div",{staticClass:"language-c line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("main")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" argc"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("char")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("argv"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("主函数开始。")]),s._v(" "),e("div",{staticClass:"language-c line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[s._v("  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" frame_cnt "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  FILE "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("outfile "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token constant"}},[s._v("NULL")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  vpx_codec_ctx_t codec"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  VpxVideoReader "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("reader "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token constant"}},[s._v("NULL")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" VpxInterface "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("decoder "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token constant"}},[s._v("NULL")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" VpxVideoInfo "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("info "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token constant"}},[s._v("NULL")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n  exec_name "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" argv"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("argc "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("die")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Invalid number of arguments."')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br")])]),e("p",[s._v("一堆后面要用到的变量定义。")]),s._v(" "),e("h2",{attrs:{id:"打开待解码的文件"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#打开待解码的文件"}},[s._v("#")]),s._v(" 打开待解码的文件")]),s._v(" "),e("div",{staticClass:"language-c line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[s._v("  reader "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("vpx_video_reader_open")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("argv"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("reader"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("die")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Failed to open %s for reading."')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" argv"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("outfile "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("fopen")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("argv"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"wb"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("die")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Failed to open %s for writing."')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" argv"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("p",[s._v("打开文件，生成"),e("code",[s._v("VpxVideoReader")]),s._v("。这个输入参数"),e("code",[s._v("argv[1]")]),s._v("是要待解码文件的文件名，"),e("code",[s._v("argv[1]")]),s._v("是放解码后数据的文件的文件名。")]),s._v(" "),e("div",{staticClass:"language-c line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[s._v("  info "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("vpx_video_reader_get_info")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("reader"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("这个函数的定义里面只有一句话："),e("code",[s._v("return &reader->info")]),s._v("😂。")]),s._v(" "),e("h2",{attrs:{id:"获取所需的解码器"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#获取所需的解码器"}},[s._v("#")]),s._v(" 获取所需的解码器")]),s._v(" "),e("div",{staticClass:"language-c line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[s._v("  decoder "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("get_vpx_decoder_by_fourcc")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("info"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("codec_fourcc"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("decoder"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("die")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Unknown input codec."')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n  "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("printf")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Using %s\\n"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("vpx_codec_iface_name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("decoder"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("codec_interface")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("p",[s._v("这个函数顺着一查，发现下图：")]),s._v(" "),e("p",[e("img",{attrs:{src:a(602),alt:""}})]),s._v(" "),e("p",[e("code",[s._v("get_vpx_decoder_by_fourcc")]),s._v("调用了"),e("code",[s._v("get_vpx_decoder_by_index")]),s._v("，而"),e("code",[s._v("get_vpx_decoder_by_index")]),s._v("直接从一个列表里选出了一个解码器。从这列表看，这就是在选vp8还是vp9。")]),s._v(" "),e("p",[s._v("返回值都是"),e("code",[s._v("VpxInterface")]),s._v("类型，说明vp8和vp9的decoder都是继承的同一个接口类。那看看这个"),e("code",[s._v("VpxInterface")]),s._v("又是什么：")]),s._v(" "),e("p",[e("img",{attrs:{src:a(603),alt:""}})]),s._v(" "),e("p",[s._v("嗯，上面那个"),e("code",[s._v("vpx_decoders[]")]),s._v("数组和这个类定义是一一对应的。这"),e("code",[s._v("VpxInterface")]),s._v("里面前两个一看就是两个Metadata，最后这个"),e("code",[s._v("vpx_codec_iface_t *(*const codec_interface)()")]),s._v("应该就是重点。")]),s._v(" "),e("p",[s._v("定义看着有点复杂，这就是个函数指针。变量名是"),e("code",[s._v("codec_interface")]),s._v("，接受返回值是"),e("code",[s._v("vpx_codec_iface_t *")]),s._v("，无输入参数的函数。")]),s._v(" "),e("p",[s._v("那这个"),e("code",[s._v("vpx_codec_iface_t")]),s._v("又是什么？找找：")]),s._v(" "),e("p",[e("img",{attrs:{src:a(604),alt:""}})]),s._v(" "),e("p",[s._v("一个"),e("code",[s._v("typedef")]),s._v("😂，好吧，再找这个"),e("code",[s._v("vpx_codec_iface")]),s._v("：")]),s._v(" "),e("p",[e("img",{attrs:{src:a(605),alt:""}})]),s._v(" "),e("p",[s._v("这应该就是vp8和vp9的统一接口了。这里面这些类型随便点进去几个，发现它们都是在"),e("code",[s._v("vpx/internal/vpx_codec_internal.h")]),s._v("里面定义的函数指针类型。哇，简单粗暴，确实称得上是“接口”。")]),s._v(" "),e("p",[s._v("那么再回去看"),e("code",[s._v("vpx_decoders[]")]),s._v("数组里的值，"),e("code",[s._v("codec_interface")]),s._v("对应的是这个"),e("code",[s._v("vpx_codec_vp8_dx")]),s._v("和"),e("code",[s._v("vpx_codec_vp9_dx")]),s._v("，显然这两个就是返回值是"),e("code",[s._v("vpx_codec_iface_t *")]),s._v("且无输入参数的函数，也是解码器的主要部分。")]),s._v(" "),e("p",[s._v("那看看这个"),e("code",[s._v("vpx_codec_vp8_dx")]),s._v("和"),e("code",[s._v("vpx_codec_vp9_dx")]),s._v("是什么：")]),s._v(" "),e("p",[e("img",{attrs:{src:a(606),alt:""}}),s._v(" "),e("img",{attrs:{src:a(443),alt:""}})]),s._v(" "),e("p",[s._v("哇这个赋值，显然这就是在给"),e("code",[s._v("vpx_codec_iface")]),s._v("里的函数指针变量赋值，那被赋的这些值就是vp8和vp9解码器的具体实现了，记下来以后慢慢看。")]),s._v(" "),e("p",[s._v("还记得"),e("code",[s._v("vpx_codec_vp8_dx")]),s._v("和"),e("code",[s._v("vpx_codec_vp9_dx")]),s._v("的类型吗？它们应该是返回值是"),e("code",[s._v("vpx_codec_iface_t *")]),s._v("且无输入参数的函数，但这里看怎么像是在给"),e("code",[s._v("vpx_codec_iface_t")]),s._v("赋值？注意到"),e("code",[s._v("vpx_codec_vp8_dx")]),s._v("和"),e("code",[s._v("vpx_codec_vp9_dx")]),s._v("都被一个宏"),e("code",[s._v("CODEC_INTERFACE")]),s._v("包裹着，那看看这个宏是什么：")]),s._v(" "),e("p",[e("img",{attrs:{src:a(607),alt:""}})]),s._v(" "),e("p",[s._v("哇，秒懂，赋值之后放进函数里。一个小trick而已，和"),e("RouterLink",{attrs:{to:"/WebRTC/pion-interceptor.html"}},[s._v("《pion/interceptor浅析》")]),s._v("里介绍的"),e("code",[s._v("RTCPReaderFunc")]),s._v("之流差不多的想法。")],1),s._v(" "),e("h2",{attrs:{id:"初始化解码器"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#初始化解码器"}},[s._v("#")]),s._v(" 初始化解码器")]),s._v(" "),e("p",[s._v("好了，继续看示例的代码：")]),s._v(" "),e("div",{staticClass:"language-c line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[s._v("  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("vpx_codec_dec_init")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("codec"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" decoder"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("codec_interface")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token constant"}},[s._v("NULL")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("die")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Failed to initialize decoder."')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("开头的说明里讲过的初始化操作。看着像个函数，其实是被套了个宏的函数：")]),s._v(" "),e("p",[e("img",{attrs:{src:a(608),alt:""}})]),s._v(" "),e("p",[s._v("被套的函数是这个：")]),s._v(" "),e("p",[e("img",{attrs:{src:a(609),alt:""}})]),s._v(" "),e("p",[s._v("套个宏就是替换最后一个变量用于ABI版本检查。")]),s._v(" "),e("p",[s._v("初始化函数的核心就是给这个上下文变量"),e("code",[s._v("ctx")]),s._v("赋了一堆值，还调用了传进来的"),e("code",[s._v("iface")]),s._v("里面的"),e("code",[s._v("init")]),s._v("函数，这就是"),e("code",[s._v("vpx_codec_iface")]),s._v("里的函数之一，前面介绍过，不用多讲。")]),s._v(" "),e("p",[s._v("这个"),e("code",[s._v("ctx")]),s._v("是传进来的结构体指针，所以调用这个函数之后，在函数外面用户就可以用赋好值的"),e("code",[s._v("ctx")]),s._v("进行各种操作了。")]),s._v(" "),e("h2",{attrs:{id:"解码过程"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#解码过程"}},[s._v("#")]),s._v(" 解码过程")]),s._v(" "),e("p",[s._v("继续看示例：")]),s._v(" "),e("div",{staticClass:"language-c line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[s._v("  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("while")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("vpx_video_reader_read_frame")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("reader"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("上来就是直接一个"),e("code",[s._v("while")]),s._v("循环，这个"),e("code",[s._v("vpx_video_reader_read_frame")]),s._v("长这样：")]),s._v(" "),e("p",[e("img",{attrs:{src:a(610),alt:""}})]),s._v(" "),e("p",[s._v("看来就是个ivf读取器啊，看样子是根据"),e("code",[s._v("reader")]),s._v("里的文件信息把文件数据写进"),e("code",[s._v("reader->buffer")]),s._v("里")]),s._v(" "),e("div",{staticClass:"language-c line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[s._v("    vpx_codec_iter_t iter "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token constant"}},[s._v("NULL")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    vpx_image_t "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("img "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token constant"}},[s._v("NULL")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    size_t frame_size "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("unsigned")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("char")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("frame "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("\n        "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("vpx_video_reader_get_frame")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("reader"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("frame_size"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("p",[e("code",[s._v("while")]),s._v("循环里每轮来一个"),e("code",[s._v("vpx_video_reader_get_frame")]),s._v("，这个"),e("code",[s._v("vpx_video_reader_get_frame")]),s._v("也很简单：\n"),e("img",{attrs:{src:a(611),alt:""}})]),s._v(" "),e("p",[s._v("就直接返回"),e("code",[s._v("vpx_video_reader_read_frame")]),s._v("里写入的"),e("code",[s._v("reader->buffer")]),s._v("然后把数据长度传给"),e("code",[s._v("frame_size")]),s._v("。看这个"),e("code",[s._v("frame")]),s._v("的类型应该就是个"),e("code",[s._v("unsigned char")]),s._v("数组，看来这个libvpx里的压缩帧数据没有专门指定数据类型。")]),s._v(" "),e("div",{staticClass:"language-c line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[s._v("    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("vpx_codec_decode")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("codec"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" frame"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("unsigned")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("frame_size"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token constant"}},[s._v("NULL")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("die_codec")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("codec"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Failed to decode frame."')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[e("code",[s._v("vpx_video_reader_read_frame")]),s._v("之后就是"),e("code",[s._v("vpx_codec_decode")]),s._v("对帧数据进行解码。这个"),e("code",[s._v("vpx_codec_decode")]),s._v("依然很短：")]),s._v(" "),e("p",[e("img",{attrs:{src:a(612),alt:""}})]),s._v(" "),e("p",[s._v("其实就是在调用"),e("code",[s._v("vpx_codec_iface")]),s._v("接口里定义好的解码函数"),e("code",[s._v("dec.decode")]),s._v("。")]),s._v(" "),e("div",{staticClass:"language-c line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[s._v("    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("while")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("img "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("vpx_codec_get_frame")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("codec"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("iter"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token constant"}},[s._v("NULL")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("vpx_img_write")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("img"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" outfile"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("++")]),s._v("frame_cnt"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("p",[s._v("最后就是一个"),e("code",[s._v("vpx_codec_get_frame")]),s._v("获取到解码出来的帧。"),e("s",[s._v("这个传入的"),e("code",[s._v("iter")]),s._v("在前后都没有用到，看来只是为了提供一点内存空间（既然外面用不到为什么还要这样定义？应该是有别的用处吧）")]),s._v("。注意到有个传入的迭代器参数"),e("code",[s._v("iter")]),s._v("只传入了"),e("code",[s._v("vpx_codec_get_frame")]),s._v("却没有其他任何操作。这个参数是历史遗留问题，具体可以看"),e("code",[s._v("decoder_get_frame")]),s._v("函数里面有一段注释的解释，"),e("RouterLink",{attrs:{to:"/视频编解码/libvpx-insight.html"}},[s._v("《"),e("code",[s._v("libvpx")]),s._v("再深入一点》")]),s._v("的解析里也有。")],1),s._v(" "),e("p",[s._v("这个"),e("code",[s._v("vpx_codec_get_frame")]),s._v("依旧很短：")]),s._v(" "),e("p",[e("img",{attrs:{src:a(613),alt:""}})]),s._v(" "),e("p",[s._v("和"),e("code",[s._v("vpx_codec_decode")]),s._v("差不多，封装了一下"),e("code",[s._v("vpx_codec_iface")]),s._v("接口里定义好的"),e("code",[s._v("dec.get_frame")]),s._v("。")]),s._v(" "),e("div",{staticClass:"language-c line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[s._v("  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("解码过程结束。")]),s._v(" "),e("h2",{attrs:{id:"一些收尾操作"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#一些收尾操作"}},[s._v("#")]),s._v(" 一些收尾操作")]),s._v(" "),e("div",{staticClass:"language-c line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[s._v("  "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("printf")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Processed %d frames.\\n"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" frame_cnt"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("vpx_codec_destroy")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("codec"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("die_codec")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("codec"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Failed to destroy codec"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("关闭解码器。")]),s._v(" "),e("div",{staticClass:"language-c line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[s._v("  "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("printf")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Play: ffplay -f rawvideo -pix_fmt yuv420p -s %dx%d %s\\n"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n         info"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("frame_width"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" info"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("frame_height"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" argv"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n  "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("vpx_video_reader_close")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("reader"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n  "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("fclose")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("outfile"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("p",[s._v("关闭文件读取器。")]),s._v(" "),e("div",{staticClass:"language-c line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[s._v("  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" EXIT_SUCCESS"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("退出。")]),s._v(" "),e("h2",{attrs:{id:"完"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#完"}},[s._v("#")]),s._v(" 完")]),s._v(" "),e("div",{staticClass:"language-c line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("主函数结束")])])}),[],!1,null,null,null);t.default=n.exports}}]);