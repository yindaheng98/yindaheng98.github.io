(window.webpackJsonp=window.webpackJsonp||[]).push([[74],{737:function(s,t,n){"use strict";n.r(t);var a=n(4),e=Object(a.a)({},(function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h2",{attrs:{id:"linux-虚拟网络设备"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#linux-虚拟网络设备"}},[s._v("#")]),s._v(" Linux 虚拟网络设备")]),s._v(" "),n("p",[n("img",{attrs:{src:"i/Linux%E8%99%9A%E6%8B%9F%E7%BD%91%E7%BB%9C%E8%AE%BE%E5%A4%87.png",alt:"Linux 虚拟网络设备"}})]),s._v(" "),n("h3",{attrs:{id:"tun-tap"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#tun-tap"}},[s._v("#")]),s._v(" TUN/TAP")]),s._v(" "),n("p",[s._v("TUN 设备是一种虚拟网络设备，通过此设备，程序可以方便得模拟网络行为。对于物理设备，其协议栈从物理网卡中读写数据：")]),s._v(" "),n("p",[n("img",{attrs:{src:"i/%E7%89%A9%E7%90%86.png",alt:"物理"}})]),s._v(" "),n("p",[s._v("而TUN 设备的协议栈从文件中读写数据：")]),s._v(" "),n("p",[n("img",{attrs:{src:"i/TUN.png",alt:"TUN"}})]),s._v(" "),n("p",[s._v("所有对这个文件的写操作会通过 TUN 设备转换成一个数据包送给内核；当内核发送一个包给 TUN 设备时，通过读这个文件可以拿到包的内容。")]),s._v(" "),n("p",[s._v("TAP 设备与 TUN 设备工作方式完全相同，区别在于：")]),s._v(" "),n("ul",[n("li",[s._v("TUN 设备从 /dev/tunX 文件收发 IP 层数据包；\n"),n("ul",[n("li",[s._v("只能工作在 IP 层，无MAC地址因而也无法桥接物理网卡。")])])]),s._v(" "),n("li",[s._v("TAP 设备从 /dev/tapX 文件收发 MAC 层数据包。\n"),n("ul",[n("li",[s._v("工作与MAC层，拥有 MAC 层功能，可以桥接，支持 MAC 层广播")])])])]),s._v(" "),n("p",[s._v("TUN/TAP设备的特性经常被用在虚拟机和VPN等应用中。例如使用 TUN 设备搭建一个基于 UDP VPN：")]),s._v(" "),n("p",[n("img",{attrs:{src:"i/TUN-VPN.png",alt:"TUN VPN"}})]),s._v(" "),n("p",[s._v("App读写/dev/tunX，可以对其流量进行各种转发或加密等操作。")]),s._v(" "),n("h3",{attrs:{id:"veth-pair-一根虚拟网线和两个虚拟网卡"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#veth-pair-一根虚拟网线和两个虚拟网卡"}},[s._v("#")]),s._v(" veth-pair-一根虚拟网线和两个虚拟网卡")]),s._v(" "),n("p",[s._v("veth设备总是成对出现，显然，仅有veth-pair设备，容器是无法访问网络的。因为容器发出的数据包，实质上直接进入了veth1设备的协议栈里。如果容器需要访问网络，需要使用bridge等技术，将veth1接收到的数据包通过某种方式转发出去。")]),s._v(" "),n("p",[s._v("创建veth-pair，一端为虚拟网卡veth0，另一端为虚拟网卡veth1：")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" name veth0 "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("type")]),s._v(" veth0 peer name veth1\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("h3",{attrs:{id:"bridge-虚拟交换机"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#bridge-虚拟交换机"}},[s._v("#")]),s._v(" Bridge-虚拟交换机")]),s._v(" "),n("p",[n("img",{attrs:{src:"i/bridge.png",alt:"Bridge"}})]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" br0 "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("type")]),s._v(" bridge "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建Bridge br0")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" br0 up "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 启动网桥")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" veth0 "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("type")]),s._v(" veth peer name br-veth0 "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建veth和两个虚拟网卡，veth0——br-veth0")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" veth1 "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("type")]),s._v(" veth peer name br-veth1 "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建veth和两个虚拟网卡，veth1——br-veth1")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 假定有两个Network namespace ns1和ns2")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" veth0 netns ns1 "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 虚拟网卡veth0分配给ns1")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" br-veth0 master br0 "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 虚拟网卡br-veth0接上网桥")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" br-veth0 up "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 启动虚拟网卡br-veth0")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" veth1 netns ns2 "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 虚拟网卡veth1分配给ns2")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" br-veth1 master br0 "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 虚拟网卡br-veth1接上网桥")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" br-veth1 up "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 启动虚拟网卡br-veth1")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" netns "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" ns1 "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" addr "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.1")]),s._v(".1.2/24 dev veth0 "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 给ns1中的虚拟网卡veth0分配IP")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" netns "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" ns1 "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" veth0 up "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 启动虚拟网卡veth0")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" netns "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" ns2 "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" addr "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.1")]),s._v(".1.3/24 dev veth1 "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 给ns1中的虚拟网卡veth1分配IP")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" netns "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" ns2 "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" veth1 up "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 启动虚拟网卡veth1")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br")])]),n("h2",{attrs:{id:"network-namespace"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#network-namespace"}},[s._v("#")]),s._v(" Network namespace")]),s._v(" "),n("p",[s._v("Network namespace主要提供了关于网络资源的隔离，包括网络设备、IPv4和IPv6协议栈、IP路由表、防火墙、/proc/net目录、/sys/class/net目录、端口（socket）等等。"),n("strong",[s._v("一个物理的网络设备最多存在在一个network namespace中")]),s._v("，可以通过创建并连接虚拟网络设备在不同的network namespace间创建通道，以此达到通信的目的。")]),s._v(" "),n("p",[s._v("network namespace的使用其实就是在创建的时候添加CLONE_NEWNET标识位。也可以通过命令行工具ip创建network namespace：")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" netns "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" test_ns "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建名为test_ns的network namespace")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("如上节所示，通过"),n("code",[s._v("ip netns exec [network namespace名称] [任意指令]")]),s._v("命令可以在新创建的network namespace下运行网络管理命令；通过"),n("code",[s._v("ip link set [虚拟网卡] netns [network namespace名称]")]),s._v("命令将一个虚拟网卡分配给一个network namespace。")]),s._v(" "),n("h2",{attrs:{id:"docker如何使用network-namespace"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#docker如何使用network-namespace"}},[s._v("#")]),s._v(" Docker如何使用Network namespace")]),s._v(" "),n("ul",[n("li",[s._v("Host模式：如果启动容器的时候使用host模式，那么这个容器将不会获得一个独立的Network Namespace，而是"),n("strong",[s._v("和宿主机共用一个Network Namespace")]),s._v("；")]),s._v(" "),n("li",[s._v("Container模式：与Host模式类似，Container模式的容器"),n("strong",[s._v("与一个已存在的容器共用一个Network Namespace")]),s._v("；")]),s._v(" "),n("li",[s._v("Bridge模式："),n("strong",[s._v("容器使用独立network Namespace，并连接到docker0网桥")]),s._v("，通过docker0网桥以及Iptables NAT表配置与宿主机通信；")]),s._v(" "),n("li",[s._v("None模式：该模式将容器"),n("strong",[s._v("放置在它自己的Network Namespace中，但是并不进行任何配置")]),s._v("；")]),s._v(" "),n("li",[s._v("自定义网络：使用自定义的网桥可以控制哪些容器可以相互通信，还可以自动DNS解析容器名称到IP地址，容器编排工具（k8s、docker-compose等）中的容器网络就是基于自定义网络所创建的。\n"),n("ul",[n("li",[s._v("bridge：与Bridge模式相同，只是不与docker0网桥而是自行创建网桥进行连接；")]),s._v(" "),n("li",[s._v("Macvlan：macvlan是linux kernel提供的一种network driver类型，是一种网卡虚拟化方案，一张物理网卡设置多个mac地址从而给多个容器使用。")])])])]),s._v(" "),n("h5",{attrs:{id:"注：端口映射"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#注：端口映射"}},[s._v("#")]),s._v(" 注：端口映射")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[s._v("docker run -p "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v(":80 "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("Docker如何将容器的80端口映射到主机的80端口？答案是DNAT，在IPtable中：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("-A DOCKER ! -i docker0 -p tcp -m tcp --dport 80 -j DNAT --to-destination 172.17.0.2:80\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])])])}),[],!1,null,null,null);t.default=e.exports}}]);