(window.webpackJsonp=window.webpackJsonp||[]).push([[16],{585:function(s,t,a){s.exports=a.p+"assets/img/BufferPool.2229251b.png"},586:function(s,t,a){s.exports=a.p+"assets/img/init_buffer_callbacks.f18cdc23.png"},587:function(s,t,a){s.exports=a.p+"assets/img/get_free_fb.2e9865bc.png"},588:function(s,t,a){s.exports=a.p+"assets/img/current_video_frame.ab63f490.png"},589:function(s,t,a){s.exports=a.p+"assets/img/get_frame_new_buffer.1164c272.png"},590:function(s,t,a){s.exports=a.p+"assets/img/vp9_setup_block_planes.d74c1c23.png"},968:function(s,t,a){"use strict";a.r(t);var n=a(4),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("p",[s._v("上接"),n("RouterLink",{attrs:{to:"/视频编解码/libvpx-insight.html"}},[s._v("《"),n("code",[s._v("libvpx")]),s._v("再深入一点》")]),s._v("，本篇从上篇最后的"),n("code",[s._v("vp9_receive_compressed_data")]),s._v("函数开始解读。")],1),s._v(" "),n("h2",{attrs:{id:"vp9-receive-compressed-data"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#vp9-receive-compressed-data"}},[s._v("#")]),s._v(" "),n("code",[s._v("vp9_receive_compressed_data")])]),s._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("vp9_receive_compressed_data")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("VP9Decoder "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("pbi"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" size_t size"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                                "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" uint8_t "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("psource"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  VP9_COMMON "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("volatile")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" cm "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("common"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  BufferPool "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("volatile")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" pool "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("buffer_pool"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  RefCntBuffer "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("volatile")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" frame_bufs "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("buffer_pool"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("frame_bufs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" uint8_t "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("source "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("psource"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" retcode "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("error"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("error_code "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" VPX_CODEC_OK"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("p",[s._v("初始化一些变量")]),s._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[s._v("  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("size "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// This is used to signal that we are missing frames.")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// We do not know if the missing frame(s) was supposed to update")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// any of the reference buffers, but we act conservative and")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// mark only the last buffer as corrupted.")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// TODO(jkoleszar): Error concealment is undefined and non-normative")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// at this point, but if it becomes so, [0] may not always be the correct")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// thing to do here.")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("frame_refs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("idx "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("assert")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("frame_refs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("buf "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("NULL")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n      cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("frame_refs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("buf"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("corrupted "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br")])]),n("p",[s._v("可能有丢失帧？")]),s._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[s._v("  pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("ready_for_new_data "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Check if the previous frame was a frame without any references to it.")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("new_fb_idx "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" frame_bufs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("new_fb_idx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ref_count "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("frame_bufs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("new_fb_idx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("released"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    pool"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("release_fb_cb")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("pool"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("cb_priv"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                        "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("frame_bufs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("new_fb_idx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("raw_frame_buffer"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    frame_bufs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("new_fb_idx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("released "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br")])]),n("p",[s._v("从后面找可用buffer的过程来看，这里的"),n("code",[s._v("cm->new_fb_idx")]),s._v("就是上一帧用过的帧buffer的index。结合注释看，这里的操作是为了释放上一帧用完没释放的buffer。")]),s._v(" "),n("p",[s._v("主要调用的函数是这个"),n("code",[s._v("pool->release_fb_cb")]),s._v("，这函数是BufferPool里面的一个变量：")]),s._v(" "),n("p",[n("img",{attrs:{src:a(585),alt:""}})]),s._v(" "),n("p",[s._v("顾名思义，这个变量带个"),n("code",[s._v("_cb")]),s._v("后缀，应该是某种回调函数，和它上面那个变量一个是用于分配空间时的回调一个是用于释放空间时的回调。它们都是在"),n("code",[s._v("init_buffer_callbacks")]),s._v("函数里初始化的：")]),s._v(" "),n("p",[n("img",{attrs:{src:a(586),alt:""}})]),s._v(" "),n("p",[s._v("可以看到，如果没有在传入的"),n("code",[s._v("ctx")]),s._v("里设置回调，就会用默认的回调，但是这默认的回调从函数名上看又不像是请求/释放内存空间后的回调函数，而是像进行请求/释放内存空间的函数。再结合前面看到的用法，这个"),n("code",[s._v("release_fb_cb")]),s._v("根本就不是操作完成之后的“回调”。可能这个"),n("code",[s._v("release_fb_cb")]),s._v("虽然带个"),n("code",[s._v("_cb")]),s._v("的名字但是作者并不想把它当成操作之后的回调函数用吧。")]),s._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[s._v("  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Find a free frame buffer. Return error if can not find any.")]),s._v("\n  cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("new_fb_idx "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("get_free_fb")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("cm"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("new_fb_idx "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" INVALID_IDX"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("ready_for_new_data "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("release_fb_on_decoder_exit")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("pbi"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("vpx_clear_system_state")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("vpx_internal_error")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("error"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" VPX_CODEC_MEM_ERROR"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                       "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Unable to find free frame buffer"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("error"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("error_code"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br")])]),n("p",[s._v("找一个可用的帧buffer，如果没有就直接报错退出。前面先释放了buffer，这里用上，很合理。")]),s._v(" "),n("p",[s._v("核心函数就是这个"),n("code",[s._v("get_free_fb")]),s._v("：")]),s._v(" "),n("p",[n("img",{attrs:{src:a(587),alt:""}})]),s._v(" "),n("p",[s._v("可用看到，其实就是从传入的"),n("code",[s._v("VP9_COMMON")]),s._v("里面的"),n("code",[s._v("buffer_poll->frame_bufs")]),s._v("里面找到"),n("code",[s._v("ref_count")]),s._v("为0的buffer，如果没有就返回"),n("code",[s._v("INVALID_IDX")]),s._v("。")]),s._v(" "),n("p",[s._v("所以很明显记载buffer是否可用就是用一个"),n("code",[s._v("ref_count")]),s._v("数值实现的。然后调用的话直接就是"),n("code",[s._v("buffer_poll->->frame_bufs[cm->new_fb_idx]")]),s._v("。")]),s._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[s._v("  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Assign a MV array to the frame buffer.")]),s._v("\n  cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("cur_frame "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("pool"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("frame_bufs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("new_fb_idx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n  pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("hold_ref_buf "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("cur_buf "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("frame_bufs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("new_fb_idx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("接下来，找到的可用的buffer又赋值给了"),n("code",[s._v("cm->cur_frame")]),s._v("和"),n("code",[s._v("pbi->cur_buf")])]),s._v(" "),n("p",[s._v("（为什么一个是用的"),n("code",[s._v("&pool->frame_bufs[cm->new_fb_idx]")]),s._v("另一个用的"),n("code",[s._v("&frame_bufs[cm->new_fb_idx]")]),s._v("？明明都是同一个变量，可能只是作者们马虎了吧）")]),s._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[s._v("  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("setjmp")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("error"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("jmp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("error"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("setjmp "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("ready_for_new_data "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("release_fb_on_decoder_exit")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("pbi"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Release current frame.")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("decrease_ref_count")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("new_fb_idx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" frame_bufs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" pool"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("vpx_clear_system_state")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n  cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("error"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("setjmp "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br")])]),n("blockquote",[n("p",[n("code",[s._v("setjmp")]),s._v("属于C函数库，作用是分别承担非局部标号和goto作用。")])]),s._v(" "),n("blockquote",[n("p",[n("code",[s._v("setjmp")]),s._v("函数用于保存程序的运行时的堆栈环境，接下来的其它地方，你可以通过调用"),n("code",[s._v("longjmp")]),s._v("函数来恢复先前被保存的程序堆栈环境。")])]),s._v(" "),n("p",[s._v("这个"),n("code",[s._v("setjmp")]),s._v("是C语言里的错误处理机制，是try-catch的初级形式。难懂，以后再学习。")]),s._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[s._v("  "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("vp9_decode_frame")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("pbi"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" source"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" source "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" size"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" psource"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n  "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("swap_frame_buffers")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("pbi"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n  "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("vpx_clear_system_state")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("直接调用了"),n("code",[s._v("vp9_decode_frame")]),s._v("这应该就是主要的解码的函数了。然后"),n("code",[s._v("swap_frame_buffers")]),s._v("和"),n("code",[s._v("vpx_clear_system_state")]),s._v("应该就是释放内存空间之类的操作。")]),s._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[s._v("  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("show_existing_frame"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("last_show_frame "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("show_frame"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("prev_frame "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("cur_frame"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("seg"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("enabled"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("vp9_swap_current_and_last_seg_map")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("cm"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("show_frame"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("cur_show_frame_fb_idx "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("new_fb_idx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Update progress in frame parallel decode.")]),s._v("\n  cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("last_width "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("width"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("last_height "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("height"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("show_frame"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("current_video_frame"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("++")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br")])]),n("p",[s._v("最后有几个和"),n("code",[s._v("show_frame")]),s._v("有关的操作。点进去这个"),n("code",[s._v("show_existing_frame")]),s._v("和"),n("code",[s._v("show_frame")]),s._v("，发现它们都是在"),n("code",[s._v("vp9_decode_frame")]),s._v("的"),n("code",[s._v("read_uncompressed_header")]),s._v("里赋值的，并且是从数据包头里读取出来的数据。")]),s._v(" "),n("p",[s._v("从这里的两个"),n("code",[s._v("if")]),s._v("可以看出，如果"),n("code",[s._v("cm->show_frame")]),s._v("为true，那么：")]),s._v(" "),n("ul",[n("li",[s._v("方才解码出的帧"),n("code",[s._v("cm->new_fb_idx")]),s._v("会赋值给"),n("code",[s._v("cm->cur_show_frame_fb_idx")]),s._v("从名字上看应该是放进当前展示的帧里面")]),s._v(" "),n("li",[n("code",[s._v("cm->current_video_frame")]),s._v("的值加一")])]),s._v(" "),n("p",[s._v("从"),n("code",[s._v("current_video_frame")]),s._v("的注释里可以进一步推测，这个"),n("code",[s._v("show_existing_frame")]),s._v("和"),n("code",[s._v("show_frame")]),s._v("应该是控制跳过一些帧（被解码但不被显示）：")]),s._v(" "),n("p",[n("img",{attrs:{src:a(588),alt:""}})]),s._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[s._v("\n  cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("error"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("setjmp "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" retcode"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("函数结束。")]),s._v(" "),n("p",[s._v("这个"),n("code",[s._v("vp9_receive_compressed_data")]),s._v("也没有触及到解码的核心操作，它只是为解码准备好了各种变量。真正的解码操作在"),n("code",[s._v("vp9_decode_frame")]),s._v("里面。")]),s._v(" "),n("h2",{attrs:{id:"vp9-decode-frame"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#vp9-decode-frame"}},[s._v("#")]),s._v(" "),n("code",[s._v("vp9_decode_frame")])]),s._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("vp9_decode_frame")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("VP9Decoder "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("pbi"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" uint8_t "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("data"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                      "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" uint8_t "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("data_end"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" uint8_t "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("p_data_end"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[s._v("函数开始。从之前的解析看，这个"),n("code",[s._v("data")]),s._v("就是存放压缩帧数据的buffer起点地址，"),n("code",[s._v("data_end")]),s._v("是终止地址。在"),n("code",[s._v("vp9_receive_compressed_data")]),s._v("里面"),n("code",[s._v("p_data_end")]),s._v("赋的值是"),n("code",[s._v("psource")]),s._v("，是"),n("code",[s._v("source")]),s._v("的地址。所以这里的"),n("code",[s._v("p_data_end")]),s._v("就是"),n("code",[s._v("data")]),s._v("的地址。")]),s._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[s._v("  VP9_COMMON "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" cm "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("common"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  MACROBLOCKD "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" xd "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("mb"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[s._v("取出两个context，一个是已经见过很多次的运行时变量，另外一个看名字应该是解码用的宏块结构体。")]),s._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[s._v("  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("vpx_read_bit_buffer")]),s._v(" rb"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" context_updated "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  uint8_t clear_data"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("MAX_VP9_HEADER_SIZE"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" size_t first_partition_size "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("read_uncompressed_header")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n      pbi"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("init_read_bit_buffer")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("pbi"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("rb"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" data"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" data_end"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" clear_data"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("这应该是读取数据包包头。点进去一看，其实就是调用一堆"),n("code",[s._v("vp9_read_sync_code")]),s._v("读取包头，根据读到的值给"),n("code",[s._v("cm")]),s._v("赋值。")]),s._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[s._v("  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" tile_rows "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("log2_tile_rows"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" tile_cols "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("log2_tile_cols"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[s._v("初始化了两个tile数量相关的变量。点进去发现是在"),n("code",[s._v("read_uncompressed_header")]),s._v("调用的"),n("code",[s._v("setup_tile_info")]),s._v("的里面从包头中读取并赋值的。放在包头的只能是2的次方的值，压缩成log2存储，非常合理。")]),s._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[s._v("  YV12_BUFFER_CONFIG "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" new_fb "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("get_frame_new_buffer")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("cm"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("调用的这个：")]),s._v(" "),n("p",[n("img",{attrs:{src:a(589),alt:""}})]),s._v(" "),n("p",[s._v("直接取了"),n("code",[s._v("vp9_receive_compressed_data")]),s._v("里面弄好的buffer，没毛病嗷。")]),s._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[n("span",{pre:!0,attrs:{class:"token macro property"}},[s._v("#"),n("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("if")]),s._v(" CONFIG_BITSTREAM_DEBUG || CONFIG_MISMATCH_DEBUG")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("bitstream_queue_set_frame_read")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("current_video_frame "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("show_frame"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token macro property"}},[s._v("#"),n("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("endif")])]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token macro property"}},[s._v("#"),n("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("if")]),s._v(" CONFIG_MISMATCH_DEBUG")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("mismatch_move_frame_idx_r")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token macro property"}},[s._v("#"),n("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("endif")])]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("p",[s._v("两个Debug用的东西？不懂")]),s._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[s._v("  xd"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("cur_buf "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" new_fb"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("应该是把存储压缩帧信息的buffer赋值给了一个解码用的宏块结构体。")]),s._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[s._v("  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("first_partition_size"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// showing a frame directly")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("p_data_end "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" data "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("profile "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<=")]),s._v(" PROFILE_2 "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("?")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[n("code",[s._v("first_partition_size")]),s._v("为false就直接showing a frame？什么操作")]),s._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[s._v("  data "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("vpx_rb_bytes_read")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("rb"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("read_is_valid")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("data"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" first_partition_size"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" data_end"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("vpx_internal_error")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("error"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" VPX_CODEC_CORRUPT_FRAME"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                       "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Truncated packet or corrupt header length"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("这一看就是"),n("code",[s._v("read_uncompressed_header")]),s._v("读完包头之后来读一下标志位验证包头长度对不对")]),s._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[s._v("  cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("use_prev_frame_mvs "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("error_resilient_mode "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("width "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("last_width "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v("\n      cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("height "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("last_height "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("last_intra_only "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v("\n      cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("last_show_frame "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("last_frame_type "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!=")]),s._v(" KEY_FRAME"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("如果满足条件就"),n("code",[s._v("use_prev_frame_mvs")]),s._v("用上一帧的运动矢量？")]),s._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[s._v("  "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("vp9_setup_block_planes")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("xd"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("subsampling_x"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("subsampling_y"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("设置"),n("code",[s._v("block_planes")]),s._v("块平面？应该是帧内分块编码相关的操作。看这函数：")]),s._v(" "),n("p",[n("img",{attrs:{src:a(590),alt:""}})]),s._v(" "),n("p",[s._v("😂就是设置了一下长宽吧这是。")]),s._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[s._v("  "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("fc "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("frame_contexts"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("frame_context_idx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("fc"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("initialized"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("vpx_internal_error")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("error"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" VPX_CODEC_CORRUPT_FRAME"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                       "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Uninitialized entropy context."')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("entropy context？熵上下文？应该是和熵解码相关。不太懂，以后再学")]),s._v(" "),n("p",[s._v("总之这里是初始化了帧解码时的上下文，里面应该是存储的帧解码出来从数据。")]),s._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[s._v("  xd"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("corrupted "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  new_fb"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("corrupted "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("read_compressed_header")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("pbi"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" data"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" first_partition_size"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("new_fb"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("corrupted"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("vpx_internal_error")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("error"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" VPX_CODEC_CORRUPT_FRAME"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                       "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Decode failed. Frame data header is corrupted."')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("又是一个读包头的操作，不过这次是在读compressed_header。")]),s._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[s._v("  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("lf"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("filter_level "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("skip_loop_filter"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("vp9_loop_filter_frame_init")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("cm"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("lf"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("filter_level"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[s._v("如果不跳过环路滤波的话就初始化环路滤波器。")]),s._v(" "),n("blockquote",[n("p",[s._v("由于FDCT变换后的量化（Quant）过程是一个有损（lossy）过程，会照成信息损失。再经过反量化（Rescale）和IDCT后恢复的矩阵与原矩阵存在一定的误差，特别宏块的边界，会照常恢复的图像呈现方块化，而方块化的图片对于后面的图片预测存在极大的影响，所以我们需要通过环路滤波进行去方块化。")])]),s._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[s._v("  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("tile_worker_data "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("NULL")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("||")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("tile_cols "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" tile_rows"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!=")]),s._v(" pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("total_tiles"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" num_tile_workers "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("\n        tile_cols "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" tile_rows "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("max_threads "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("?")]),s._v(" pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("max_threads "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" size_t twd_size "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" num_tile_workers "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("sizeof")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("tile_worker_data"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Ensure tile data offsets will be properly aligned. This may fail on")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// platforms without DECLARE_ALIGNED().")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("assert")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("sizeof")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("tile_worker_data"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("%")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("vpx_free")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("tile_worker_data"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("CHECK_MEM_ERROR")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("cm"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("tile_worker_data"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("vpx_memalign")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("32")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" twd_size"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("total_tiles "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" tile_rows "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" tile_cols"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br")])]),n("p",[s._v("接着上面的"),n("code",[s._v("tile_rows")]),s._v("和"),n("code",[s._v("tile_cols")]),s._v("处理，这里应该是确认"),n("code",[s._v("pbi->tile_worker_data")]),s._v("的大小足够并且"),n("code",[s._v("pbi->total_tiles")]),s._v("的值正确。")]),s._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[s._v("  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("max_threads "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" tile_rows "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("tile_cols "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("||")]),s._v(" pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("row_mt "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[s._v("这一看就是准备开始多线程了。")]),s._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[s._v("    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("row_mt "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("p_data_end "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("\n          "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("decode_tiles_row_wise_mt")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("pbi"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" data "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" first_partition_size"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" data_end"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[s._v("一行多列多线程的情况，就调用解码单行的函数"),n("code",[s._v("decode_tiles_row_wise_mt")]),s._v("，环路滤波应该是包含在里面了（确实如此，见"),n("RouterLink",{attrs:{to:"/视频编解码/libvpx-decode-tile.html"}},[s._v("《libvpx中的"),n("code",[s._v("decode_tiles")]),s._v("》")]),s._v("）。")],1),s._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[s._v("    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Multi-threaded tile decoder")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("p_data_end "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("decode_tiles_mt")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("pbi"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" data "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" first_partition_size"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" data_end"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("lpf_mt_opt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("xd"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("corrupted"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n          "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("skip_loop_filter"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// If multiple threads are used to decode tiles, then we use those")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// threads to do parallel loopfiltering.")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("vp9_loop_filter_frame_mt")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n                new_fb"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" cm"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("mb"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("plane"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("lf"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("filter_level"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("tile_workers"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("num_tile_workers"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("lf_row_sync"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n          "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n          "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("vpx_internal_error")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("error"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" VPX_CODEC_CORRUPT_FRAME"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                             "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Decode failed. Frame data is corrupted."')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br")])]),n("p",[s._v("多行多列多线程的情况，除了解码多行多列的"),n("code",[s._v("decode_tiles_mt")]),s._v("还要调用多线程的环路滤波"),n("code",[s._v("vp9_loop_filter_frame_mt")]),s._v("。")]),s._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[s._v("  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("p_data_end "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("decode_tiles")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("pbi"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" data "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" first_partition_size"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" data_end"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[s._v("这单线程的代码，就只有一个"),n("code",[s._v("decode_tiles")]),s._v("解码所有的块，环路滤波应该是包含在里面了（确实如此，见"),n("RouterLink",{attrs:{to:"/视频编解码/libvpx-decode-tile.html"}},[s._v("《libvpx中的"),n("code",[s._v("decode_tiles")]),s._v("》")]),s._v("）。")],1),s._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[s._v("  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("xd"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("corrupted"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("error_resilient_mode "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("frame_parallel_decoding_mode"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("vp9_adapt_coef_probs")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("cm"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n      "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("frame_is_intra_only")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("cm"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("vp9_adapt_mode_probs")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("cm"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("vp9_adapt_mv_probs")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("cm"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("allow_high_precision_mv"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("vpx_internal_error")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("error"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" VPX_CODEC_CORRUPT_FRAME"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                       "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Decode failed. Frame data is corrupted."')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br")])]),n("p",[s._v("一些错误处理，里面有三个看着像是自适应的函数"),n("code",[s._v("vp9_adapt_coef_probs")]),s._v("、"),n("code",[s._v("vp9_adapt_mode_probs")]),s._v("、"),n("code",[s._v("vp9_adapt_mv_probs")]),s._v("应该就是正常解码解不出来的时候的一些尝试吧。")]),s._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[s._v("  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Non frame parallel update frame context here.")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("refresh_frame_context "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("context_updated"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("frame_contexts"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("frame_context_idx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("fc"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[s._v("最后更新帧上下文？")]),s._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("函数结束。")]),s._v(" "),n("p",[s._v("离真相又进了一步！这个"),n("code",[s._v("vp9_decode_frame")]),s._v("负责读取帧压缩数据包头、初始化上下文结构体值，最后调用了多线程的"),n("code",[s._v("decode_tiles_row_wise_mt")]),s._v("和"),n("code",[s._v("decode_tiles_mt")]),s._v("以及单线程的"),n("code",[s._v("decode_tiles")]),s._v("进行解码。所以"),n("code",[s._v("decode_tiles_row_wise_mt")]),s._v("、"),n("code",[s._v("decode_tiles_mt")]),s._v("、"),n("code",[s._v("decode_tiles")]),s._v("这三个函数就是更深层的核心代码。")]),s._v(" "),n("p",[s._v("接下来就来框框"),n("code",[s._v("decode_tiles_row_wise_mt")]),s._v("、"),n("code",[s._v("decode_tiles_mt")]),s._v("、"),n("code",[s._v("decode_tiles")]),s._v("这三个函数是怎么“decode tiles”的："),n("RouterLink",{attrs:{to:"/视频编解码/libvpx-decode-tile.html"}},[s._v("《libvpx中的"),n("code",[s._v("decode_tiles")]),s._v("》")]),s._v("。")],1)])}),[],!1,null,null,null);t.default=e.exports}}]);