(window.webpackJsonp=window.webpackJsonp||[]).push([[45],{505:function(s,t,n){s.exports=n.p+"assets/img/ION-Arch.b4a7cddd.png"},773:function(s,t,n){"use strict";n.r(t);var a=n(4),e=Object(a.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("table",[a("thead",[a("tr",[a("th",[s._v("服务名称")]),s._v(" "),a("th",[s._v("功能")])])]),s._v(" "),a("tbody",[a("tr",[a("td",[s._v("ISLB")]),s._v(" "),a("td",[s._v("节点发现与负载均衡")])]),s._v(" "),a("tr",[a("td",[s._v("Signal")]),s._v(" "),a("td",[s._v("传递信令")])]),s._v(" "),a("tr",[a("td",[s._v("Room")]),s._v(" "),a("td",[s._v("主要业务逻辑，包括聊天室、用户验证等")])]),s._v(" "),a("tr",[a("td",[s._v("SFU")]),s._v(" "),a("td",[s._v("WebRTC SFU，用于视频流的转发")])])])]),s._v(" "),a("table",[a("thead",[a("tr",[a("th",[s._v("用到的独立软件")]),s._v(" "),a("th",[s._v("功能")])])]),s._v(" "),a("tbody",[a("tr",[a("td",[s._v("Redis")]),s._v(" "),a("td",[s._v("缓存数据库。给ISLB存储节点列表等数据；给Room存储业务逻辑数据")])]),s._v(" "),a("tr",[a("td",[s._v("nats")]),s._v(" "),a("td",[s._v("分布式消息队列。用于各服务间的消息传递")])])])]),s._v(" "),a("blockquote",[a("p",[s._v('Software applications and services need to exchange data. NATS is an infrastructure that allows such data exchange, segmented in the form of messages. We call this a "message oriented middleware".')])]),s._v(" "),a("p",[a("img",{attrs:{src:n(505),alt:""}})]),s._v(" "),a("p",[s._v("在连接建立过程中，各组件之间的关系如下：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("SDK<---grpc---\x3esignal<---nats---\x3eRoom/ISLB<---nats---\x3esignal<---grpc---\x3eSDK\n                                    ||\n                                  [Redis]\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("在视频流传输中，各组件之间的关系如下：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("SDK<----webrtc----\x3eSFU<----webrtc----\x3eSDK\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h2",{attrs:{id:"启动"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#启动"}},[s._v("#")]),s._v(" 启动")]),s._v(" "),a("h3",{attrs:{id:"sfu"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#sfu"}},[s._v("#")]),s._v(" SFU")]),s._v(" "),a("p",[s._v("在官网教程中，单独启动SFU的指令如下：")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("docker pull nats\ndocker run -p "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4222")]),s._v(":4222 -p "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6222")]),s._v(":6222 -p "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8222")]),s._v(":8222 nats\ndocker run -p "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5000")]),s._v(":5000/udp --network "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("host")]),s._v(" -v "),a("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("$PWD")]),s._v("/configs/sfu.toml:/configs/sfu.toml pionwebrtc/ion:latest-sfu\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("可以看出，SFU需要有nats的存在才可运行。")]),s._v(" "),a("p",[a("code",[s._v("$PWD/configs/sfu.toml")]),s._v("似乎是配置文件。找到"),a("a",{attrs:{href:"https://github.com/pion/ion-sfu/blob/68545cc25230220435ee028d5a0af6e768a0a79a/config.toml",target:"_blank",rel:"noopener noreferrer"}},[a("code",[s._v("pion/ion-sfu")]),s._v("中配置文件的位置"),a("OutboundLink")],1),s._v("，可以看到这文件长这样：")]),s._v(" "),a("div",{staticClass:"language-toml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-toml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token table class-name"}},[s._v("sfu")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Ballast size in MiB, will allocate memory to reduce the GC trigger upto 2x the")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# size of ballast. Be aware that the ballast should be less than the half of memory")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# available.")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key property"}},[s._v("ballast")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# enable prometheus sfu statistics")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key property"}},[s._v("withstats")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token table class-name"}},[s._v("router")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Limit the remb bandwidth in kbps")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# zero means no limits")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key property"}},[s._v("maxbandwidth")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1500")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# max number of video tracks packets the SFU will keep track")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key property"}},[s._v("maxpackettrack")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("500")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Sets the audio level volume threshold.")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Values from [0-127] where 0 is the loudest.")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Audio levels are read from rtp extension header according to:")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# https://tools.ietf.org/html/rfc6464")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key property"}},[s._v("audiolevelthreshold")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("40")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Sets the interval in which the SFU will check the audio level")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# in [ms]. If the active speaker has changed, the sfu will")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# emit an event to clients.")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key property"}},[s._v("audiolevelinterval")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Sets minimum percentage of events required to fire an audio level")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# according to the expected events from the audiolevelinterval,")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# calculated as audiolevelinterval/packetization time (20ms for 8kHz)")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Values from [0-100]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key property"}},[s._v("audiolevelfilter")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token table class-name"}},[s._v("router.simulcast")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Prefer best quality initially")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key property"}},[s._v("bestqualityfirst")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# EXPERIMENTAL enable temporal layer change is currently an experimental feature,")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# enable only for testing.")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key property"}},[s._v("enabletemporallayer")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token table class-name"}},[s._v("webrtc")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Single port, portrange will not work if you enable this")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# singleport = 5000")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Range of ports that ion accepts WebRTC traffic on")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Format: [min, max]   and max - min >= 100")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key property"}},[s._v("portrange")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5000")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5200")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# if sfu behind nat, set iceserver")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# [[webrtc.iceserver]]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# urls = ["stun:stun.stunprotocol.org:3478"]')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# [[webrtc.iceserver]]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# urls = ["turn:turn.awsome.org:3478"]')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# username = "awsome"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# credential = "awsome"')]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# sdp semantics:")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# "unified-plan"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# "plan-b"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# "unified-plan-with-fallback"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key property"}},[s._v("sdpsemantics")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"unified-plan"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# toggle multicast dns support: https://tools.ietf.org/html/draft-mdns-ice-candidates-00")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key property"}},[s._v("mdns")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token table class-name"}},[s._v("webrtc.candidates")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# In case you're deploying ion-sfu on a server which is configured with")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# a 1:1 NAT (e.g., Amazon EC2), you might want to also specify the public")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# address of the machine using the setting below. This will result in")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# all host candidates (which normally have a private IP address) to")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# be rewritten with the public address provided in the settings. As")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# such, use the option with caution and only if you know what you're doing.")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Multiple public IP addresses can be specified as a comma separated list")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# if the sfu is deployed in a DMZ between two 1-1 NAT for internal and")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# external users.")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# nat1to1 = ["1.2.3.4"]')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# icelite = true")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token table class-name"}},[s._v("webrtc.timeouts")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# The duration in [sec] without network activity before a ICE Agent is considered disconnected")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key property"}},[s._v("disconnected")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# The duration in [sec] without network activity before a ICE Agent is considered failed after disconnected")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key property"}},[s._v("failed")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("25")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# How often in [sec] the ICE Agent sends extra traffic if there is no activity, if media is flowing no traffic will be sent")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key property"}},[s._v("keepalive")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token table class-name"}},[s._v("turn")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Enables embeded turn server")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key property"}},[s._v("enabled")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Sets the realm for turn server")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key property"}},[s._v("realm")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ion"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# The address the TURN server will listen on.")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key property"}},[s._v("address")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"0.0.0.0:3478"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Certs path to config tls/dtls")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# cert="path/to/cert.pem"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# key="path/to/key.pem"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Port range that turn relays to SFU")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# WARNING: It shouldn't overlap webrtc.portrange")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Format: [min, max]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# portrange = [5201, 5400]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token table class-name"}},[s._v("turn.auth")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Use an auth secret to generate long-term credentials defined in RFC5389-10.2")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# NOTE: This takes precedence over `credentials` if defined.")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# secret = "secret"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Sets the credentials pairs")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key property"}},[s._v("credentials")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"pion=ion,pion2=ion2"')]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token table class-name"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 0 - INFO 1 - DEBUG 2 - TRACE")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key property"}},[s._v("v")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br"),a("span",{staticClass:"line-number"},[s._v("59")]),a("br"),a("span",{staticClass:"line-number"},[s._v("60")]),a("br"),a("span",{staticClass:"line-number"},[s._v("61")]),a("br"),a("span",{staticClass:"line-number"},[s._v("62")]),a("br"),a("span",{staticClass:"line-number"},[s._v("63")]),a("br"),a("span",{staticClass:"line-number"},[s._v("64")]),a("br"),a("span",{staticClass:"line-number"},[s._v("65")]),a("br"),a("span",{staticClass:"line-number"},[s._v("66")]),a("br"),a("span",{staticClass:"line-number"},[s._v("67")]),a("br"),a("span",{staticClass:"line-number"},[s._v("68")]),a("br"),a("span",{staticClass:"line-number"},[s._v("69")]),a("br"),a("span",{staticClass:"line-number"},[s._v("70")]),a("br"),a("span",{staticClass:"line-number"},[s._v("71")]),a("br"),a("span",{staticClass:"line-number"},[s._v("72")]),a("br"),a("span",{staticClass:"line-number"},[s._v("73")]),a("br"),a("span",{staticClass:"line-number"},[s._v("74")]),a("br"),a("span",{staticClass:"line-number"},[s._v("75")]),a("br"),a("span",{staticClass:"line-number"},[s._v("76")]),a("br"),a("span",{staticClass:"line-number"},[s._v("77")]),a("br"),a("span",{staticClass:"line-number"},[s._v("78")]),a("br"),a("span",{staticClass:"line-number"},[s._v("79")]),a("br"),a("span",{staticClass:"line-number"},[s._v("80")]),a("br"),a("span",{staticClass:"line-number"},[s._v("81")]),a("br"),a("span",{staticClass:"line-number"},[s._v("82")]),a("br"),a("span",{staticClass:"line-number"},[s._v("83")]),a("br"),a("span",{staticClass:"line-number"},[s._v("84")]),a("br"),a("span",{staticClass:"line-number"},[s._v("85")]),a("br"),a("span",{staticClass:"line-number"},[s._v("86")]),a("br"),a("span",{staticClass:"line-number"},[s._v("87")]),a("br"),a("span",{staticClass:"line-number"},[s._v("88")]),a("br"),a("span",{staticClass:"line-number"},[s._v("89")]),a("br"),a("span",{staticClass:"line-number"},[s._v("90")]),a("br"),a("span",{staticClass:"line-number"},[s._v("91")]),a("br"),a("span",{staticClass:"line-number"},[s._v("92")]),a("br"),a("span",{staticClass:"line-number"},[s._v("93")]),a("br"),a("span",{staticClass:"line-number"},[s._v("94")]),a("br"),a("span",{staticClass:"line-number"},[s._v("95")]),a("br"),a("span",{staticClass:"line-number"},[s._v("96")]),a("br"),a("span",{staticClass:"line-number"},[s._v("97")]),a("br"),a("span",{staticClass:"line-number"},[s._v("98")]),a("br"),a("span",{staticClass:"line-number"},[s._v("99")]),a("br"),a("span",{staticClass:"line-number"},[s._v("100")]),a("br"),a("span",{staticClass:"line-number"},[s._v("101")]),a("br"),a("span",{staticClass:"line-number"},[s._v("102")]),a("br"),a("span",{staticClass:"line-number"},[s._v("103")]),a("br"),a("span",{staticClass:"line-number"},[s._v("104")]),a("br")])]),a("p",[s._v("可以看到设置还是比较丰富的，比如有"),a("code",[s._v("maxbandwidth")]),s._v("这种带宽设置、WebRTC监听端口范围设置"),a("code",[s._v("portrange")]),s._v("、给内网端口映射环境部署时用的"),a("code",[s._v("nat1to1")]),s._v("、内置turn服务器设置"),a("code",[s._v("[turn]")]),s._v("等。")]),s._v(" "),a("p",[s._v("但是并没看到有nats相关的配置？这个SFU是怎么知道如何连接nats的？在仔细找找，发现这个"),a("code",[s._v("pion/ion-sfu")]),s._v("并不是直接放进容器里，而是在"),a("a",{attrs:{href:"https://github.com/pion/ion/tree/65dbd12eaad0f0e0a019b4d8ee80742930bcdc28/pkg/node/sfu",target:"_blank",rel:"noopener noreferrer"}},[a("code",[s._v("github.com/pion/ion/pkg/node/sfu")]),a("OutboundLink")],1),s._v("里面做了一层封装，然后在"),a("a",{attrs:{href:"https://github.com/pion/ion/blob/65dbd12eaad0f0e0a019b4d8ee80742930bcdc28/cmd/sfu/main.go",target:"_blank",rel:"noopener noreferrer"}},[a("code",[s._v("cmd/sfu/main.go")]),a("OutboundLink")],1),s._v("里面调用成为一个可执行文件的。")]),s._v(" "),a("p",[s._v("进一步，进到"),a("a",{attrs:{href:"https://github.com/pion/ion/blob/65dbd12eaad0f0e0a019b4d8ee80742930bcdc28/pkg/node/sfu/sfu.go",target:"_blank",rel:"noopener noreferrer"}},[s._v("pkg/node/sfu/sfu.go"),a("OutboundLink")],1),s._v("中，找到最主要的配置项：")]),s._v(" "),a("div",{staticClass:"language-go line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Config for sfu node")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("type")]),s._v(" Config "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\tGlobal global   "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('`mapstructure:"global"`')]),s._v("\n\tLog    logConf  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('`mapstructure:"log"`')]),s._v("\n\tNats   natsConf "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('`mapstructure:"nats"`')]),s._v("\n\tisfu"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Config\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("p",[s._v("可以看到，SFU中的配置项实际上是几个配置项拼起来的，其中就包含"),a("code",[s._v("pion/ion-sfu")]),s._v("中配置项"),a("code",[s._v("isfu.Config")]),s._v("。")]),s._v(" "),a("p",[s._v("再找到从这个配置项生成的"),a("a",{attrs:{href:"https://github.com/pion/ion/blob/65dbd12eaad0f0e0a019b4d8ee80742930bcdc28/configs/sfu.toml",target:"_blank",rel:"noopener noreferrer"}},[a("code",[s._v("pion/ion")]),s._v("中关于SFU的配置文件"),a("OutboundLink")],1),s._v("：")]),s._v(" "),a("div",{staticClass:"language-toml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-toml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token table class-name"}},[s._v("global")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# data center id")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key property"}},[s._v("dc")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"dc1"')]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token table class-name"}},[s._v("nats")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key property"}},[s._v("url")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"nats://127.0.0.1:4222"')]),s._v("\n\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token table class-name"}},[s._v("sfu")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ......以下配置和上面那个配置文件差不多，省略")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("p",[s._v("可以看到这就是"),a("a",{attrs:{href:"https://github.com/pion/ion-sfu/blob/68545cc25230220435ee028d5a0af6e768a0a79a/config.toml",target:"_blank",rel:"noopener noreferrer"}},[a("code",[s._v("pion/ion-sfu")]),s._v("中配置文件"),a("OutboundLink")],1),s._v("加了几个配置项而已。其中就有nats的配置项，比如地址和数据库名称啥的。")]),s._v(" "),a("p",[s._v("具体原理的解析，且看"),a("RouterLink",{attrs:{to:"/WebRTC/sfu-in-ion.html"}},[s._v("《ION中的SFU服务》")]),s._v("。")],1),s._v(" "),a("h3",{attrs:{id:"islb"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#islb"}},[s._v("#")]),s._v(" islb")]),s._v(" "),a("p",[s._v("在官网教程中，单独启动islb的指令如下：")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("docker pull nats\ndocker run -p "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4222")]),s._v(":4222 -p "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6222")]),s._v(":6222 -p "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8222")]),s._v(":8222 nats\ndocker pull redis\ndocker run -p "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v(":6379 redis\ndocker run --network "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("host")]),s._v(" -v "),a("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("$PWD")]),s._v("/configs/islb.toml:/configs/islb.toml pionwebrtc/ion:latest-islb\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("可以看出，islb不仅需要有nats，还需要有Redis的存在才可运行。毕竟是负载均衡，肯定要存一下有哪些个节点可供负载均衡。")]),s._v(" "),a("p",[a("code",[s._v("$PWD/configs/islb.toml")]),s._v("应该就是配置文件。和上面一样，直接找到对应的"),a("a",{attrs:{href:"https://github.com/pion/ion/blob/65dbd12eaad0f0e0a019b4d8ee80742930bcdc28/configs/islb.toml",target:"_blank",rel:"noopener noreferrer"}},[s._v("配置文件"),a("OutboundLink")],1),s._v("：")]),s._v(" "),a("div",{staticClass:"language-toml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-toml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token table class-name"}},[s._v("global")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# data center id")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key property"}},[s._v("dc")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"dc1"')]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token table class-name"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key property"}},[s._v("level")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"info"')]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token table class-name"}},[s._v("nats")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key property"}},[s._v("url")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"nats://127.0.0.1:4222"')]),s._v("\n\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token table class-name"}},[s._v("redis")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key property"}},[s._v("addrs")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('":6379"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key property"}},[s._v("password")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key property"}},[s._v("db")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br")])]),a("p",[s._v("未免也过于简单了，完全就只有连数据库的配置，没有一点自己的运行逻辑方面配置？")]),s._v(" "),a("p",[s._v("从代码结构上看，在pion项目中，这个islb没有单独的包，主要的逻辑都在"),a("a",{attrs:{href:"https://github.com/pion/ion/tree/65dbd12eaad0f0e0a019b4d8ee80742930bcdc28/pkg/node/islb",target:"_blank",rel:"noopener noreferrer"}},[a("code",[s._v("github.com/pion/ion/pkg/node/islb")]),a("OutboundLink")],1),s._v("这个包里面，然后在"),a("a",{attrs:{href:"https://github.com/pion/ion/blob/65dbd12eaad0f0e0a019b4d8ee80742930bcdc28/cmd/islb/main.go",target:"_blank",rel:"noopener noreferrer"}},[s._v("cmd/islb/main.go"),a("OutboundLink")],1),s._v("里面做成可执行文件。找代码里的配置项也很好找得到：")]),s._v(" "),a("div",{staticClass:"language-go line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Config for islb node")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("type")]),s._v(" Config "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\tGlobal  global    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('`mapstructure:"global"`')]),s._v("\n\tLog     logConf   "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('`mapstructure:"log"`')]),s._v("\n\tNats    natsConf  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('`mapstructure:"nats"`')]),s._v("\n\tRedis   db"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Config "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('`mapstructure:"redis"`')]),s._v("\n\tCfgFile "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("string")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("p",[s._v("这里面确实没有islb相关的配置项。这就怪了，这islb是什么运行逻辑，怎么都没配置的？好歹还是个“负载均衡”来着。")]),s._v(" "),a("p",[s._v("这个问题比较复杂，详见"),a("RouterLink",{attrs:{to:"/WebRTC/ion-islb.html"}},[s._v("《ION中的islb服务》")]),s._v("。总的来说，islb实际上就是一个服务注册中心，并没有所谓的负载均衡功能，存储和查询流信息的功能不知道被移到哪去了。推测这个模块后面应该会改个名字，比如改成“Registry”啥的，更符合它现在的功能。")],1),s._v(" "),a("h3",{attrs:{id:"signal"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#signal"}},[s._v("#")]),s._v(" Signal")]),s._v(" "),a("p",[s._v("从"),a("RouterLink",{attrs:{to:"/WebRTC/sfu-in-ion.html"}},[s._v("《ION中的SFU服务》")]),s._v("中我们可以看出，信令服务都在SFU里面写好了，那这个Signal是干嘛用的？")],1),s._v(" "),a("p",[s._v("先看启动过程。在官网教程中，单独启动Signal的指令如下：")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("docker pull nats\ndocker run -p "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4222")]),s._v(":4222 -p "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6222")]),s._v(":6222 -p "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8222")]),s._v(":8222 nats\ndocker run -p "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5551")]),s._v(":5551/tcp --network "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("host")]),s._v(" -v "),a("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("$PWD")]),s._v("/configs/signal.toml:/configs/signal.toml pionwebrtc/ion:latest-signal\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("可以看出，Signal的启动只需要有nats就行了")]),s._v(" "),a("p",[s._v("这个配置文件是这样：")]),s._v(" "),a("div",{staticClass:"language-toml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-toml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token table class-name"}},[s._v("global")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# data center id")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key property"}},[s._v("dc")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"dc1"')]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token table class-name"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key property"}},[s._v("level")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"info"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# level = "debug"')]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token table class-name"}},[s._v("nats")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key property"}},[s._v("url")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"nats://127.0.0.1:4222"')]),s._v("\n\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token table class-name"}},[s._v("signal.grpc")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#listen ip port")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key property"}},[s._v("host")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"0.0.0.0"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key property"}},[s._v("port")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"5551"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key property"}},[s._v("allow_all_origins")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# cert= "configs/certs/cert.pem"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# key= "configs/certs/key.pem"')]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token table class-name"}},[s._v("signal.jwt")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key property"}},[s._v("enabled")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),s._v(" \n"),a("span",{pre:!0,attrs:{class:"token key property"}},[s._v("key_type")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"HMAC"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key property"}},[s._v("key")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"1q2dGu5pzikcrECJgW3ADfXX3EsmoD99SYvSVCpDsJrAqxou5tUNbHPvkEFI4bTS"')]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token table class-name"}},[s._v("signal.svc")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key property"}},[s._v("services")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"rtc"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"room"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br")])]),a("p",[s._v("前面都没啥特殊的。")]),s._v(" "),a("p",[s._v("这个"),a("code",[s._v("signal.grpc")]),s._v("应该是指明Signal服务的对外接口；"),a("code",[s._v("signal.jwt")]),s._v("应该是验证功能；"),a("code",[s._v("signal.svc")]),s._v("这是什么，看着像是什么服务名，不知道有什么用？")]),s._v(" "),a("p",[s._v("打开"),a("a",{attrs:{href:"https://github.com/pion/ion/blob/65dbd12eaad0f0e0a019b4d8ee80742930bcdc28/cmd/signal/main.go",target:"_blank",rel:"noopener noreferrer"}},[s._v("Signal的主函数"),a("OutboundLink")],1),s._v("看一眼，服务注册之类的代码都和前面介绍的一样，最重要的代码应该就是这段：")]),s._v(" "),a("div",{staticClass:"language-go line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[s._v("\tsrv "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" grpc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("NewServer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n\t\tgrpc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("CustomCodec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("nrpc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("Codec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// nolint:staticcheck")]),s._v("\n\t\tgrpc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("UnknownServiceHandler")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("nproxy"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("TransparentLongConnectionHandler")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("sig"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Director"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n\ts "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" util"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("NewWrapperedGRPCWebServer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("util"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("NewWrapperedServerOptions")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n\t\taddr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" conf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Signal"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("GRPC"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Cert"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" conf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Signal"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("GRPC"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" srv"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" err "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("Serve")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" err "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("nil")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\tlog"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("Panicf")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"failed to serve: %v"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" err"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("p",[s._v("滴滴🤯！！捕捉到关键词"),a("code",[s._v("proxy")]),s._v("！看这样子Signal应该是个GRPC代理，把外面来的标准GRPC请求转换为"),a("code",[s._v("nats-grpc")]),s._v("的请求。")]),s._v(" "),a("p",[s._v("进一步解析详见"),a("RouterLink",{attrs:{to:"/WebRTC/ion-signal.html"}},[s._v("《ION中的Signal服务》")]),s._v("。")],1)])}),[],!1,null,null,null);t.default=e.exports}}]);