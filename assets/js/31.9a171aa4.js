(window.webpackJsonp=window.webpackJsonp||[]).push([[31],{582:function(t,s,a){t.exports=a.p+"assets/img/VPxWorkerInterface.b461e48e.png"},583:function(t,s,a){t.exports=a.p+"assets/img/VPxWorker.85be580a.png"},584:function(t,s,a){t.exports=a.p+"assets/img/get_tile_buffers.e9c9cbc0.png"},966:function(t,s,a){"use strict";a.r(s);var n=a(4),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("p",[t._v("libvpx中的"),n("code",[t._v("decode_tiles")]),t._v("有三种：多线程单行解码的"),n("code",[t._v("decode_tiles_row_wise_mt")]),t._v("、多线程多行解码的"),n("code",[t._v("decode_tiles_mt")]),t._v("、单线程解码的"),n("code",[t._v("decode_tiles")]),t._v("。")]),t._v(" "),n("h2",{attrs:{id:"decode-tiles-mt"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#decode-tiles-mt"}},[t._v("#")]),t._v(" "),n("code",[t._v("decode_tiles_mt")])]),t._v(" "),n("p",[t._v("先来看多线程多行解码的"),n("code",[t._v("decode_tiles_mt")])]),t._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" uint8_t "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("decode_tiles_mt")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("VP9Decoder "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("pbi"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" uint8_t "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("data"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                                      "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" uint8_t "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("data_end"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br")])]),n("p",[t._v("函数开始。")]),t._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[t._v("  VP9_COMMON "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" cm "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("common"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" VPxWorkerInterface "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" winterface "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("vpx_get_worker_interface")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br")])]),n("p",[t._v("首先是获取到"),n("code",[t._v("VP9_COMMON")]),t._v("和一个"),n("code",[t._v("VPxWorkerInterface")]),t._v("。这个"),n("code",[t._v("VP9_COMMON")]),t._v("已经见过很多了，这个"),n("code",[t._v("VPxWorkerInterface")]),t._v("长这样：")]),t._v(" "),n("p",[n("img",{attrs:{src:a(582),alt:""}})]),t._v(" "),n("p",[t._v("从注释看就是一个"),n("code",[t._v("VPxWorker")]),t._v("的执行器，用于在线程中执行"),n("code",[t._v("VPxWorker")]),t._v("中的操作。从注释上看主要操作是"),n("code",[t._v("launch")]),t._v("和"),n("code",[t._v("execute")]),t._v("里面在调用"),n("code",[t._v("VPxWorker")]),t._v("里面的"),n("code",[t._v("hook")]),t._v("函数。这个"),n("code",[t._v("VPxWorker")]),t._v("也很简单：")]),t._v(" "),n("p",[n("img",{attrs:{src:a(583),alt:""}})]),t._v(" "),n("p",[t._v("所以这个"),n("code",[t._v("hook")]),t._v("函数应该就是多线程中每个操作所执行的地方了。后面应该会有对这一项赋值并且调用"),n("code",[t._v("VPxWorkerInterface")]),t._v("的"),n("code",[t._v("launch")]),t._v("或者"),n("code",[t._v("execute")]),t._v("的地方。")]),t._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[t._v("  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" uint8_t "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("bit_reader_end "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("NULL")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br")])]),n("p",[t._v("后面要用的的不知道什么变量。")]),t._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[t._v("  VP9LfSync "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("lf_row_sync "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("lf_row_sync"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br")])]),n("p",[t._v("点进去看看，“lf”是环路滤波的英文缩写，这个变量是多线程环路滤波相关的变量。")]),t._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[t._v("  YV12_BUFFER_CONFIG "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" new_fb "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("get_frame_new_buffer")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("cm"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" tile_cols "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("log2_tile_cols"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" tile_rows "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("log2_tile_rows"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br")])]),n("p",[t._v("这几个操作在"),n("RouterLink",{attrs:{to:"/视频编解码/libvpx-decode.html"}},[t._v("《libvpx解码过程解读》")]),t._v("里面已经见过了，不必多讲。")],1),t._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[t._v("  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" num_workers "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("VPXMIN")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("max_threads"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" tile_cols"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br")])]),n("p",[t._v("这里设置了一下worker数量。这个"),n("code",[t._v("VPXMIN")]),t._v("点进去看其实是一个比大小的宏，所以这里是取最大线程数"),n("code",[t._v("max_threads")]),t._v("和分块行的数量"),n("code",[t._v("tile_cols")]),t._v("中的最小值作为线程数？这意思应该是多线程并行只是在同一行中的每一列之间并行，而行与行之间是串行的。")]),t._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[t._v("  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("assert")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("tile_cols "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("6")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("assert")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("tile_rows "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("tile_rows"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br")])]),n("p",[t._v("一些判断。怎么有"),n("code",[t._v("assert(tile_rows == 1)")]),t._v("？这不是多行多线程吗")]),t._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[t._v("  "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("init_mt")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pbi"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br")])]),n("p",[t._v("初始化多线程。")]),t._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[t._v("  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Reset tile decoding hook")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("n "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" n "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" num_workers"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),t._v("n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    VPxWorker "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" worker "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("tile_workers"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    TileWorkerData "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" tile_data "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("tile_worker_data"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("n "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("total_tiles"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    winterface"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sync")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("worker"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("lpf_mt_opt "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("lf"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("filter_level "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("skip_loop_filter"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      tile_data"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("lf_sync "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" lf_row_sync"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      tile_data"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("lf_data "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("tile_data"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("lf_sync"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("lfdata"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("vp9_loop_filter_data_reset")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("tile_data"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("lf_data"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" new_fb"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" cm"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("mb"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("plane"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      tile_data"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("lf_data"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("y_only "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    tile_data"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("xd "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("mb"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    tile_data"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("xd"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("counts "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("\n        cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("frame_parallel_decoding_mode "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("NULL")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("tile_data"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("counts"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    worker"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("hook "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" tile_worker_hook"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    worker"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("data1 "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" tile_data"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    worker"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("data2 "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" pbi"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br"),n("span",{staticClass:"line-number"},[t._v("16")]),n("br"),n("span",{staticClass:"line-number"},[t._v("17")]),n("br"),n("span",{staticClass:"line-number"},[t._v("18")]),n("br"),n("span",{staticClass:"line-number"},[t._v("19")]),n("br"),n("span",{staticClass:"line-number"},[t._v("20")]),n("br"),n("span",{staticClass:"line-number"},[t._v("21")]),n("br")])]),n("p",[t._v("终于看见前面说的给"),n("code",[t._v("hook")]),t._v("赋值的地方了！这里是一个循环给每个"),n("code",[t._v("pbi->tile_workers")]),t._v("中的每个worker和"),n("code",[t._v("pbi->row_mt_worker_data->thread_data")]),t._v("中的每个worker要用的数据赋值。所以很明显这个"),n("code",[t._v("tile_worker_hook")]),t._v("就是多线程解码tile1的核心函数。")]),t._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[t._v("  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Load tile data into tile_buffers")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("get_tile_buffers")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pbi"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" data"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" data_end"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" tile_cols"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" tile_rows"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                   "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("tile_buffers"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br")])]),n("p",[t._v("一个"),n("code",[t._v("get_tile_buffers")]),t._v("把"),n("code",[t._v("data")]),t._v("里的tile数据加载到"),n("code",[t._v("pbi->tile_buffers")]),t._v("里：")]),t._v(" "),n("p",[n("img",{attrs:{src:a(584),alt:""}})]),t._v(" "),n("p",[t._v("笑了😂，就是一行一行一列一列的拷贝。")]),t._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[t._v("  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Sort the buffers based on size in descending order.")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("qsort")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("tile_buffers"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" tile_cols"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("sizeof")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("tile_buffers"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        compare_tile_buffers"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br")])]),n("p",[t._v("排了个序？可能是排序了多线程可以算的更快？")]),t._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[t._v("  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("num_workers "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" tile_cols"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Rearrange the tile buffers such that the largest, and")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// presumably the most difficult, tile will be decoded in the main thread.")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// This should help minimize the number of instances where the main thread")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// is waiting for a worker to complete.")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" TileBuffer largest "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("tile_buffers"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("memmove")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("tile_buffers"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("tile_buffers "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("tile_cols "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("sizeof")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("tile_buffers"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("tile_buffers"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("tile_cols "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" largest"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" start "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" end "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" tile_cols "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    TileBuffer tmp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Interleave the tiles to distribute the load between threads, assuming a")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// larger tile implies it is more difficult to decode.")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("while")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("start "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" end"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      tmp "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("tile_buffers"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("start"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("tile_buffers"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("start"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("tile_buffers"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("end"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("tile_buffers"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("end"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" tmp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      start "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      end "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br"),n("span",{staticClass:"line-number"},[t._v("16")]),n("br"),n("span",{staticClass:"line-number"},[t._v("17")]),n("br"),n("span",{staticClass:"line-number"},[t._v("18")]),n("br"),n("span",{staticClass:"line-number"},[t._v("19")]),n("br"),n("span",{staticClass:"line-number"},[t._v("20")]),n("br"),n("span",{staticClass:"line-number"},[t._v("21")]),n("br"),n("span",{staticClass:"line-number"},[t._v("22")]),n("br"),n("span",{staticClass:"line-number"},[t._v("23")]),n("br")])]),n("p",[t._v("这应该是把块的任务分给每个线程吧。上面的"),n("code",[t._v("num_workers == tile_cols")]),t._v("的情况可以一个线程一个任务，不这样就得有一个线程运行多个任务（前面的排序应该也是为了这个？大任务尽量和小任务一起交给一个线程，尽可能保证处理时间均衡，效率最高）。")]),t._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[t._v("  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Initialize thread frame counts.")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("frame_parallel_decoding_mode"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("n "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" n "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" num_workers"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),t._v("n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      TileWorkerData "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" tile_data "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("\n          "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("TileWorkerData "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("tile_workers"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("data1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("vp9_zero")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("tile_data"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("counts"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br")])]),n("p",[t._v("初始化线程帧计数？")]),t._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[t._v("  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" base "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" tile_cols "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v(" num_workers"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" remain "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" tile_cols "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("%")]),t._v(" num_workers"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" buf_start "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("n "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" n "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" num_workers"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),t._v("n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" count "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" base "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("remain "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v(" num_workers"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      VPxWorker "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" worker "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("tile_workers"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      TileWorkerData "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" tile_data "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("TileWorkerData "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("worker"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("data1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n      tile_data"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("buf_start "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" buf_start"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      tile_data"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("buf_end "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" buf_start "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" count "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      tile_data"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("data_end "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" data_end"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      buf_start "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+=")]),t._v(" count"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n      worker"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("had_error "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("n "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" num_workers "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("assert")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("tile_data"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("buf_end "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" tile_cols "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        winterface"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("execute")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("worker"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        winterface"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("launch")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("worker"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" n "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      VPxWorker "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" worker "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("tile_workers"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("n "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      TileWorkerData "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" tile_data "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("TileWorkerData "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("worker"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("data1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// TODO(jzern): The tile may have specific error data associated with")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// its vpx_internal_error_info which could be propagated to the main info")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// in cm. Additionally once the threads have been synced and an error is")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// detected, there's no point in continuing to decode tiles.")]),t._v("\n      pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("mb"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("corrupted "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("winterface"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sync")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("worker"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("bit_reader_end"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" bit_reader_end "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" tile_data"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("data_end"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br"),n("span",{staticClass:"line-number"},[t._v("16")]),n("br"),n("span",{staticClass:"line-number"},[t._v("17")]),n("br"),n("span",{staticClass:"line-number"},[t._v("18")]),n("br"),n("span",{staticClass:"line-number"},[t._v("19")]),n("br"),n("span",{staticClass:"line-number"},[t._v("20")]),n("br"),n("span",{staticClass:"line-number"},[t._v("21")]),n("br"),n("span",{staticClass:"line-number"},[t._v("22")]),n("br"),n("span",{staticClass:"line-number"},[t._v("23")]),n("br"),n("span",{staticClass:"line-number"},[t._v("24")]),n("br"),n("span",{staticClass:"line-number"},[t._v("25")]),n("br"),n("span",{staticClass:"line-number"},[t._v("26")]),n("br"),n("span",{staticClass:"line-number"},[t._v("27")]),n("br"),n("span",{staticClass:"line-number"},[t._v("28")]),n("br"),n("span",{staticClass:"line-number"},[t._v("29")]),n("br"),n("span",{staticClass:"line-number"},[t._v("30")]),n("br"),n("span",{staticClass:"line-number"},[t._v("31")]),n("br"),n("span",{staticClass:"line-number"},[t._v("32")]),n("br"),n("span",{staticClass:"line-number"},[t._v("33")]),n("br"),n("span",{staticClass:"line-number"},[t._v("34")]),n("br"),n("span",{staticClass:"line-number"},[t._v("35")]),n("br")])]),n("p",[t._v("开始执行了！其实就是for循环用"),n("code",[t._v("winterface->execute")]),t._v("异步启动每一个worker，最后一个worker用"),n("code",[t._v("winterface->launch")]),t._v("同步启动；执行完毕后再用for循环执行"),n("code",[t._v("winterface->sync")]),t._v("等待所有worker完成，并且最后还用"),n("code",[t._v("pbi->mb.corrupted")]),t._v("和"),n("code",[t._v("bit_reader_end")]),t._v("记下了返回值。")]),t._v(" "),n("p",[t._v("很好理解。")]),t._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[t._v("  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Accumulate thread frame counts.")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("frame_parallel_decoding_mode"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("n "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" n "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" num_workers"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),t._v("n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      TileWorkerData "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" tile_data "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("\n          "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("TileWorkerData "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("tile_workers"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("data1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("vp9_accumulate_frame_counts")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("counts"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("tile_data"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("counts"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br")])]),n("p",[t._v("增长线程帧计数？")]),t._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[t._v("  "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("assert")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("bit_reader_end "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("mb"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("corrupted"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" bit_reader_end"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br")])]),n("p",[t._v("最后判断一下前面记下的返回值"),n("code",[t._v("pbi->mb.corrupted")]),t._v("和"),n("code",[t._v("bit_reader_end")]),t._v("是否正常，然后退出。")]),t._v(" "),n("h2",{attrs:{id:"decode-tiles"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#decode-tiles"}},[t._v("#")]),t._v(" "),n("code",[t._v("decode_tiles")])]),t._v(" "),n("p",[t._v("再来看单线程解码的"),n("code",[t._v("decode_tiles")])]),t._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" uint8_t "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("decode_tiles")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("VP9Decoder "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("pbi"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" uint8_t "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("data"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                                   "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" uint8_t "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("data_end"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  VP9_COMMON "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" cm "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("common"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" VPxWorkerInterface "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" winterface "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("vpx_get_worker_interface")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" aligned_cols "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("mi_cols_aligned_to_sb")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("mi_cols"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" tile_cols "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("log2_tile_cols"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" tile_rows "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("log2_tile_rows"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br")])]),n("p",[t._v("初始化的方式和"),n("code",[t._v("decode_tiles_mt")]),t._v("里面差不多。但是这里多一个"),n("code",[t._v("aligned_cols")]),t._v("，从后面的代码看应该是和buffer大小有关的量。")]),t._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[t._v("  TileBuffer tile_buffers"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("6")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" tile_row"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" tile_col"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" mi_row"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" mi_col"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  TileWorkerData "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("tile_data "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("NULL")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br")])]),n("p",[n("code",[t._v("TileBuffer")]),t._v("直接在这初始化了，"),n("code",[t._v("TileWorkerData")]),t._v("也只有一个不像"),n("code",[t._v("decode_tiles_mt")]),t._v("里面每个线程都有一个"),n("code",[t._v("TileWorkerData")]),t._v("，果然是单线程，很合理。")]),t._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[t._v("  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("lf"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("filter_level "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("skip_loop_filter "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v("\n      pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("lf_worker"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("data1 "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("NULL")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("CHECK_MEM_ERROR")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("cm"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("lf_worker"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("data1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                    "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("vpx_memalign")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("32")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("sizeof")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("LFWorkerData"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("lf_worker"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("hook "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" vp9_loop_filter_worker"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("max_threads "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("winterface"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("reset")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("lf_worker"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("vpx_internal_error")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("error"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" VPX_CODEC_ERROR"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                         "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Loop filter thread creation failed"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br")])]),n("p",[t._v("从"),n("RouterLink",{attrs:{to:"/视频编解码/libvpx-decode.html"}},[t._v("《libvpx解码过程解读》")]),t._v("里已经知道，多线程"),n("code",[t._v("decode_tiles_mt")]),t._v("的情况下环路滤波的过程是在外面调用的，"),n("code",[t._v("decode_tiles_row_wise_mt")]),t._v("和单线程的"),n("code",[t._v("decode_tiles")]),t._v("里面自带环路滤波。\n这里就是给环路滤波分配数据，并且"),n("code",[t._v("pbi->lf_worker.hook = vp9_loop_filter_worker")]),t._v("给环路滤波的hook赋了值。")],1),t._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[t._v("  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("lf"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("filter_level "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("skip_loop_filter"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    LFWorkerData "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" lf_data "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("LFWorkerData "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("lf_worker"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("data1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Be sure to sync as we might be resuming after a failed frame decode.")]),t._v("\n    winterface"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sync")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("lf_worker"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("vp9_loop_filter_data_reset")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("lf_data"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("get_frame_new_buffer")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("cm"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" cm"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                               pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("mb"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("plane"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br")])]),n("p",[t._v("从注释上看应该是确保环路滤波的hook已经正确退出。")]),t._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[t._v("  "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("assert")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("tile_rows "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("assert")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("tile_cols "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("6")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br")])]),n("p",[t._v("两个判断，这里怎么是"),n("code",[t._v("assert(tile_rows <= 4)")]),t._v("，多线程"),n("code",[t._v("decode_tiles_mt")]),t._v("那里却是"),n("code",[t._v("assert(tile_rows == 1)")]),t._v("？怪")]),t._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[t._v("  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Note: this memset assumes above_context[0], [1] and [2]")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// are allocated as part of the same buffer.")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("memset")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("above_context"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n         "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("sizeof")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("above_context"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" MAX_MB_PLANE "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" aligned_cols"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("memset")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("above_seg_context"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n         "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("sizeof")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("above_seg_context"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" aligned_cols"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("vp9_reset_lfm")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("cm"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br")])]),n("p",[t._v("重置了一些内存空间。")]),t._v(" "),n("p",[t._v("这里的context应该是是指熵解码context，lfm应该是指用于环路滤波的内存空间。")]),t._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[t._v("  "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("get_tile_buffers")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pbi"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" data"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" data_end"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" tile_cols"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" tile_rows"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" tile_buffers"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br")])]),n("p",[t._v("和"),n("code",[t._v("decode_tiles_mt")]),t._v("里一样，一个"),n("code",[t._v("get_tile_buffers")]),t._v("把"),n("code",[t._v("data")]),t._v("里的tile数据加载到buffer里。只不过前面的多线程是加载到"),n("code",[t._v("pbi->tile_buffers")]),t._v("里，这里直接是加载到函数开头定义的"),n("code",[t._v("tile_buffers")]),t._v("里")]),t._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[t._v("  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Load all tile information into tile_data.")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("tile_row "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" tile_row "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" tile_rows"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),t._v("tile_row"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("tile_col "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" tile_col "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" tile_cols"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),t._v("tile_col"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" TileBuffer "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" buf "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("tile_buffers"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("tile_row"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("tile_col"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      tile_data "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("tile_worker_data "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" tile_cols "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" tile_row "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" tile_col"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      tile_data"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("xd "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("mb"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      tile_data"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("xd"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("corrupted "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      tile_data"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("xd"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("counts "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("\n          cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("frame_parallel_decoding_mode "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("NULL")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("counts"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("vp9_zero")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("tile_data"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("dqcoeff"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("vp9_tile_init")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("tile_data"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("xd"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("tile"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" cm"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" tile_row"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" tile_col"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("setup_token_decoder")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("buf"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("data"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" data_end"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" buf"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("size"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("error"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                          "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("tile_data"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("bit_reader"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("decrypt_cb"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                          pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("decrypt_state"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("vp9_init_macroblockd")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("cm"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("tile_data"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("xd"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" tile_data"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("dqcoeff"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br"),n("span",{staticClass:"line-number"},[t._v("16")]),n("br"),n("span",{staticClass:"line-number"},[t._v("17")]),n("br")])]),n("p",[t._v("这个操作对应的是"),n("code",[t._v("decode_tiles_mt")]),t._v("里的排序之后分配任务的操作。从前面"),n("code",[t._v("decode_tiles_mt")]),t._v("里可以看到，分配任务本质上就是给每个线程专用的buffer里面放上数据。这里是单线程，所以也不需要什么排序，直接无脑拷贝就行了。")]),t._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[t._v("  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("tile_row "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" tile_row "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" tile_rows"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),t._v("tile_row"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    TileInfo tile"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("vp9_tile_set_row")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("tile"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" cm"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" tile_row"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("mi_row "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" tile"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("mi_row_start"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" mi_row "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" tile"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("mi_row_end"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n         mi_row "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+=")]),t._v(" MI_BLOCK_SIZE"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("tile_col "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" tile_col "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" tile_cols"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),t._v("tile_col"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" col "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("\n            pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("inv_tile_order "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" tile_cols "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" tile_col "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" tile_col"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        tile_data "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("tile_worker_data "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" tile_cols "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" tile_row "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" col"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("vp9_tile_set_col")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("tile"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" cm"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" col"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("vp9_zero")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("tile_data"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("xd"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("left_context"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("vp9_zero")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("tile_data"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("xd"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("left_seg_context"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("mi_col "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" tile"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("mi_col_start"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" mi_col "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" tile"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("mi_col_end"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n             mi_col "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+=")]),t._v(" MI_BLOCK_SIZE"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n          "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("row_mt "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" plane"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            RowMTWorkerData "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" row_mt_worker_data "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("row_mt_worker_data"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("plane "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" plane "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" MAX_MB_PLANE"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),t._v("plane"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n              tile_data"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("xd"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("plane"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("plane"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("eob "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" row_mt_worker_data"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("eob"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("plane"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n              tile_data"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("xd"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("plane"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("plane"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dqcoeff "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("\n                  row_mt_worker_data"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("dqcoeff"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("plane"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n            tile_data"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("xd"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("partition "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" row_mt_worker_data"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("partition"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("process_partition")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("tile_data"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" pbi"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" mi_row"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" mi_col"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" BLOCK_64X64"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                              PARSE"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" parse_block"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n            "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("plane "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" plane "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" MAX_MB_PLANE"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),t._v("plane"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n              tile_data"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("xd"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("plane"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("plane"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("eob "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" row_mt_worker_data"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("eob"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("plane"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n              tile_data"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("xd"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("plane"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("plane"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dqcoeff "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("\n                  row_mt_worker_data"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("dqcoeff"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("plane"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n            tile_data"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("xd"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("partition "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" row_mt_worker_data"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("partition"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("process_partition")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("tile_data"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" pbi"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" mi_row"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" mi_col"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" BLOCK_64X64"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                              RECON"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" recon_block"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n          "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("decode_partition")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("tile_data"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" pbi"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" mi_row"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" mi_col"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" BLOCK_64X64"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n          "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("mb"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("corrupted "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|=")]),t._v(" tile_data"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("xd"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("corrupted"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("mb"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("corrupted"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n          "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("vpx_internal_error")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("error"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" VPX_CODEC_CORRUPT_FRAME"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                             "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Failed to decode tile data"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Loopfilter one row.")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("lf"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("filter_level "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("skip_loop_filter"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" lf_start "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" mi_row "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" MI_BLOCK_SIZE"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        LFWorkerData "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" lf_data "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("LFWorkerData "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("lf_worker"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("data1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n        "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// delay the loopfilter by 1 macroblock row.")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("lf_start "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("continue")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n        "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// decoding has completed: finish up the loop filter in this thread.")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("mi_row "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" MI_BLOCK_SIZE "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">=")]),t._v(" cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("mi_rows"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("continue")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n        winterface"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sync")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("lf_worker"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        lf_data"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("start "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" lf_start"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        lf_data"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("stop "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" mi_row"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("max_threads "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n          winterface"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("launch")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("lf_worker"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n          winterface"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("execute")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("lf_worker"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br"),n("span",{staticClass:"line-number"},[t._v("16")]),n("br"),n("span",{staticClass:"line-number"},[t._v("17")]),n("br"),n("span",{staticClass:"line-number"},[t._v("18")]),n("br"),n("span",{staticClass:"line-number"},[t._v("19")]),n("br"),n("span",{staticClass:"line-number"},[t._v("20")]),n("br"),n("span",{staticClass:"line-number"},[t._v("21")]),n("br"),n("span",{staticClass:"line-number"},[t._v("22")]),n("br"),n("span",{staticClass:"line-number"},[t._v("23")]),n("br"),n("span",{staticClass:"line-number"},[t._v("24")]),n("br"),n("span",{staticClass:"line-number"},[t._v("25")]),n("br"),n("span",{staticClass:"line-number"},[t._v("26")]),n("br"),n("span",{staticClass:"line-number"},[t._v("27")]),n("br"),n("span",{staticClass:"line-number"},[t._v("28")]),n("br"),n("span",{staticClass:"line-number"},[t._v("29")]),n("br"),n("span",{staticClass:"line-number"},[t._v("30")]),n("br"),n("span",{staticClass:"line-number"},[t._v("31")]),n("br"),n("span",{staticClass:"line-number"},[t._v("32")]),n("br"),n("span",{staticClass:"line-number"},[t._v("33")]),n("br"),n("span",{staticClass:"line-number"},[t._v("34")]),n("br"),n("span",{staticClass:"line-number"},[t._v("35")]),n("br"),n("span",{staticClass:"line-number"},[t._v("36")]),n("br"),n("span",{staticClass:"line-number"},[t._v("37")]),n("br"),n("span",{staticClass:"line-number"},[t._v("38")]),n("br"),n("span",{staticClass:"line-number"},[t._v("39")]),n("br"),n("span",{staticClass:"line-number"},[t._v("40")]),n("br"),n("span",{staticClass:"line-number"},[t._v("41")]),n("br"),n("span",{staticClass:"line-number"},[t._v("42")]),n("br"),n("span",{staticClass:"line-number"},[t._v("43")]),n("br"),n("span",{staticClass:"line-number"},[t._v("44")]),n("br"),n("span",{staticClass:"line-number"},[t._v("45")]),n("br"),n("span",{staticClass:"line-number"},[t._v("46")]),n("br"),n("span",{staticClass:"line-number"},[t._v("47")]),n("br"),n("span",{staticClass:"line-number"},[t._v("48")]),n("br"),n("span",{staticClass:"line-number"},[t._v("49")]),n("br"),n("span",{staticClass:"line-number"},[t._v("50")]),n("br"),n("span",{staticClass:"line-number"},[t._v("51")]),n("br"),n("span",{staticClass:"line-number"},[t._v("52")]),n("br"),n("span",{staticClass:"line-number"},[t._v("53")]),n("br"),n("span",{staticClass:"line-number"},[t._v("54")]),n("br"),n("span",{staticClass:"line-number"},[t._v("55")]),n("br"),n("span",{staticClass:"line-number"},[t._v("56")]),n("br"),n("span",{staticClass:"line-number"},[t._v("57")]),n("br"),n("span",{staticClass:"line-number"},[t._v("58")]),n("br"),n("span",{staticClass:"line-number"},[t._v("59")]),n("br"),n("span",{staticClass:"line-number"},[t._v("60")]),n("br"),n("span",{staticClass:"line-number"},[t._v("61")]),n("br"),n("span",{staticClass:"line-number"},[t._v("62")]),n("br"),n("span",{staticClass:"line-number"},[t._v("63")]),n("br"),n("span",{staticClass:"line-number"},[t._v("64")]),n("br"),n("span",{staticClass:"line-number"},[t._v("65")]),n("br")])]),n("p",[t._v("这就是主要的处理操作了。这一看就是几个for循环一行一行一列一列地在处理数据。到这里都没有"),n("code",[t._v("decode_tiles_mt")]),t._v("里看到的"),n("code",[t._v("tile_worker_hook")]),t._v("出场，说明"),n("code",[t._v("tile_worker_hook")]),t._v("肯定是被分解了放在这个循环里面了，所以这循环里面的操作应该和我们之后要研究的"),n("code",[t._v("tile_worker_hook")]),t._v("里的操作大差不离。")]),t._v(" "),n("p",[t._v("再仔细看看，除了一堆赋值的操作和最后明显是执行环路滤波的操作之外，就只有"),n("code",[t._v("pbi->row_mt == 1")]),t._v("时最后调用的"),n("code",[t._v("process_partition")]),t._v("还有else时调用的"),n("code",[t._v("decode_partition")]),t._v("了，这两个操作应该就是更底层的解码函数，"),n("code",[t._v("tile_worker_hook")]),t._v("里调用的应该也是这两个。并且从它们的执行条件看，"),n("code",[t._v("process_partition")]),t._v("是"),n("code",[t._v("pbi->row_mt == 1")]),t._v("时调用的，那"),n("code",[t._v("decode_partition")]),t._v("估计也就是通过多次调用"),n("code",[t._v("process_partition")]),t._v("实现的。")]),t._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[t._v("  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Loopfilter remaining rows in the frame.")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("lf"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("filter_level "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("skip_loop_filter"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    LFWorkerData "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" lf_data "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("LFWorkerData "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("lf_worker"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("data1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    winterface"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sync")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("lf_worker"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    lf_data"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("start "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" lf_data"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("stop"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    lf_data"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("stop "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" cm"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("mi_rows"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    winterface"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("execute")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("lf_worker"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Get last tile data.")]),t._v("\n  tile_data "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" pbi"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("tile_worker_data "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" tile_cols "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" tile_rows "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br")])]),n("p",[t._v("看来是上面的循环里面不一定能完成全部的环路滤波？")]),t._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[t._v("  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("vpx_reader_find_end")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("tile_data"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("bit_reader"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br")])]),n("p",[t._v("最后是读完终止数据后结束。")]),t._v(" "),n("p",[t._v("总结一下，多线程解码底层每个线程都是在调用"),n("code",[t._v("tile_worker_hook")]),t._v("，而从这个函数看，更底层的除了函数应该就是"),n("code",[t._v("process_partition")]),t._v("和"),n("code",[t._v("decode_partition")]),t._v("，"),n("code",[t._v("tile_worker_hook")]),t._v("应该也是调用的"),n("code",[t._v("process_partition")]),t._v("和"),n("code",[t._v("decode_partition")]),t._v("。")]),t._v(" "),n("p",[t._v("接下来继续看"),n("code",[t._v("decode_partition")]),t._v("："),n("RouterLink",{attrs:{to:"/视频编解码/libvpx-decode-partition.html"}},[t._v("《libvpx中的"),n("code",[t._v("decode_partition")]),t._v("》")]),t._v("。")],1)])}),[],!1,null,null,null);s.default=e.exports}}]);